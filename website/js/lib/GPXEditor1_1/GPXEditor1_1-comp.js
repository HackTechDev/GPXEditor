/*
 * Copyright 2009, by Shama <shama@l-wa.org> for Skitour [http://www.skitour.fr]
 * released under the BSD license.
 * See http://shamavideals.l-wa.org/GPXEditor/license.txt for the full text of 
 * the license.
 */

GPXEditor={_scriptName:'GPXEditor1_1.js',_getScriptLocation:function(){var scriptLocation='';var scriptName=GPXEditor._scriptName;var scripts=document.getElementsByTagName('script');for(var i=0;i<scripts.length;i++){var src=scripts[i].getAttribute('src');if(src){var index=src.lastIndexOf(scriptName);var pathLength=src.lastIndexOf('?');if(pathLength<0)pathLength=src.length;if((index>-1)&&(index+scriptName.length==pathLength)){scriptLocation=src.slice(0,pathLength-scriptName.length);break;}}}return scriptLocation;}};
Ext.override(Ext.Action,{addComponent:function(comp){this.items.push(comp);comp.on('destroy',this.removeComponent,this);if(this.initialConfig.toggleGroup){comp.on('toggle',function(btn,pressed){this.initialConfig.pressed=pressed;this.initialConfig.checked=pressed;},this);}},toggle:function(state){state=state===undefined?!this.initialConfig.pressed:!!state;if(state!=this.initialConfig.pressed){this.initialConfig.pressed=state;this.initialConfig.checked=state;this.callEach('toggle',[state]);}}});Ext.ButtonToggleMgr=function(){var groups={};function toggleGroup(btn,state){if(state){var g=groups[btn.toggleGroup];for(var i=0,l=g.length;i<l;i++){if(btn.baseAction&&btn.baseAction==g[i].baseAction)g[i].toggle(true);else if(g[i]!=btn)g[i].toggle(false);}}}return{register:function(btn){if(!btn.toggleGroup)return;var g=groups[btn.toggleGroup];if(!g)g=groups[btn.toggleGroup]=[];g.push(btn);btn.on("toggle",toggleGroup);},unregister:function(btn){if(!btn.toggleGroup)return;var g=groups[btn.toggleGroup];if(g){g.remove(btn);btn.un("toggle",toggleGroup);}},getPressed:function(group){var g=groups[group];if(g){for(var i=0,len=g.length;i<len;i++){if(g[i].pressed===true)return g[i];}}return null;}};}();
Ext.layout.ToolbarVLayout=Ext.extend(Ext.layout.ToolbarLayout,{onLayout:function(ct,target){target.addClass('x-toolbar-layout-vct');if(!this.topTb){target.insertHtml('beforeEnd','<table cellspacing="0" class="x-toolbar-vct"><tbody><tr><td class="x-toolbar-top" align="center" valign="top" style="vertical-align: top;"><table cellspacing="0"><tbody class="x-toolbar-top-row"></tbody></table></td></tr><tr><td class="x-toolbar-bottom" align="center" valign="bottom" style="vertical-align: bottom;"><table cellspacing="0" class="x-toolbar-bottom-ct"><tbody><tr><td><table cellspacing="0"><tbody class="x-toolbar-bottom-row"></tbody></table></td></tr><tr><td><table cellspacing="0"><tbody class="x-toolbar-extras-row"></tbody></table></td></tr></tbody></table></td></tr></tbody></table>');this.topTb=target.child('tbody.x-toolbar-top-row',true);this.bottomTb=target.child('tbody.x-toolbar-bottom-row',true);this.extrasTb=target.child('tbody.x-toolbar-extras-row',true);}var side=this.topTb;var pos=0;var items=ct.items.items;for(var i=0,len=items.length,c;i<len;i++,pos++){c=items[i];if(c.isFill){side=this.bottomTb;pos=-1;}else if(!c.rendered){c.render(this.insertCell(c,side,pos));}else{if(!c.xtbHidden&&!this.isValidParent(c,side.childNodes[pos])){var td=this.insertCell(c,side,pos);td.appendChild(c.getPositionEl().dom);c.container=Ext.get(td);}}}this.cleanup(this.topTb);this.cleanup(this.bottomTb);this.cleanup(this.extrasTb);var tc=target.child('table.x-toolbar-vct');var tDiff=target.getWidth()-target.getWidth(true);target.setWidth(tc.getWidth()+tDiff);},cleanup:function(tbody){var cn=tbody.childNodes;for(var i=0;i<tbody.childNodes.length;i++){c=cn[i];if(!c.firstChild||!c.firstChild.firstChild){tbody.removeChild(c);i--;}}},insertCell:function(c,side,pos){if(!side)return;var tr=document.createElement('tr');var td=document.createElement('td');td.className='x-toolbar-cell';tr.appendChild(td);side.insertBefore(tr,side.childNodes[pos]||null);return td;}});Ext.Container.LAYOUTS.vtoolbar=Ext.layout.ToolbarVLayout;
OpenLayers.MapWithVectorReprojection=OpenLayers.Class(OpenLayers.Map,{ignfCat:undefined,initialize:function(div,options){if(window.gGEOPORTALRIGHTSMANAGEMENT!=null)OpenLayers.Util.extend(options,gGEOPORTALRIGHTSMANAGEMENT);OpenLayers.Map.prototype.initialize.apply(this,arguments);if(window.gGEOPORTALRIGHTSMANAGEMENT!=null)this.ignfCat=new Geoportal.Catalogue(this,gGEOPORTALRIGHTSMANAGEMENT);if(!this.center)this.center=new OpenLayers.LonLat(0,0);},getIGNFCatalogue:function(){return this.ignfCat;},_updateVectorLayers:function(layers){if(!this.baseLayer||!this.baseLayer.projection)return;layers=layers?[layers]:this.layers;for(var li=0;li<layers.length;li++){var layer=layers[li];if(layer&&layer instanceof OpenLayers.Layer.Vector){var bl=this.baseLayer;var lp=layer.projection;if(!bl.projection.equals(lp)){for(var vfi=0;vfi<layer.features.length;vfi++){var g=layer.features[vfi].geometry;if(!g)continue;if(g instanceof OpenLayers.Geometry.Point)g.transform(lp,bl.projection);else if(g instanceof OpenLayers.Geometry.Collection)g.transform(lp,bl.projection);}}layer.projection=bl.projection;layer.redraw();}}},addLayer:function(layer){this._updateVectorLayers(layer);OpenLayers.Map.prototype.addLayer.apply(this,[layer]);},setBaseLayer:function(newBaseLayer){if(newBaseLayer==this.baseLayer)return;if(OpenLayers.Util.indexOf(this.layers,newBaseLayer)!=-1){var oldBaseLayer=this.baseLayer;var oldExtent=this.getExtent();var oldProjection=this.getProjection();var center=this.getCenter();var newResolution=OpenLayers.Util.getResolutionFromScale(this.getScale(),newBaseLayer.units);if(this.baseLayer!=null&&!this.allOverlays)this.baseLayer.setVisibility(false);this.baseLayer=newBaseLayer;this.viewRequestID++;if(!this.allOverlays||this.baseLayer.visibility)this.baseLayer.setVisibility(true);if(center!=null){var newZoom=this.getZoomForResolution(newResolution||this.resolution,true);if(oldProjection!=null&&!oldProjection.equals(this.getProjection())){center.transform(oldProjection,this.getProjection());this._updateVectorLayers();}this.setCenter(center,newZoom,false,true);}var ctos=this.getControlsByClass('Geoportal.Control.TermsOfService');if(ctos&&ctos.length>0){var display='none';if(this.baseLayer.GeoRM)display='block';for(var i=0;i<ctos.length;i++)ctos[i].div.style.display=display;}this.events.triggerEvent("changebaselayer",{oldLayer:oldBaseLayer,oldExtent:oldExtent,layer:this.baseLayer});}},setDisplayCenter:function(lonlat,zoom){if(lonlat&&this.displayProjection&&this.baseLayer.projection)lonlat.transform(this.displayProjection,this.baseLayer.projection);this.setCenter(lonlat,zoom);},CLASS_NAME:'OpenLayers.MapWithVectorReprojection'});
OpenLayers.Format.GPXEditorIO=OpenLayers.Class(OpenLayers.Format.GPX,{initialize:function(options){OpenLayers.Format.GPX.prototype.initialize.apply(this,[options]);},read:function(doc){if(typeof doc=="string")doc=OpenLayers.Format.XML.prototype.read.apply(this,[doc]);var features=[];if(this.extractTracks){var tracks=doc.getElementsByTagName("trk");for(var i=0,len=tracks.length;i<len;i++){var attrs={};if(this.extractAttributes){var eattrs=this.parseAttributes(tracks[i]);if('name' in eattrs)attrs.name=eattrs.name;if('desc' in eattrs)attrs.desc=eattrs.desc;else if('cmt' in eattrs)attrs.desc=eattrs.cmt;}var segs=this.getElementsByTagNameNS(tracks[i],tracks[i].namespaceURI,"trkseg");var ls=[];for(var j=0,seglen=segs.length;j<seglen;j++){var lineString=this.extractSegment(segs[j],'trkpt');if(lineString.components.length>0)ls.push(lineString);}if(ls.length>0){var track=new OpenLayers.Geometry.MultiLineString(ls);features.push(new OpenLayers.Feature.Vector(track,attrs));}}}if(this.extractRoutes){var routes=doc.getElementsByTagName("rte");for(var k=0,klen=routes.length;k<klen;k++){var attrs={};if(this.extractAttributes){var eattrs=this.parseAttributes(routes[k]);if('name' in eattrs)attrs.name=eattrs.name;if('desc' in eattrs)attrs.desc=eattrs.desc;else if('cmt' in eattrs)attrs.desc=eattrs.cmt;}var route=this.extractSegment(routes[k],"rtept");if(route.components.length>0)features.push(new OpenLayers.Feature.Vector(route,attrs));}}if(this.extractWaypoints){var waypoints=doc.getElementsByTagName("wpt");for(var l=0,len=waypoints.length;l<len;l++){var attrs={};if(this.extractAttributes){var eattrs=this.parseAttributes(waypoints[l]);if('name' in eattrs)attrs.name=eattrs.name;if('desc' in eattrs)attrs.desc=eattrs.desc;else if('cmt' in eattrs)attrs.desc=eattrs.cmt;if('ele' in eattrs)attrs.ele=eattrs.ele;if('sym' in eattrs){switch(eattrs.sym){case GPXEditor1_1.data.WPTRecord.WPT_TYPES.PK:attrs.type=GPXEditor1_1.data.WPTRecord.WPT_TYPES.PK;break;case GPXEditor1_1.data.WPTRecord.WPT_TYPES.PASS:attrs.type=GPXEditor1_1.data.WPTRecord.WPT_TYPES.PASS;break;case GPXEditor1_1.data.WPTRecord.WPT_TYPES.RHSE:attrs.type=GPXEditor1_1.data.WPTRecord.WPT_TYPES.RHSE;break;case GPXEditor1_1.data.WPTRecord.WPT_TYPES.WTRW:attrs.type=GPXEditor1_1.data.WPTRecord.WPT_TYPES.WTRW;break;case GPXEditor1_1.data.WPTRecord.WPT_TYPES.PKLT:attrs.type=GPXEditor1_1.data.WPTRecord.WPT_TYPES.PKLT;break;default:attrs.type=GPXEditor1_1.data.WPTRecord.WPT_TYPES.UNKNOW;break;}}}var wpt=new OpenLayers.Geometry.Point(waypoints[l].getAttribute("lon"),waypoints[l].getAttribute("lat"));features.push(new OpenLayers.Feature.Vector(wpt,attrs));}}if(this.internalProjection&&this.externalProjection){for(var g=0,featLength=features.length;g<featLength;g++)features[g].geometry.transform(this.externalProjection,this.internalProjection);}return features;},extractSegment:function(segment,segmentType){var points=this.getElementsByTagNameNS(segment,segment.namespaceURI,segmentType);var point_feature=[];for(var i=0,len=points.length;i<len;i++){var pt=new OpenLayers.Geometry.Point(points[i].getAttribute('lon'),points[i].getAttribute('lat'));var attributes=this.parseAttributes(points[i]);if(attributes.ele)pt.ele=Math.round(attributes.ele);if(attributes.time)pt.time=Date.parseDate(attributes.time,'c');point_feature.push(pt);}return new OpenLayers.Geometry.LineString(point_feature);},write:function(features){if(!(features instanceof Array))features=[features];var gpx=this.genNode('gpx',{version:'1.1',creator:'http://shamavideals.l-wa.org/GPXEditor1.1'});this.setAttributeNS(gpx,OpenLayers.Format.GPXEditorIO.XSINS,'xsi:schemaLocation',OpenLayers.Format.GPXEditorIO.GPXNS+' '+OpenLayers.Format.GPXEditorIO.GPXSL);var wptNodes=[];var rteNodes=[];var trkNodes=[];for(var i=0,len=features.length;i<len;i++){if(features[i].geometry instanceof OpenLayers.Geometry.Point)wptNodes.push(this.genWpt(features[i]));else if(features[i].geometry instanceof OpenLayers.Geometry.LineString)rteNodes.push(this.genRte(features[i]));else if(features[i].geometry instanceof OpenLayers.Geometry.MultiLineString)trkNodes.push(this.genTrk(features[i]));}if(this.extractWaypoints){for(var i=0,len=wptNodes.length;i<len;i++)gpx.appendChild(wptNodes[i]);}if(this.extractRoutes){for(var i=0,len=rteNodes.length;i<len;i++)gpx.appendChild(rteNodes[i]);}if(this.extractTracks){for(var i=0,len=trkNodes.length;i<len;i++)gpx.appendChild(trkNodes[i]);}return OpenLayers.Format.XML.prototype.write.apply(this,[gpx]);},genWpt:function(feature){var wptNode=this.genPtNode('wpt',feature.geometry,{name:feature.attributes.name,desc:feature.attributes.desc,ele:feature.attributes.ele,type:feature.attributes.type});return wptNode;},genRte:function(feature){var rteNode=this.genNode('rte');if(feature.attributes){if(feature.attributes.name!=null&&feature.attributes.name.length>0)rteNode.appendChild(this.genNode('name',null,feature.attributes.name));if(feature.attributes.desc!=null&&feature.attributes.desc.length>0)rteNode.appendChild(this.genNode('desc',null,feature.attributes.desc));}var points=feature.geometry.getVertices();for(var i=0,len=points.length;i<len;i++){var rteptNode=this.genPtNode('rtept',points[i],{ele:points[i].ele});rteNode.appendChild(rteptNode);}return rteNode;},genTrk:function(feature){var trkNode=this.genNode('trk');if(feature.attributes){if(feature.attributes.name!=null&&feature.attributes.name.length>0)trkNode.appendChild(this.genNode('name',null,feature.attributes.name));if(feature.attributes.desc!=null&&feature.attributes.desc.length>0)trkNode.appendChild(this.genNode('desc',null,feature.attributes.desc));}var segs=feature.geometry.components;for(var i=0,slen=segs.length;i<slen;i++){var trksegNode=this.genNode('trkseg');var points=segs[i].getVertices();for(var j=0,plen=points.length;j<plen;j++){var trkptNode=this.genPtNode('trkpt',points[j],{ele:points[j].ele,time:points[j].time});trksegNode.appendChild(trkptNode);}trkNode.appendChild(trksegNode);}return trkNode;},genNode:function(eName,attributes,value){var node=this.createElementNS(OpenLayers.Format.GPXEditorIO.GPXNS,eName);if(attributes){for(var a in attributes){if(attributes[a]!=null)node.setAttribute(a,attributes[a]);}}if(value!=null)node.appendChild(this.createTextNode(value));return node;},genPtNode:function(eName,point,elements){var ll=new OpenLayers.LonLat(point.x,point.y);ll.transform(this.internalProjection,this.externalProjection);var ptNode=this.genNode(eName,{lon:Ext.util.Format.round(ll.lon,GPXEditor1_1.data.WPTRecord.LL_MAX_DIGITS),lat:Ext.util.Format.round(ll.lat,GPXEditor1_1.data.WPTRecord.LL_MAX_DIGITS)});if(elements){if('ele' in elements&&elements.ele!=null)ptNode.appendChild(this.genNode('ele',null,Math.round(elements.ele)));if('time' in elements&&elements.time!=null)ptNode.appendChild(this.genNode('time',null,elements.time.format('c')));if('name' in elements&&elements.name!=null&&elements.name.length>0)ptNode.appendChild(this.genNode('name',null,elements.name));if('desc' in elements&&elements.desc!=null&&elements.desc.length>0)ptNode.appendChild(this.genNode('desc',null,elements.desc));if('type' in elements&&elements.type!=null&&elements.type!=GPXEditor1_1.data.WPTRecord.WPT_TYPES.UNKNOW){ptNode.appendChild(this.genNode('sym',null,elements.type));ptNode.appendChild(this.genNode('type',null,GPXEditor1_1.data.WPTRecord.LOCALES['WPT_TYPE_'+elements.type]));}}return ptNode;},parseAttributes:function(node){var attributes={};if(!node)return attributes;var attrNode=node.firstChild;while(attrNode){if(attrNode.nodeType==1){var value=attrNode.firstChild;if(value&&(value.nodeType==3||value.nodeType==4)){name=(attrNode.prefix)?attrNode.nodeName.split(":")[1]:attrNode.nodeName;if(name!="trkseg"&&name!="rtept")attributes[name]=value.nodeValue;}}attrNode=attrNode.nextSibling;}return attributes;},CLASS_NAME:'OpenLayers.Format.GPXEditorIO'});OpenLayers.Format.GPXEditorIO.XSINS='http://www.w3.org/2001/XMLSchema-instance';OpenLayers.Format.GPXEditorIO.GPXNS='http://www.topografix.com/GPX/1/1';OpenLayers.Format.GPXEditorIO.GPXSL='http://www.topografix.com/GPX/1/1/gpx.xsd';OpenLayers.Format.GPXEditorIO.GPXENS='http://shamavideals.l-wa.org/GPXEditor1.1';OpenLayers.Format.GPXEditorIO.GPXESL='http://shamavideals.l-wa.org/GPXEditor1.1/gpxeditor1_1.xsd';
OpenLayers.Handler.Path.prototype.createFeature=function(pixel){var lonlat=this.control.map.getLonLatFromPixel(pixel);if(this.control.selectedFeature){var feature=this.control.selectedFeature;if(feature.layer)feature.layer.events.triggerEvent('sketchmodified',{feature:feature});var lineString=null;if(feature.geometry){if(feature.geometry instanceof OpenLayers.Geometry.MultiLineString){var cmps=feature.geometry.components;lineString=cmps[cmps.length-1];}else if(feature.geometry instanceof OpenLayers.Geometry.LineString)lineString=feature.geometry;if(lineString){var cmps=lineString.components;if(cmps.length>0){var lastPoint=cmps[cmps.length-1];lonlat=new OpenLayers.LonLat(lastPoint.x,lastPoint.y);}}this.editedFeature=feature;}}else
this.editedFeature=null;this.point=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Point(lonlat.lon,lonlat.lat));this.line=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.LineString([this.point.geometry]));this.callback("create",[this.point.geometry,this.getSketch()]);this.point.geometry.clearBounds();this.layer.addFeatures([this.line,this.point],{silent:true});};
OpenLayers.Control.SelectFeature.prototype.initialize=function(layers,options){this.EVENT_TYPES=OpenLayers.Control.SelectFeature.prototype.EVENT_TYPES.concat(OpenLayers.Control.prototype.EVENT_TYPES);OpenLayers.Control.prototype.initialize.apply(this,[options]);if(this.scope===null)this.scope=this;this.initLayer(layers);var callbacks={click:this.clickFeature,clickout:this.clickoutFeature};if(this.hover||this.highlightOnly){callbacks.over=this.overFeature;callbacks.out=this.outFeature;}this.callbacks=OpenLayers.Util.extend(callbacks,this.callbacks);this.handlers={feature:new OpenLayers.Handler.Feature(this,this.layer,this.callbacks,{geometryTypes:this.geometryTypes})};if(this.box){this.handlers.box=new OpenLayers.Handler.Box(this,{done:this.selectBox},{boxDivClassName:"olHandlerBoxSelectFeature"});}if(this.selectStyle)this.renderIntent=this.selectStyle;};OpenLayers.Control.SelectFeature.prototype.clickFeature=function(feature){if(!this.hover||this.highlightOnly){var selected=(OpenLayers.Util.indexOf(feature.layer.selectedFeatures,feature)>-1);if(selected){if(this.toggleSelect()){this.unselect(feature);}else if(!this.multipleSelect()){this.unselectAll({except:feature});}}else{if(!this.multipleSelect()){this.unselectAll({except:feature});}this.select(feature);}}};OpenLayers.Control.SelectFeature.prototype.overFeature=function(feature){var layer=feature.layer;if(this.hover){if(this.highlightOnly){this.highlight(feature);}else if(OpenLayers.Util.indexOf(layer.selectedFeatures,feature)==-1){this.select(feature);}}else if(this.highlightOnly){this.highlight(feature);}};OpenLayers.Control.SelectFeature.prototype.outFeature=function(feature){var layer=feature.layer;if(this.hover){if(this.highlightOnly){if(feature._lastHighlighter==this.id){if(feature._prevHighlighter&&feature._prevHighlighter!=this.id){delete feature._lastHighlighter;var control=this.map.getControl(feature._prevHighlighter);if(control)control.highlight(feature);}else
this.unhighlight(feature);}}else
this.unselect(feature);}else if(this.highlightOnly){if(OpenLayers.Util.indexOf(layer.selectedFeatures,feature)==-1)this.unhighlight(feature);}};
OpenLayers.Control.GPXNavigation=OpenLayers.Class(OpenLayers.Control,{layer:undefined,navigationControl:undefined,selectControl:undefined,initialize:function(layer,options){this.layer=layer;OpenLayers.Control.prototype.initialize.apply(this,[options]);var selectOptions={selectStyle:options.selectStyle,geometryTypes:this.geometryTypes,highlightOnly:true,onSelect:this.selectFeature,scope:this};this.selectControl=new OpenLayers.Control.SelectFeature(layer,selectOptions);this.selectControl.events.register('featurehighlighted',this,this.highlightFeature);this.selectControl.events.register('featureunhighlighted',this,this.unhighlightFeature);this.navigationControl=new OpenLayers.Control.Navigation();},destroy:function(){this.layer=null;this.navigationControl.destroy();this.selectControl.destroy();OpenLayers.Control.prototype.destroy.apply(this,[]);},activate:function(){return(this.selectControl.activate()&&this.navigationControl.activate()&&OpenLayers.Control.prototype.activate.apply(this,arguments));},deactivate:function(){var deactivated=false;if(OpenLayers.Control.prototype.deactivate.apply(this,arguments)){this.layer.unselectAllFeatures();this.selectControl.deactivate();this.navigationControl.deactivate();deactivated=true;}return deactivated;},selectFeature:function(evt){},highlightFeature:function(evt){var feature=evt.feature;},unhighlightFeature:function(evt){},setMap:function(map){this.selectControl.setMap(map);this.navigationControl.setMap(map);this.navigationControl.draw();OpenLayers.Control.prototype.setMap.apply(this,arguments);},CLASS_NAME:'OpenLayers.Control.GPXNavigation'});
OpenLayers.Control.DeleteFeature=OpenLayers.Class(OpenLayers.Control,{geometryTypes:null,layer:null,selectControl:null,initialize:function(layer,options){this.layer=layer;OpenLayers.Control.prototype.initialize.apply(this,[options]);var selectOptions={selectStyle:options.selectStyle,geometryTypes:this.geometryTypes,highlightOnly:true,onSelect:this.selectFeature,scope:this};this.selectControl=new OpenLayers.Control.SelectFeature(layer,selectOptions);},destroy:function(){this.layer=null;this.selectControl.destroy();OpenLayers.Control.prototype.destroy.apply(this,[]);},activate:function(){return(this.selectControl.activate()&&OpenLayers.Control.prototype.activate.apply(this,arguments));},deactivate:function(){var deactivated=false;if(OpenLayers.Control.prototype.deactivate.apply(this,arguments)){var feature=this.feature;var valid=feature&&feature.geometry&&feature.layer;if(valid)this.selectControl.unselect.apply(this.selectControl,[feature]);this.selectControl.deactivate();deactivated=true;}return deactivated;},selectFeature:function(feature){this.layer.removeFeatures([feature]);this.layer.events.triggerEvent('featureremoved',{feature:feature});},setMap:function(map){this.selectControl.setMap(map);OpenLayers.Control.prototype.setMap.apply(this,arguments);},CLASS_NAME:'OpenLayers.Control.DeleteFeature'});
OpenLayers.Control.PasteAndInverseFeature=OpenLayers.Class(OpenLayers.Control,{geometryTypes:null,layer:null,highlightedFeature:null,highlightedPoint:null,selectedFeature:null,selectedPoint:null,selectControl:null,handlers:null,inverseCodes:[73],highlightedPointStyle:{fillColor:'#00ff00',pointRadius:6,fillOpacity:.7},initialize:function(layer,options){this.layer=layer;OpenLayers.Control.prototype.initialize.apply(this,[options]);var selectOptions={selectStyle:options.selectStyle,geometryTypes:this.geometryTypes,highlightOnly:true,clickout:true,multiple:true,onSelect:this.selectFeature,onUnselect:this.unselectFeature,scope:this};this.selectControl=new OpenLayers.Control.SelectFeature(layer,selectOptions);this.selectControl.events.register('featurehighlighted',this,this.highlightFeature);this.selectControl.events.register('featureunhighlighted',this,this.unhighlightFeature);this.handlers={keyboard:new OpenLayers.Handler.Keyboard(this,{keydown:this.handleKeypress})};},destroy:function(){this.layer=null;this.cleanLayer();this.selectControl.events.unregister('featurehighlighted',this,this.highlightFeature);this.selectControl.events.unregister('featureunhighlighted',this,this.unhighlightFeature);this.selectControl.destroy();OpenLayers.Control.prototype.destroy.apply(this,[]);},activate:function(){return(this.selectControl.activate()&&this.handlers.keyboard.activate()&&OpenLayers.Control.prototype.activate.apply(this,arguments));},deactivate:function(){var deactivated=false;if(OpenLayers.Control.prototype.deactivate.apply(this,arguments)){this.cleanLayer();this.selectControl.deactivate();this.handlers.keyboard.deactivate();deactivated=true;}return deactivated;},handleKeypress:function(evt){var code=evt.keyCode;if(this.highlightedFeature!=null&&OpenLayers.Util.indexOf(this.inverseCodes,code)!=-1){var feature=this.highlightedFeature;this.layer.events.triggerEvent('beforefeaturemodified',{feature:feature});feature.geometry.components.reverse();if(feature.geometry instanceof OpenLayers.Geometry.MultiLineString)for(var i=0;i<feature.geometry.components.length;i++)feature.geometry.components[i].components.reverse();this.layer.events.triggerEvent('sketchmodified',{feature:feature});this.layer.events.triggerEvent('featuremodified',{feature:feature,modified:true});this.layer.events.triggerEvent('afterfeaturemodified',{feature:feature});this.cleanLayer(true);this.highlightFeature({feature:feature});}},highlightFeature:function(evt){if(this.highlightedFeature)return;var feature=evt.feature;if(feature==this.selectedFeature)return;this.highlightedFeature=feature;var geometry=null;var pt=null;if(!feature||this.startFeature)return;geometry=feature.geometry;if(!geometry)return;if(geometry instanceof OpenLayers.Geometry.MultiLineString)pt=geometry.components[0].components[0];else if(geometry instanceof OpenLayers.Geometry.LineString)pt=geometry.components[0];if(!pt)return;var startPt=pt.clone();this.highlightedPoint=new OpenLayers.Feature.Vector(startPt);this.highlightedPoint.style=this.highlightedPointStyle;this.layer.addFeatures(this.highlightedPoint,{silent:true});},unhighlightFeature:function(evt){this.cleanLayer(true);},selectFeature:function(feature){if(!feature)return;if(!this.selectedFeature){this.cleanLayer(true);this.selectedFeature=feature;var geometry=feature.geometry;var pt=null;if(geometry instanceof OpenLayers.Geometry.MultiLineString)pt=geometry.components[0].components[0];else if(geometry instanceof OpenLayers.Geometry.LineString)pt=geometry.components[0];var startPt=pt.clone();this.selectedPoint=new OpenLayers.Feature.Vector(startPt);this.selectedPoint.style=this.highlightedPointStyle;this.layer.addFeatures(this.selectedPoint,{silent:true});}else if(this.selectedFeature!=feature){this.layer.removeFeatures(feature);this.layer.events.triggerEvent('beforefeaturemodified',{feature:this.selectedFeature});this.layer.events.triggerEvent('sketchmodified',{feature:this.selectedFeature});var geometry=feature.geometry;var sGeometry=this.selectedFeature.geometry;if(geometry instanceof OpenLayers.Geometry.MultiLineString){var ls=sGeometry.components[sGeometry.components.length-1];for(var i=0;i<geometry.components.length;i++){var tls=geometry.components[i];ls.addComponents(tls.components);}}else if(geometry instanceof OpenLayers.Geometry.LineString){var ls=sGeometry;ls.addComponents(geometry.components);}this.layer.events.triggerEvent('featuremodified',{feature:this.selectedFeature,modified:true});this.layer.events.triggerEvent('afterfeaturemodified',{feature:this.selectedFeature});feature.destroy();this.layer.drawFeature(this.selectedFeature);this.cleanLayer();}},unselectFeature:function(feature){this.cleanLayer();},cleanLayer:function(dontUnselect){if(this.highlightedPoint){this.layer.removeFeatures(this.highlightedPoint,{silent:true});this.highlightedPoint.destroy();this.highlightedPoint=null;}if(this.highlightedFeature)this.highlightedFeature=null;if(!dontUnselect){this.selectControl.unselectAll();this.selectedFeature=null;if(this.selectedPoint){this.layer.removeFeatures(this.selectedPoint,{silent:true});this.selectedPoint.destroy();this.selectedPoint=null;}}},setMap:function(map){this.selectControl.setMap(map);OpenLayers.Control.prototype.setMap.apply(this,arguments);},CLASS_NAME:'OpenLayers.Control.PasteAndInverseFeature'});
OpenLayers.Control.ConvertFeature=OpenLayers.Class(OpenLayers.Control,{geometryTypes:null,layer:null,selectControl:null,initialize:function(layer,options){this.layer=layer;OpenLayers.Control.prototype.initialize.apply(this,[options]);var selectOptions={selectStyle:options.selectStyle,geometryTypes:this.geometryTypes,highlightOnly:true,onSelect:this.selectFeature,scope:this};this.selectControl=new OpenLayers.Control.SelectFeature(layer,selectOptions);},destroy:function(){this.layer=null;this.selectControl.destroy();OpenLayers.Control.prototype.destroy.apply(this,[]);},activate:function(){return(this.selectControl.activate()&&OpenLayers.Control.prototype.activate.apply(this,arguments));},deactivate:function(){var deactivated=false;if(OpenLayers.Control.prototype.deactivate.apply(this,arguments)){var feature=this.feature;var valid=feature&&feature.geometry&&feature.layer;if(valid)this.selectControl.unselect.apply(this.selectControl,[feature]);this.selectControl.deactivate();deactivated=true;}return deactivated;},selectFeature:function(feature){var geometry=feature.geometry;if(geometry instanceof OpenLayers.Geometry.MultiLineString){var pts=[];for(var i=0;i<geometry.components.length;i++){var ls=geometry.components[i];for(var j=0;j<ls.components.length;j++){delete ls.components[j].time;pts.push(ls.components[j]);}}this.layer.removeFeatures([feature]);feature.geometry=new OpenLayers.Geometry.LineString(pts);this.layer.addFeatures([feature]);}else if(geometry instanceof OpenLayers.Geometry.LineString){this.layer.removeFeatures([feature]);feature.geometry=new OpenLayers.Geometry.MultiLineString([geometry]);this.layer.addFeatures([feature]);}},setMap:function(map){this.selectControl.setMap(map);OpenLayers.Control.prototype.setMap.apply(this,arguments);},CLASS_NAME:'OpenLayers.Control.ConvertFeature'});
OpenLayers.Control.ModifyFeature.prototype.initialize=function(layer,options){this.layer=layer;this.vertices=[];this.virtualVertices=[];this.virtualStyle=OpenLayers.Util.extend({},this.layer.style||this.layer.styleMap.createSymbolizer());this.virtualStyle.fillOpacity=0.3;this.virtualStyle.strokeOpacity=0.3;this.deleteCodes=[46,68];this.cutCodes=[67];this.elevationCodes=[69];this.mode=OpenLayers.Control.ModifyFeature.RESHAPE;OpenLayers.Control.prototype.initialize.apply(this,[options]);if(!(this.deleteCodes instanceof Array))this.deleteCodes=[this.deleteCodes];var control=this;var selectOptions={selectStyle:options.selectStyle,geometryTypes:this.geometryTypes,hover:this.hover,highlightOnly:this.highlightOnly,clickout:this.clickout,toggle:this.toggle,onBeforeSelect:this.beforeSelectFeature,onSelect:this.selectFeature,onUnselect:this.unselectFeature,scope:this};if(this.standalone===false)this.selectControl=new OpenLayers.Control.SelectFeature(layer,selectOptions);var dragOptions={geometryTypes:["OpenLayers.Geometry.Point"],snappingOptions:this.snappingOptions,onStart:function(feature,pixel){control.dragStart.apply(control,[feature,pixel]);},onDrag:function(feature,pixel){control.dragVertex.apply(control,[feature,pixel]);},onComplete:function(feature){control.dragComplete.apply(control,[feature]);},featureCallbacks:{over:function(feature){if(control.standalone!==true||feature._sketch||control.feature===feature)control.dragControl.overFeature.apply(control.dragControl,[feature]);}}};this.dragControl=new OpenLayers.Control.DragFeature(layer,dragOptions);var keyboardOptions={keydown:this.handleKeypress};this.handlers={keyboard:new OpenLayers.Handler.Keyboard(this,keyboardOptions)};};OpenLayers.Control.ModifyFeature.prototype.handleKeypress=function(evt){var code=evt.keyCode;if(this.feature&&(OpenLayers.Util.indexOf(this.deleteCodes,code)!=-1||OpenLayers.Util.indexOf(this.cutCodes,code)!=-1)||OpenLayers.Util.indexOf(this.elevationCodes,code)!=-1){var vertex=this.dragControl.feature;if(vertex&&OpenLayers.Util.indexOf(this.vertices,vertex)!=-1&&!this.dragControl.handlers.drag.dragging&&vertex.geometry.parent){if(OpenLayers.Util.indexOf(this.deleteCodes,code)!=-1){vertex.geometry.parent.removeComponent(vertex.geometry);this.layer.drawFeature(this.feature,this.standalone?undefined:this.selectControl.renderIntent);this.resetVertices();this.setFeatureState();this.onModification(this.feature);this.layer.events.triggerEvent('sketchmodified',{feature:this.feature,vertex:vertex});this.layer.events.triggerEvent("featuremodified",{feature:this.feature});}else if(OpenLayers.Util.indexOf(this.elevationCodes,code)!=-1){var pt=vertex.geometry;var line=pt.parent;var lineNodes=line.getVertices();var idx=OpenLayers.Util.indexOf(lineNodes,pt);if(idx!=-1){this.layer.events.triggerEvent('elevationneeded',{feature:this.feature,index:idx,point:pt});}}else if(OpenLayers.Util.indexOf(this.cutCodes,code)!=-1){var pt=vertex.geometry;var line=pt.parent;var lineNodes=line.getVertices();var ptIndex=OpenLayers.Util.indexOf(lineNodes,pt);if(ptIndex>0&&ptIndex<(lineNodes.length+1)){var newLineNodes=[pt.clone()];for(var i=ptIndex+1;i<lineNodes.length;i++){newLineNodes.push(lineNodes[i]);}for(var i=1;i<newLineNodes.length;i++){line.removeComponent(newLineNodes[i]);}var newGeometry=null;var newLine=new OpenLayers.Geometry.LineString(newLineNodes);if(line.parent!=null){var multiLine=line.parent;var lineIndex=OpenLayers.Util.indexOf(multiLine.components,line);var newLines=[newLine];for(var i=lineIndex+1;i<multiLine.components.length;i++)newLines.push(multiLine.components[i]);for(var i=1;i<newLines.length;i++){multiLine.removeComponent(newLines[i]);}newGeometry=new OpenLayers.Geometry.MultiLineString(newLines);}else
newGeometry=newLine;this.layer.addFeatures([new OpenLayers.Feature.Vector(newGeometry)]);this.layer.drawFeature(this.feature,this.standalone?undefined:this.selectControl.renderIntent);this.resetVertices();this.setFeatureState();this.onModification(this.feature);this.layer.events.triggerEvent('sketchmodified',{feature:this.feature,vertex:vertex});this.layer.events.triggerEvent("featuremodified",{feature:this.feature});}}}}};OpenLayers.Control.ModifyFeature.prototype.dragVertex=function(vertex,pixel){this.modified=true;if(this.feature.geometry.CLASS_NAME=="OpenLayers.Geometry.Point"){if(this.feature!=vertex)this.feature=vertex;this.layer.events.triggerEvent("vertexmodified",{vertex:vertex.geometry,feature:this.feature,pixel:pixel});}else{if(vertex._index){vertex.geometry.parent.addComponent(vertex.geometry,vertex._index);delete vertex._index;OpenLayers.Util.removeItem(this.virtualVertices,vertex);this.vertices.push(vertex);}else if(vertex==this.dragHandle){this.layer.removeFeatures(this.vertices,{silent:true});this.vertices=[];if(this.radiusHandle){this.layer.destroyFeatures([this.radiusHandle],{silent:true});this.radiusHandle=null;}}else if(vertex!==this.radiusHandle){delete vertex.geometry.ele;delete vertex.geometry.time;this.layer.events.triggerEvent("vertexmodified",{vertex:vertex.geometry,feature:this.feature,pixel:pixel});}if(this.virtualVertices.length>0){this.layer.destroyFeatures(this.virtualVertices,{silent:true});this.virtualVertices=[];}this.layer.drawFeature(this.feature,this.standalone?undefined:this.selectControl.renderIntent);}this.layer.drawFeature(vertex);};
OpenLayers.Control.DrawFeature.prototype.initialize=function(layer,handler,options){this.EVENT_TYPES=OpenLayers.Control.DrawFeature.prototype.EVENT_TYPES.concat(OpenLayers.Control.prototype.EVENT_TYPES);OpenLayers.Control.prototype.initialize.apply(this,[options]);this.callbacks=OpenLayers.Util.extend({done:this.drawFeature,modify:function(vertex,feature){this.layer.events.triggerEvent("sketchmodified",{vertex:vertex,feature:feature});},create:function(vertex,feature){this.layer.events.triggerEvent("sketchstarted",{vertex:vertex,feature:feature});}},this.callbacks);this.layer=layer;this.handlerOptions=this.handlerOptions||{};if(!("multi" in this.handlerOptions))this.handlerOptions.multi=this.multi;var sketchStyle=this.layer.styleMap&&this.layer.styleMap.styles.temporary;if(sketchStyle){this.handlerOptions.layerOptions=OpenLayers.Util.applyDefaults(this.handlerOptions.layerOptions,{styleMap:new OpenLayers.StyleMap({'default':sketchStyle})});}this.handler=new handler(this,this.callbacks,this.handlerOptions);if(this.handler instanceof OpenLayers.Handler.Path){this.geometryTypes=(options&&options.multi)?'OpenLayers.Geometry.MultiLineString':'OpenLayers.Geometry.LineString';this.selectControl=new OpenLayers.Control.SelectFeature(layer,{selectStyle:options.selectStyle,hover:true,geometryTypes:this.geometryTypes,onSelect:this.selectFeature,onUnselect:this.unselectFeature,scope:this});}};OpenLayers.Control.DrawFeature.prototype.destroy=function(){if(this.selectControl!=null){this.selectControl.unselectAll();this.selectControl.destroy();}OpenLayers.Control.prototype.destroy.apply(this,arguments);};OpenLayers.Control.DrawFeature.prototype.activate=function(){if(this.selectControl!=null)return(this.selectControl.activate()&&OpenLayers.Control.prototype.activate.apply(this,arguments));else
return OpenLayers.Control.prototype.activate.apply(this,arguments);};OpenLayers.Control.DrawFeature.prototype.deactivate=function(){var deactivated=false;if(OpenLayers.Control.prototype.deactivate.apply(this,arguments)){if(this.selectControl!=null){this.selectFeature=null;this.selectControl.unselectAll();this.selectControl.deactivate();}deactivated=true;}return deactivated;};OpenLayers.Control.DrawFeature.prototype.setMap=function(map){if(this.selectControl)this.selectControl.setMap(map);OpenLayers.Control.prototype.setMap.apply(this,arguments);};OpenLayers.Control.DrawFeature.prototype.selectFeature=function(feature){this.selectedFeature=feature;};OpenLayers.Control.DrawFeature.prototype.unselectFeature=function(feature){this.selectedFeature=null;};OpenLayers.Control.DrawFeature.prototype.drawFeature=function(geometry){if(this.handler.editedFeature){var feature=this.handler.editedFeature;var lineString=null;if(geometry instanceof OpenLayers.Geometry.MultiLineString){geometry=geometry.components[0];var cmps=feature.geometry.components;lineString=cmps[cmps.length-1];}else if(geometry instanceof OpenLayers.Geometry.LineString)lineString=feature.geometry;for(var i=1;i<geometry.components.length;i++)lineString.addPoint(geometry.components[i]);this.layer.events.triggerEvent('featuremodified',{feature:feature,modified:true});this.layer.events.triggerEvent('afterfeaturemodified',{feature:feature});this.layer.drawFeature(feature);}else{var feature=new OpenLayers.Feature.Vector(geometry);var proceed=this.layer.events.triggerEvent("sketchcomplete",{feature:feature});if(proceed!==false){feature.state=OpenLayers.State.INSERT;this.layer.addFeatures([feature]);this.featureAdded(feature);this.events.triggerEvent("featureadded",{feature:feature});}}};
OpenLayers.Elevation=OpenLayers.Class(OpenLayers.Control,{initialize:function(ll,func,scope){this.ll=ll;if(func&&scope)this.callback=OpenLayers.Function.bind(func,scope);this.doSRTM3Request();},abort:function(abortCurent){this.request=null;if(!abortCurent)this.aborted=true;},doSRTM3Request:function(){if(this.aborted)return;if(this.ll.lat>60||this.ll.lat<-56){this.doASTERGDEMRequest();return;}this._doRequest('http://ws.geonames.org/srtm3','checkSRTM3Result');},checkSRTM3Result:function(ele){if(this.aborted)return;if(ele==-32768){this.doASTERGDEMRequest();return;}this.callback(ele);},doASTERGDEMRequest:function(){if(this.aborted)return;if(this.ll.lat>83||this.ll.lat<-65){this.doGTOPO30Request();return;}this._doRequest('http://ws.geonames.org/astergdem','checkASTERGDEMResult');},checkASTERGDEMResult:function(ele){if(this.aborted)return;if(ele==-9999){this.doGTOPO30Request();return;}this.callback(ele);},doGTOPO30Request:function(){if(this.aborted)return;this._doRequest('http://ws.geonames.org/gtopo30','checkGTOPO30Result');},checkGTOPO30Result:function(ele){if(this.aborted)return;if(ele==-9999){this.callback(null);return;}this.callback(ele);},_doRequest:function(url,fCheck){this.abort(true);if(!url)return;this.request=OpenLayers.Request.GET({url:'./proxy.php',params:{'_proxy_url':url,'lng':this.ll.lon,'lat':this.ll.lat},scope:this,success:function(request){this[fCheck].call(this,parseInt(request.responseText.replace(/(\n|\r)+$/,''),10));},failure:function(request){this[fCheck].call(this,null);}});},CLASS_NAME:'OpenLayers.Elevation'});OpenLayers.Elevation.SERVICES={SRTM3:1,ASTERGDEM:2,GTOPO30:3};
OpenLayers.Layer.GPXLayer=OpenLayers.Class(OpenLayers.Layer.Vector,{EVENT_ELEVATIONNEEDED:'elevationneeded',initialize:function(name,options){OpenLayers.Layer.Vector.prototype.initialize.apply(this,arguments);this.events.addEventType(OpenLayers.Layer.GPXLayer.prototype.EVENT_ELEVATIONNEEDED);},unselectAllFeatures:function(){for(var i=this.selectedFeatures.length-1;i>-1;i--){var f=this.selectedFeatures[i];this.events.triggerEvent('featureunselected',{feature:f});this.drawFeature(f);}this.selectedFeatures=[];},CLASS_NAME:'OpenLayers.Layer.GPXLayer'});
OpenLayers.Util.onImageLoadError=function(){this._attempts=(this._attempts)?(this._attempts+1):1;if(this._attempts<=OpenLayers.IMAGE_RELOAD_ATTEMPTS){var urls=this.urls;if(urls&&urls instanceof Array&&urls.length>1){var src=this.src.toString();var current_url,k;for(k=0;current_url=urls[k];k++){if(src.indexOf(current_url)!=-1){break;}}var guess=Math.floor(urls.length*Math.random());var new_url=urls[guess];k=0;while(new_url==current_url&&k++<4){guess=Math.floor(urls.length*Math.random());new_url=urls[guess];}this.src=src.replace(current_url,new_url);}else{this.src=this.src;}}else{if(this.layer&&this.layer.onLoadError)this.src=this.layer.onLoadError(this.src);else
OpenLayers.Element.addClass(this,"olImageLoadError");}this.style.display="";};OpenLayers.Util.distanceBetweenLonLat=function(pt1,pt2){function haversin(angle){var sin=Math.sin(angle/2);return sin*sin;};var dlon=(pt2.lon-pt1.lon)*Math.PI/180;var lat1=pt1.lat*Math.PI/180;var lat2=pt2.lat*Math.PI/180;var dlat=lat2-lat1;var h=haversin(dlat)+Math.cos(lat1)*Math.cos(lat2)*haversin(dlon);return 2*OpenLayers.Util.EARTH_RADIUS*Math.asin(Math.sqrt(h));};OpenLayers.Util.EARTH_RADIUS=6367449;OpenLayers.Util.rad2deg=function(angle){return(angle/Math.PI)*180;};OpenLayers.Util.headingBetweenLonLat=function(pt1,pt2){var ret=OpenLayers.Util.rad2deg(Math.atan((pt2.lat-pt1.lat)/(pt2.lon-pt1.lon)));if(pt2.lon-pt1.lon<0)return 90-ret+180;return 90-ret;};OpenLayers.Util.formatDistance=function(d,unit){if(d>100000||unit=='km')return(d/1000).toFixed(0)+' km';if(d>1000)return(d/1000).toFixed(1)+' km';if(d>100)return d.toFixed(0)+' m';return d.toFixed(1)+' m';};OpenLayers.Util.formatElevation=function(e){return e.toFixed(0)+' m';};OpenLayers.Util.formatDuration=function(d){var ret=[];if(d>=3600000){ret.push(Math.floor(d/3600000)+'h');d=d%3600000;}if(d>=60000){ret.push(Math.floor(d/60000)+'m');d=d%60000;}if(d>0){ret.push(Math.floor(d/1000)+'s');}return ret.join(' ');};
Ext.namespace('GPXEditor1_1');GPXEditor1_1.GPXEditor=Ext.extend(Ext.Panel,{gpxMap:undefined,editorPanel:undefined,editorToolbar:undefined,bExpand:undefined,initComponent:function(){Ext.applyIf(this,{LOCALES:GPXEditor1_1.GPXEditor.LOCALES});this.gpxMap=new GPXEditor1_1.GPXMap({region:'center',allowEditing:true,bbar:{xtype:'gpxe-GPXMapToolbar',style:{borderRight:'none'}}});var editorMode=new GPXEditor1_1.EditorMode({gpxLayer:this.gpxMap.getGPXLayer()});this.bExpand=new Ext.Button({iconCls:'gpxe-CollapseIcon',tooltip:this.LOCALES.BT_COLLAPSE_EDITOR_TOOLTIP,handler:function(){this.editorPanel.toggleCollapse(true);},scope:this});this.editorPanel=new GPXEditor1_1.EditorPanel({region:'east',split:true,width:300,collapsible:false,collapseMode:'mini',editorMode:editorMode,gpxLayer:this.gpxMap.getGPXLayer()});this.editorToolbar=new GPXEditor1_1.EditorToolbar({region:'east',layout:'vtoolbar',width:20,editorMode:editorMode,gpxLayer:this.gpxMap.getGPXLayer()});this.editorToolbar.insert(0,'-');this.editorToolbar.insert(0,' ');this.editorToolbar.insert(0,' ');this.editorToolbar.insert(0,this.bExpand);this.editorPanel.on('collapse',function(){this.bExpand.setTooltip(this.LOCALES.BT_EXPAND_EDITOR_TOOLTIP);this.bExpand.setIconClass('gpxe-ExpandIcon');},this);this.editorPanel.on('expand',function(){this.bExpand.setTooltip(this.LOCALES.BT_COLLAPSE_EDITOR_TOOLTIP);this.bExpand.setIconClass('gpxe-CollapseIcon');},this);Ext.applyIf(this,{layout:'border',border:false,bodyBorder:false,items:[{region:'center',xtype:'panel',layout:'border',border:false,items:[this.gpxMap,this.editorToolbar]},this.editorPanel]});GPXEditor1_1.GPXEditor.superclass.initComponent.call(this);},getGPXMap:function(){return this.gpxMap;},getEditorPanel:function(){return this.editorPanel;},getEditorToolbar:function(){return this.editorToolbar;}});Ext.reg('gpxe-GPXEditor',GPXEditor1_1.GPXEditor);GPXEditor1_1.GPXEditor.LOCALES={BT_COLLAPSE_EDITOR_TOOLTIP:'BT_COLLAPSE_EDITOR_TOOLTIP',BT_EXPAND_EDITOR_TOOLTIP:'BT_EXPAND_EDITOR_TOOLTIP'};
Ext.namespace('GPXEditor1_1');GPXEditor1_1.GPXMap=Ext.extend(GeoExt.MapPanel,{keyMap:undefined,gpxLayer:undefined,slideFactor:undefined,mapActions:undefined,winHelp:undefined,initComponent:function(){Ext.applyIf(this,{LOCALES:GPXEditor1_1.GPXMap.LOCALES});Ext.applyIf(this,{bodyCssClass:'gpxe-GPXMap',slideFactor:75,mapActions:[],winHelp:new Ext.Window({title:this.LOCALES.HELP_TITLE,iconCls:'gpxe-Help',forceLayout:true,layout:'fit',closeAction:'hide',modal:false,width:600,height:300,items:[{xtype:'panel',border:false,bodyBorder:false,margins:10,contentEl:'gpxe-helpGPXEditor1_1',autoScroll:true}],listeners:{show:function(){Ext.get('gpxe-helpGPXEditor1_1').show();},scope:this}})});if(!(this.map instanceof OpenLayers.MapWithVectorReprojection))this.map=new OpenLayers.MapWithVectorReprojection(Ext.id(null,'map_'),{displayProjection:new OpenLayers.Projection('EPSG:4326'),controls:[new OpenLayers.Control.MouseDefaults(),new Geoportal.Control.TermsOfService(),new Geoportal.Control.PermanentLogo(),new Geoportal.Control.Logo()]});this.map.events.on({'zoomend':this._updateZoomActions,'changebaselayer':this.checkExtentCompatibility,scope:this});this.mapProvidersStore=new GPXEditor1_1.data.MapProvidersStore({map:this.map});this.center=new OpenLayers.LonLat(6.31328,45.35818);this.center=this.center.transform(this.getDisplayProjection(),this.getDrawProjection());this.zoom=5;if(!(this.gpxLayer instanceof GPXEditor1_1.GPXLayer))this.gpxLayer=new GPXEditor1_1.GPXLayer();this.gpxLayer.setGPXMap(this);this.gpxLayer.setAllowEditing(this.allowEditing);GPXEditor1_1.GPXMap.superclass.initComponent.call(this);this._initKeyEvent();},getMap:function(){return this.map;},getDisplayProjection:function(){return this.map.displayProjection;},getDrawProjection:function(){return this.map.getProjectionObject();},getNumZoomLevels:function(){return this.map.getNumZoomLevels();},getMinZoomLevel:function(){return 0;},getMaxZoomLevel:function(){return this.getNumZoomLevels()-1;},getMaxExtent:function(){return this.map.getMaxExtent();},checkExtentCompatibility:function(o){var me=this.map.getMaxExtent();var e=this.map.getExtent();if(!me.containsBounds(e,true)){Ext.MessageBox.show({title:this.LOCALES.ERROR_INCOMPATIBLE_EXTENT_TITLE,msg:this.LOCALES.ERROR_INCOMPATIBLE_EXTENT_MSG,buttons:Ext.MessageBox.OKCANCEL,animEl:this.el,icon:Ext.MessageBox.ERROR,fn:function(bId){if(bId=='ok')this.map.zoomToMaxExtent();else{this.map.setBaseLayer(o.oldLayer);this.map.zoomToExtent(o.oldExtent);}},scope:this});}},onLayerchange:function(e){GPXEditor1_1.GPXMap.superclass.onLayerchange.apply(this,arguments);this._updateZoomActions();var e=Ext.get(this.map.id+'_GMap2Container');if(e!=null)e.setStyle('background-color',null);},isValidCenter:function(lon,lat){var ll=new OpenLayers.LonLat(lon,lat);var me=this.map.getMaxExtent();ll.transform(this.getDisplayProjection(),this.getDrawProjection());return me.containsLonLat(ll);},setCenter:function(lon,lat,zoom){var ll=new OpenLayers.LonLat(lon,lat);var me=this.getMaxExtent();if(!this.isValidCenter(lon,lat)){Ext.MessageBox.show({title:this.LOCALES.ERROR_INCOMPATIBLE_CENTER_POINT_TITLE,msg:this.LOCALES.ERROR_INCOMPATIBLE_CENTER_POINT_MSG,buttons:Ext.MessageBox.CANCEL,animEl:this.el,icon:Ext.MessageBox.ERROR,scope:this});return;}ll.transform(this.getDisplayProjection(),this.getDrawProjection());if(zoom)this.map.setCenter(ll,zoom,false,true);else
this.map.setCenter(ll);},panRight:function(page){if(page){var size=this.map.getSize();this.map.pan(0.75*size.w,0);}else
this.map.pan(this.slideFactor,0);},panLeft:function(page){if(page){var size=this.map.getSize();this.map.pan(-0.75*size.w,0);}else
this.map.pan(-this.slideFactor,0);},panUp:function(page){if(page){var size=this.map.getSize();this.map.pan(0,-0.75*size.h);}else
this.map.pan(0,-this.slideFactor);},panDown:function(page){if(page){var size=this.map.getSize();this.map.pan(0,0.75*size.h);}else
this.map.pan(0,this.slideFactor);},zoomIn:function(){this.map.zoomIn();},zoomOut:function(){this.map.zoomOut();},zoomToMap:function(){this.map.zoomToMaxExtent();},zoomToExtent:function(extent){if(!extent)return;this.map.zoomToExtent(extent);},zoomToGPX:function(){if(this.gpxLayer)this.gpxLayer.zoomToGPX();},getGPXLayer:function(){return this.gpxLayer;},setMapMode:function(mode){if(this.mapActions[mode]&&this.mapActions[mode].control)this.mapActions[mode].control.activate();},getAction:function(actionId){if(!this.mapActions[actionId]){var definedActions=GPXEditor1_1.GPXMap.ACTIONS;switch(actionId){case definedActions.ZOOM_OUT:this.mapActions[actionId]=new GeoExt.Action({control:new OpenLayers.Control.ZoomOut(),map:this.map,iconCls:'gpxe-ZoomOut',text:this.LOCALES.ACTION_ZOOM_IN_TEXT,tooltip:this.LOCALES.ACTION_ZOOM_OUT_TOOLTIP});break;case definedActions.ZOOM_MAP:this.mapActions[actionId]=new GeoExt.Action({control:new OpenLayers.Control.ZoomToMaxExtent(),map:this.map,iconCls:'gpxe-ZoomToMaxExtent',text:this.LOCALES.ACTION_ZOOM_MAP_TEXT,tooltip:this.LOCALES.ACTION_ZOOM_MAP_TOOLTIP});break;case definedActions.ZOOM_IN:this.mapActions[actionId]=new GeoExt.Action({control:new OpenLayers.Control.ZoomIn(),map:this.map,iconCls:'gpxe-ZoomIn',text:this.LOCALES.ACTION_ZOOM_IN_TEXT,tooltip:this.LOCALES.ACTION_ZOOM_IN_TOOLTIP});break;case definedActions.NAVIGATE:this.mapActions[actionId]=new GeoExt.Action({control:new OpenLayers.Control.GPXNavigation(this.gpxLayer.gpxLayer,{geometryTypes:['OpenLayers.Geometry.Point','OpenLayers.Geometry.LineString','OpenLayers.Geometry.MultiLineString'],selectStyle:OpenLayers.Feature.Vector.style.select}),map:this.map,iconCls:'gpxe-Nav',text:this.LOCALES.ACTION_NAVIGATE_TEXT,tooltip:this.LOCALES.ACTION_NAVIGATE_TOOLTIP,toggleGroup:GPXEditor1_1.GPXMap.MAP_ACTION_GROUP,allowDepress:false,pressed:true,checked:true});break;case definedActions.HELP:this.mapActions[actionId]=new Ext.Action({iconCls:'gpxe-Help',text:this.LOCALES.ACTION_HELP_TEXT,tooltip:this.LOCALES.ACTION_HELP_TOOLTIP,handler:function(){this.winHelp.show();},scope:this});break;}}return this.mapActions[actionId];},_updateZoomActions:function(){if(this.mapActions['ZOOM_OUT'])this.map.getZoom()==0?this.mapActions['ZOOM_OUT'].disable():this.mapActions['ZOOM_OUT'].enable();if(this.mapActions['ZOOM_IN'])this.map.getZoom()==(this.map.getNumZoomLevels()-1)?this.mapActions['ZOOM_IN'].disable():this.mapActions['ZOOM_IN'].enable();},_initKeyEvent:function(){this.keyMap=new Ext.KeyMap(document,[{key:[43,61,187,107],fn:function(){this.zoomIn();},scope:this,stopEvent:true},{key:[45,95,109,189],fn:function(){this.zoomOut();},scope:this,stopEvent:true},{key:'hH',fn:function(){this.winHelp.show();},ctrl:true,scope:this,stopEvent:true},{key:'eE',fn:function(){this.gpxLayer.showEditGPXElementWindow(this.gpxLayer.getHighlightedFeature());},scope:this,stopEvent:true},{key:'oO',ctrl:true,fn:function(){this.gpxLayer.showGPXLoadWindow();},scope:this,stopEvent:true},{key:'aA',fn:function(){this.zoomToMap();},ctrl:true,scope:this,stopEvent:true},{key:'aA',ctrl:false,fn:function(){this.gpxLayer.zoomToGPX();},scope:this,stopEvent:true},{key:Ext.EventObject.LEFT,fn:function(){this.panLeft();},ctrl:false,scope:this,stopEvent:true},{key:Ext.EventObject.LEFT,fn:function(){this.panLeft(true);},ctrl:true,scope:this,stopEvent:true},{key:Ext.EventObject.RIGHT,fn:function(){this.panRight();},ctrl:false,scope:this,stopEvent:true},{key:Ext.EventObject.RIGHT,fn:function(){this.panRight(true);},ctrl:true,scope:this,stopEvent:true},{key:Ext.EventObject.UP,fn:function(){this.panUp();},ctrl:false,scope:this,stopEvent:true},{key:Ext.EventObject.UP,fn:function(){this.panUp(true);},ctrl:true,scope:this,stopEvent:true},{key:Ext.EventObject.DOWN,fn:function(){this.panDown();},ctrl:false,scope:this,stopEvent:true},{key:Ext.EventObject.DOWN,fn:function(){this.panDown(true);},ctrl:true,scope:this,stopEvent:true}]);this.keyMap.disable();this.on('render',function(){this.body.on('mouseenter',function(){this.keyMap.enable();},this);this.body.on('mouseleave',function(){this.keyMap.disable();},this);},this);}});Ext.reg('gpxe-GPXMap',GPXEditor1_1.GPXMap);GPXEditor1_1.GPXMap.MAP_ACTION_GROUP='GPXEditor1_1.GPXMap.MAP_ACTION_GROUP';GPXEditor1_1.GPXMap.ACTIONS={ZOOM_IN:'ZOOM_IN',ZOOM_MAP:'ZOOM_MAP',ZOOM_OUT:'ZOOM_OUT',NAVIGATE:'NAVIGATE',HELP:'HELP'};GPXEditor1_1.GPXMap.LOCALES={ACTION_ZOOM_IN_TEXT:'ACTION_ZOOM_IN_TEXT',ACTION_ZOOM_IN_TOOLTIP:'ACTION_ZOOM_IN_TOOLTIP',ACTION_ZOOM_MAP_TEXT:'ACTION_ZOOM_MAP_TEXT',ACTION_ZOOM_MAP_TOOLTIP:'ACTION_ZOOM_MAP_TOOLTIP',ACTION_ZOOM_OUT_TEXT:'ACTION_ZOOM_OUT_TEXT',ACTION_ZOOM_OUT_TOOLTIP:'ACTION_ZOOM_OUT_TOOLTIP',ACTION_NAVIGATE_TEXT:'ACTION_NAVIGATE_TEXT',ACTION_NAVIGATE_TOOLTIP:'ACTION_NAVIGATE_TOOLTIP',ERROR_INCOMPATIBLE_CENTER_POINT_TITLE:'ERROR_INCOMPATIBLE_CENTER_POINT_TITLE',ERROR_INCOMPATIBLE_CENTER_POINT_MSG:'ERROR_INCOMPATIBLE_CENTER_POINT_MSG',ACTION_HELP_TEXT:'ACTION_HELP_TEXT',ACTION_HELP_TOOLTIP:'ACTION_HELP_TOOLTIP',HELP_TITLE:'HELP_TITLE'};
Ext.namespace('GPXEditor1_1');GPXEditor1_1.GPXMapToolbar=Ext.extend(Ext.Toolbar,{gpxMap:undefined,initComponent:function(){Ext.applyIf(this,{LOCALES:GPXEditor1_1.GPXMapToolbar.LOCALES});if(!(this.gpxMap instanceof GPXEditor1_1.GPXMap))this.gpxMap=this.findParentByType(GPXEditor1_1.GPXMap);if(!(this.gpxMap instanceof GPXEditor1_1.GPXMap))this.gpxMap=new GPXEditor1_1.GPXMap();var leftItems=this._initLeftItems();var rightItems=this._initRightItems();var items=[];if(leftItems.length>0)items.push(leftItems);if(rightItems.length>0){items.push('->');items.push(rightItems);}Ext.apply(this,{items:items});GPXEditor1_1.GPXMapToolbar.superclass.initComponent.call(this);},getGPXMap:function(){return this.gpxMap;},_initLeftItems:function(){var ret=[];var mapActions=GPXEditor1_1.GPXMap.ACTIONS;var bt;this.layersMenu=new GPXEditor1_1.menu.LayersMenu({mapProvidersStore:this.gpxMap.mapProvidersStore});bt=new Ext.Button(this.layersMenu.getActionMenu());bt.menuAlign='bl-tl';bt.setText(null);this.layersMenu.winProviders.on('hide',function(){this.showMenu();this.hideMenu();},bt);ret.push(bt);ret.push(' ');ret.push(' ');ret.push('-');bt=new Ext.Button(this.gpxMap.getAction(mapActions.ZOOM_OUT));bt.setText(null);ret.push(bt);bt=new Ext.Button(this.gpxMap.getAction(mapActions.ZOOM_MAP));bt.setText(null);ret.push(bt);bt=new Ext.Button(this.gpxMap.getAction(mapActions.ZOOM_IN));bt.setText(null);ret.push(bt);ret.push(' ');ret.push('-');bt=new Ext.Button(this.gpxMap.getAction(mapActions.NAVIGATE));bt.setText(null);ret.push(bt);return ret;},_initRightItems:function(){var mapActions=GPXEditor1_1.GPXMap.ACTIONS;var ret=[];var bt;ret.push({text:GPXEditor1_1.form.CitySearchComboBox.LOCALES.LABEL_SEARCH_CITY,tooltip:GPXEditor1_1.form.CitySearchComboBox.LOCALES.SEARCH_INPUT_HELP});ret.push(new GPXEditor1_1.form.CitySearchComboBox({listAlign:'br-tr',listeners:{select:this.selectCity,scope:this}}));ret.push(' ');ret.push(' ');bt=new Ext.Button(this.gpxMap.getAction(mapActions.HELP));bt.setText(null);ret.push(bt);ret.push(' ');ret.push(' ');return ret;},selectCity:function(cb,record,index){var zoom=this.gpxMap.getMaxZoomLevel()-4;if(!this.gpxMap.isValidCenter(record.get('lon'),record.get('lat'))){Ext.MessageBox.show({title:this.LOCALES.ERROR_CANT_DISPLAY_CITY_ON_THIS_MAP_BACKGROUND_TITLE,msg:this.LOCALES.ERROR_CANT_DISPLAY_CITY_ON_THIS_MAP_BACKGROUND_MSG,buttons:Ext.MessageBox.CANCEL,animEl:this.el,icon:Ext.MessageBox.ERROR,scope:this});return;}this.gpxMap.setCenter(record.get('lon'),record.get('lat'),zoom);}});Ext.reg('gpxe-GPXMapToolbar',GPXEditor1_1.GPXMapToolbar);GPXEditor1_1.GPXMapToolbar.LOCALES={ERROR_CANT_DISPLAY_CITY_ON_THIS_MAP_BACKGROUND_TITLE:'ERROR_CANT_DISPLAY_CITY_ON_THIS_MAP_BACKGROUND_TITLE',ERROR_CANT_DISPLAY_CITY_ON_THIS_MAP_BACKGROUND_MSG:'ERROR_CANT_DISPLAY_CITY_ON_THIS_MAP_BACKGROUND_MSG'};
Ext.namespace('GPXEditor1_1');GPXEditor1_1.GPXLayer=Ext.extend(Ext.util.Observable,{gpxMap:undefined,gpxLayer:undefined,selectControl:undefined,gpxIO:undefined,wptStore:undefined,rteStore:undefined,trkStore:undefined,loadingInProgress:undefined,mapActions:undefined,gpxActions:undefined,allowEditing:undefined,highlightedFeature:undefined,winLoadGPX:undefined,winSaveGPX:undefined,winEditWpt:undefined,winEditRte:undefined,winEditTrk:undefined,winEditElevation:undefined,winGetEle:undefined,constructor:function(config){config=config||{};this.LOCALES=GPXEditor1_1.GPXLayer.LOCALES;this.gpxLayer=new OpenLayers.Layer.GPXLayer('__gpx__',{displayProjection:new OpenLayers.Projection('EPSG:4326'),displayInLayerSwitcher:false});this.gpxLayer.events.register('featureselected',this,this._onSelectFeature);this.gpxLayer.events.register('featureunselected',this,this._onUnselectFeature);this.gpxLayer.events.register('elevationneeded',this,this._onElevationNeeded);this.gpxIO=new OpenLayers.Format.GPXEditorIO();this.wptStore=new GPXEditor1_1.data.WPTStore({gpxLayer:this,listeners:{add:function(store,records,index){this.fireEvent('wptadded',records,this);this.fireEvent('modified',true,this);if(!this.loadingInProgress)this.showEditGPXElementWindow(records[0]);},update:function(store,record,operation){this.fireEvent('wptmodified',record,operation,this);this.fireEvent('modified',true,this);},remove:function(store,record,index){if(this.getNbWpts()==0&&this.gpxMap)this.gpxMap.setMapMode(GPXEditor1_1.GPXMap.ACTIONS.NAVIGATE);this.fireEvent('wptremoved',record,index,this);this.fireEvent('modified',true,this);},scope:this}});this.rteStore=new GPXEditor1_1.data.RTEStore({gpxLayer:this,listeners:{add:function(store,records,index){this.fireEvent('rteadded',records,this);this.fireEvent('modified',true,this);if(!this.loadingInProgress)this.showEditGPXElementWindow(records[0]);},update:function(store,record,operation){this.fireEvent('rtemodified',record,operation,this);this.fireEvent('modified',true,this);},remove:function(store,record,index){if(this.getNbRtes()==0&&this.gpxMap)this.gpxMap.setMapMode(GPXEditor1_1.GPXMap.ACTIONS.NAVIGATE);this.fireEvent('rteremoved',record,index,this);this.fireEvent('modified',true,this);},scope:this}});this.trkStore=new GPXEditor1_1.data.TRKStore({gpxLayer:this,listeners:{add:function(store,records,index){this.fireEvent('trkadded',records,this);this.fireEvent('modified',true,this);},update:function(store,record,operation){this.fireEvent('trkmodified',record,operation,this);this.fireEvent('modified',true,this);},remove:function(store,record,index){if(this.getNbTrks()==0&&this.gpxMap)this.gpxMap.setMapMode(GPXEditor1_1.GPXMap.ACTIONS.NAVIGATE);this.fireEvent('trkremoved',record,index,this);this.fireEvent('modified',true,this);},scope:this}});this.addEvents({gpxmapchange:true,gpxelementselectionchange:true,wptselectionchange:true,rteselectionchange:true,trkselectionchange:true,modified:true,wptadded:true,wptmodified:true,wptremoved:true,rteadded:true,rtemodified:true,rteremoved:true,trkadded:true,trkmodified:true,trkremoved:true});this.listeners=config.listeners;this.mapActions=[];this.gpxActions=[];this.loadingInProgress=false;this.allowEditing=false;this._initWindows();GPXEditor1_1.GPXLayer.superclass.constructor.call(this,config);if(config.gpxMap instanceof GPXEditor1_1.GPXMap){this.setGPXMap(config.gpxMap);delete config.gpxMap;}this.on('modified',this.updateActions);},setGPXMap:function(gpxMap){if(this.gpxMap===gpxMap)return;var nc;if(this.gpxMap){if(this.selectControl){this.selectControl.events.unregister('beforefeaturehighlighted',this,this._onBeforeFeatureHighlighted);this.selectControl.events.unregister('featureunhighlighted',this,this._onBeforeFeatureUnhighlighted);}this.gpxMap.getMap().removeLayer(this.gpxLayer);}this.gpxMap=gpxMap;this.gpxMap.getMap().addLayers([this.gpxLayer]);nc=this.gpxMap.getAction(GPXEditor1_1.GPXMap.ACTIONS.NAVIGATE);this.selectControl=nc.control.selectControl;this.selectControl.events.register('beforefeaturehighlighted',this,this._onBeforeFeatureHighlighted);this.selectControl.events.register('featureunhighlighted',this,this._onBeforeFeatureUnhighlighted);this.fireEvent('gpxmapchange',this.gpxMap,this);},getGPXMap:function(){return this.gpxMap;},getOLSelectControl:function(){return this.selectControl;},setAllowEditing:function(bool){this.allowEditing=(bool==true);},isAllowEditing:function(){return this.allowEditing;},getWptStore:function(){return this.wptStore;},addWpt:function(wptRecord){this.wptStore.add(wptRecord);},getNbWpts:function(){return this.wptStore.getCount();},getWptAt:function(index){return this.wptStore.getAt(index);},removeWpt:function(wptRecord){this.wptStore.remove(wptRecord);},getRteStore:function(){return this.rteStore;},addRte:function(rteRecord){this.wptStore.add(rteRecord);},getNbRtes:function(){return this.rteStore.getCount();},getRteAt:function(index){return this.rteStore.getAt(index);},removeRte:function(rteRecord){this.rteStore.remove(rteRecord);},getTrkStore:function(){return this.trkStore;},addTrk:function(trkRecord){this.wptStore.add(trkRecord);},getNbTrks:function(){return this.trkStore.getCount();},getTrkAt:function(index){return this.trkStore.getAt(index);},removeTrk:function(trkRecord){this.trkStore.remove(trkRecord);},clear:function(){this.gpxLayer.destroyFeatures();},showEditGPXElementWindow:function(obj){if(!this.isAllowEditing()||!obj)return;var record=null;var test=obj;if(test instanceof OpenLayers.Feature)test=obj.geometry;if(test instanceof OpenLayers.Geometry.Point)record=this.wptStore.getRecordFromFeature(obj);else if(test instanceof GPXEditor1_1.data.WPTRecord)record=obj;if(record){this.winEditWpt.show({record:record});return;}if(test instanceof OpenLayers.Geometry.LineString)record=this.rteStore.getRecordFromFeature(obj);else if(test instanceof GPXEditor1_1.data.RTERecord)record=obj;if(record){this.winEditRte.show({record:record});return;}if(test instanceof OpenLayers.Geometry.MultiLineString)record=this.trkStore.getRecordFromFeature(obj);else if(test instanceof GPXEditor1_1.data.TRKRecord)record=obj;if(record){this.winEditTrk.show({record:record});return;}},showGPXLoadWindow:function(){if(this.isAllowEditing())this.winLoadGPX.show();},loadGPXDoc:function(gpxDoc,options){if(!this.isAllowEditing())return;var features=this._getFeatureFromGPXDoc(gpxDoc,options);if(features.length>0){this.clear();this.gpxLayer.addFeatures(features);this.zoomToGPX();if(this.gpxMap)this.gpxMap.setMapMode(GPXEditor1_1.GPXMap.ACTIONS.NAVIGATE);}this.loadingInProgress=false;},importGPXDoc:function(gpxDoc,options){if(!this.isAllowEditing())return;var features=this._getFeatureFromGPXDoc(gpxDoc,options);if(features.length>0){this.gpxLayer.addFeatures(features);this.zoomToGPX();if(this.gpxMap)this.gpxMap.setMapMode(GPXEditor1_1.GPXMap.ACTIONS.NAVIGATE);}this.loadingInProgress=false;},getDataExtent:function(){return this.gpxLayer.getDataExtent();},zoomToGPX:function(){if(this.gpxMap)this.gpxMap.zoomToExtent(this.getDataExtent());},getHighlightedFeature:function(){return this.highlightedFeature;},getAction:function(actionId){if(actionId in GPXEditor1_1.GPXLayer.GPX_ACTIONS)return this.getGPXAction(actionId);if(actionId in GPXEditor1_1.GPXLayer.MAP_ACTIONS)return this.getMapAction(actionId);return null;},getGPXAction:function(actionId){if(!this.gpxActions[actionId]){var definedActions=GPXEditor1_1.GPXLayer.GPX_ACTIONS;switch(actionId){case definedActions.LOAD_GPX:this.gpxActions[actionId]=new Ext.Action({iconCls:'gpxe-AddFileIcon',text:this.LOCALES.ACTION_LOADGPX_TEXT,tooltip:this.LOCALES.ACTION_LOADGPX_TOOLTIP,handler:function(){this.loadingInProgress=true;this.winLoadGPX.show();},scope:this});break;case definedActions.SAVE_GPX:this.gpxActions[actionId]=new Ext.Action({iconCls:'gpxe-SaveFileIcon',text:this.LOCALES.ACTION_SAVEGPX_TEXT,tooltip:this.LOCALES.ACTION_SAVEGPX_TOOLTIP,handler:function(){this.winSaveGPX.show();},scope:this});break;case definedActions.DEL_GPX:this.gpxActions[actionId]=new Ext.Action({iconCls:'gpxe-DeleteAllIcon',text:this.LOCALES.ACTION_DELGPX_TEXT,tooltip:this.LOCALES.ACTION_DELGPX_TOOLTIP,handler:function(){this.clear();},scope:this});break;case definedActions.EDIT_WPT:this.gpxActions[actionId]=new Ext.Action({iconCls:'gpxe-WptEdit',tooltip:this.LOCALES.MAP_ACTION_EDIT_WPT_TOOLTIP,disabled:true,handler:function(){if(this.selectedElement)this.winEditWpt.show({record:this.selectedElement});},scope:this});break;case definedActions.DEL_WPT:this.gpxActions[actionId]=new Ext.Action({iconCls:'gpxe-WptDelete',tooltip:this.LOCALES.MAP_ACTION_DEL_WPT_TOOLTIP,disabled:true,handler:function(){if(this.selectedElement){this.wptStore.remove([this.selectedElement]);this.setSelectedElement(null);}},scope:this});break;case definedActions.EDIT_RTE:this.gpxActions[actionId]=new Ext.Action({iconCls:'gpxe-RteEdit',tooltip:this.LOCALES.MAP_ACTION_EDIT_RTE_TOOLTIP,disabled:true,handler:function(){if(this.selectedElement)this.winEditRte.show({record:this.selectedElement});},scope:this});break;case definedActions.GET_MISSED_ELE:this.gpxActions[actionId]=new Ext.Action({iconCls:'gpxe-GetElevation',tooltip:this.LOCALES.ACTION_GET_MISSED_ELEVATION,disabled:true,handler:function(){if(this.selectedElement)this.winGetEle.show(this.selectedElement.get('feature'));},scope:this});break;case definedActions.DEL_RTE:this.gpxActions[actionId]=new Ext.Action({iconCls:'gpxe-RteDelete',tooltip:this.LOCALES.MAP_ACTION_DEL_RTE_TOOLTIP,disabled:true,handler:function(){if(this.selectedElement){this.rteStore.remove([this.selectedElement]);this.setSelectedElement(null);}},scope:this});break;case definedActions.EDIT_TRK:this.gpxActions[actionId]=new Ext.Action({iconCls:'gpxe-TrkEdit',tooltip:this.LOCALES.MAP_ACTION_EDIT_TRK_TOOLTIP,disabled:true,handler:function(){if(this.selectedElement)this.winEditTrk.show({record:this.selectedElement});},scope:this});break;case definedActions.DEL_TRK:this.gpxActions[actionId]=new Ext.Action({iconCls:'gpxe-TrkDelete',tooltip:this.LOCALES.MAP_ACTION_DEL_TRK_TOOLTIP,disabled:true,handler:function(){if(this.selectedElement){this.trkStore.remove([this.selectedElement]);this.setSelectedElement(null);}},scope:this});break;}}return this.gpxActions[actionId];},getMapAction:function(actionId){var map=this.gpxMap?this.gpxMap.getMap():null;if(!map)return null;if(!this.mapActions[actionId]){var definedActions=GPXEditor1_1.GPXLayer.MAP_ACTIONS;switch(actionId){case definedActions.MAP_ZOOM_GPX:this.mapActions[actionId]=new Ext.Action({iconCls:'gpxe-ZoomToGPX',text:this.LOCALES.MAP_ACTION_ZOOMGPX_TEXT,tooltip:this.LOCALES.MAP_ACTION_ZOOMGPX_TOOLTIP,handler:function(){this.zoomToGPX();},scope:this});break;case definedActions.MAP_ADD_WPT:this.mapActions[actionId]=new GeoExt.Action({control:new OpenLayers.Control.DrawFeature(this.gpxLayer,OpenLayers.Handler.Point,{selectStyle:OpenLayers.Feature.Vector.style.select}),map:map,text:this.LOCALES.MAP_ACTION_ADD_WPT_TEXT,tooltip:this.LOCALES.MAP_ACTION_ADD_WPT_TOOLTIP,iconCls:'gpxe-WptAdd',toggleGroup:GPXEditor1_1.GPXMap.MAP_ACTION_GROUP,allowDepress:false});break;case definedActions.MAP_EDIT_WPT:this.mapActions[actionId]=new GeoExt.Action({control:new OpenLayers.Control.ModifyFeature(this.gpxLayer,{geometryTypes:['OpenLayers.Geometry.Point'],hover:true,selectStyle:OpenLayers.Feature.Vector.style.select}),map:map,text:this.LOCALES.MAP_ACTION_EDIT_WPT_TEXT,tooltip:this.LOCALES.MAP_ACTION_EDIT_WPT_TOOLTIP,iconCls:'gpxe-WptEdit',toggleGroup:GPXEditor1_1.GPXMap.MAP_ACTION_GROUP,allowDepress:false});break;case definedActions.MAP_DEL_WPT:this.mapActions[actionId]=new GeoExt.Action({control:new OpenLayers.Control.DeleteFeature(this.gpxLayer,{geometryTypes:['OpenLayers.Geometry.Point'],selectStyle:OpenLayers.Feature.Vector.style.select}),map:map,text:this.LOCALES.MAP_ACTION_DEL_WPT_TEXT,tooltip:this.LOCALES.MAP_ACTION_DEL_WPT_TOOLTIP,iconCls:'gpxe-WptDelete',toggleGroup:GPXEditor1_1.GPXMap.MAP_ACTION_GROUP,allowDepress:false});break;case definedActions.MAP_ADD_RTE:this.mapActions[actionId]=new GeoExt.Action({control:new OpenLayers.Control.DrawFeature(this.gpxLayer,OpenLayers.Handler.Path,{selectStyle:OpenLayers.Feature.Vector.style.select}),map:map,text:this.LOCALES.MAP_ACTION_ADD_RTE_TEXT,tooltip:this.LOCALES.MAP_ACTION_ADD_RTE_TOOLTIP,iconCls:'gpxe-RteAdd',toggleGroup:GPXEditor1_1.GPXMap.MAP_ACTION_GROUP,allowDepress:false});break;case definedActions.MAP_EDIT_RTE:this.mapActions[actionId]=new GeoExt.Action({control:new OpenLayers.Control.ModifyFeature(this.gpxLayer,{geometryTypes:['OpenLayers.Geometry.LineString'],highlightOnly:true,selectStyle:OpenLayers.Feature.Vector.style.select}),map:map,text:this.LOCALES.MAP_ACTION_EDIT_RTE_TEXT,tooltip:this.LOCALES.MAP_ACTION_EDIT_RTE_TOOLTIP,iconCls:'gpxe-RteEdit',toggleGroup:GPXEditor1_1.GPXMap.MAP_ACTION_GROUP,allowDepress:false});break;case definedActions.MAP_SWAP_RTE:this.mapActions[actionId]=new GeoExt.Action({control:new OpenLayers.Control.PasteAndInverseFeature(this.gpxLayer,{geometryTypes:['OpenLayers.Geometry.LineString'],selectStyle:OpenLayers.Feature.Vector.style.select}),map:map,text:this.LOCALES.MAP_ACTION_SWAP_RTE_TEXT,tooltip:this.LOCALES.MAP_ACTION_SWAP_RTE_TOOLTIP,iconCls:'gpxe-RteSwap',toggleGroup:GPXEditor1_1.GPXMap.MAP_ACTION_GROUP,allowDepress:false});break;case definedActions.MAP_DEL_RTE:this.mapActions[actionId]=new GeoExt.Action({control:new OpenLayers.Control.DeleteFeature(this.gpxLayer,{geometryTypes:['OpenLayers.Geometry.LineString'],selectStyle:OpenLayers.Feature.Vector.style.select}),map:map,text:this.LOCALES.MAP_ACTION_DEL_RTE_TEXT,tooltip:this.LOCALES.MAP_ACTION_DEL_RTE_TOOLTIP,iconCls:'gpxe-RteDelete',toggleGroup:GPXEditor1_1.GPXMap.MAP_ACTION_GROUP,allowDepress:false});break;case definedActions.MAP_CONV_RTE:this.mapActions[actionId]=new GeoExt.Action({control:new OpenLayers.Control.ConvertFeature(this.gpxLayer,{geometryTypes:['OpenLayers.Geometry.LineString'],selectStyle:OpenLayers.Feature.Vector.style.select}),map:map,text:this.LOCALES.MAP_ACTION_CONV_RTE_TEXT,tooltip:this.LOCALES.MAP_ACTION_CONV_RTE_TOOLTIP,iconCls:'gpxe-ToTrk',toggleGroup:GPXEditor1_1.GPXMap.MAP_ACTION_GROUP,allowDepress:false});break;case definedActions.MAP_EDIT_TRK:this.mapActions[actionId]=new GeoExt.Action({control:new OpenLayers.Control.ModifyFeature(this.gpxLayer,{geometryTypes:['OpenLayers.Geometry.MultiLineString'],highlightOnly:true,selectStyle:OpenLayers.Feature.Vector.style.select}),map:map,text:this.LOCALES.MAP_ACTION_EDIT_TRK_TEXT,tooltip:this.LOCALES.MAP_ACTION_EDIT_TRK_TOOLTIP,iconCls:'gpxe-TrkEdit',toggleGroup:GPXEditor1_1.GPXMap.MAP_ACTION_GROUP,allowDepress:false});break;case definedActions.MAP_DEL_TRK:this.mapActions[actionId]=new GeoExt.Action({control:new OpenLayers.Control.DeleteFeature(this.gpxLayer,{geometryTypes:['OpenLayers.Geometry.MultiLineString'],selectStyle:OpenLayers.Feature.Vector.style.select}),map:map,text:this.LOCALES.MAP_ACTION_DEL_TRK_TEXT,tooltip:this.LOCALES.MAP_ACTION_DEL_TRK_TOOLTIP,iconCls:'gpxe-TrkDelete',toggleGroup:GPXEditor1_1.GPXMap.MAP_ACTION_GROUP,allowDepress:false});break;case definedActions.MAP_CONV_TRK:this.mapActions[actionId]=new GeoExt.Action({control:new OpenLayers.Control.ConvertFeature(this.gpxLayer,{geometryTypes:['OpenLayers.Geometry.MultiLineString'],selectStyle:OpenLayers.Feature.Vector.style.select}),map:map,text:this.LOCALES.MAP_ACTION_CONV_TRK_TEXT,tooltip:this.LOCALES.MAP_ACTION_CONV_TRK_TOOLTIP,iconCls:'gpxe-ToRte',toggleGroup:GPXEditor1_1.GPXMap.MAP_ACTION_GROUP,allowDepress:false});break;}}return this.mapActions[actionId];},updateActions:function(){var definedActions=GPXEditor1_1.GPXLayer.ACTIONS;var definedMapActions=GPXEditor1_1.GPXLayer.MAP_ACTIONS;var nbWpts=this.getNbWpts();var nbRtes=this.getNbRtes();var nbTrks=this.getNbTrks();var nbElements=nbWpts+nbRtes+nbTrks;if(this.gpxActions[definedActions.SAVE_GPX])this.gpxActions[definedActions.SAVE_GPX].setDisabled(nbElements==0);if(this.gpxActions[definedActions.DEL_GPX])this.gpxActions[definedActions.DEL_GPX].setDisabled(nbElements==0);if(this.mapActions[definedActions.MAP_ZOOM_GPX])this.mapActions[definedActions.MAP_ZOOM_GPX].setDisabled(nbElements==0);if(this.gpxMap){if(this.mapActions[definedActions.MAP_EDIT_WPT])this.mapActions[definedMapActions.MAP_EDIT_WPT].setDisabled(nbWpts==0);if(this.mapActions[definedActions.MAP_DEL_WPT])this.mapActions[definedMapActions.MAP_DEL_WPT].setDisabled(nbWpts==0);if(this.mapActions[definedMapActions.MAP_EDIT_RTE])this.mapActions[definedMapActions.MAP_EDIT_RTE].setDisabled(nbRtes==0);if(this.mapActions[definedMapActions.MAP_SWAP_RTE])this.mapActions[definedMapActions.MAP_SWAP_RTE].setDisabled(nbRtes==0);if(this.mapActions[definedMapActions.MAP_DEL_RTE])this.mapActions[definedMapActions.MAP_DEL_RTE].setDisabled(nbRtes==0);if(this.mapActions[definedMapActions.MAP_CONV_RTE])this.mapActions[definedMapActions.MAP_CONV_RTE].setDisabled(nbRtes==0);if(this.mapActions[definedMapActions.MAP_EDIT_TRK])this.mapActions[definedMapActions.MAP_EDIT_TRK].setDisabled(true);if(this.mapActions[definedMapActions.MAP_DEL_TRK])this.mapActions[definedMapActions.MAP_DEL_TRK].setDisabled(nbTrks==0);if(this.mapActions[definedMapActions.MAP_CONV_TRK])this.mapActions[definedMapActions.MAP_CONV_TRK].setDisabled(nbTrks==0);}else{for(var i=0,len=definedMapActions.length;i<len;i++){if(this.mapActions[definedMapActions[i]])this.mapActions[definedMapActions[i]].setDisabled(true);}}},_updateSelectedActions:function(){var isWptSelected=(this.selectedElement instanceof GPXEditor1_1.data.WPTRecord);var isRteSelected=(this.selectedElement instanceof GPXEditor1_1.data.RTERecord);var isTrkSelected=(this.selectedElement instanceof GPXEditor1_1.data.TRKRecord);var definedActions=GPXEditor1_1.GPXLayer.ACTIONS;if(this.gpxActions[definedActions.EDIT_WPT])this.gpxActions[definedActions.EDIT_WPT].setDisabled(!isWptSelected);if(this.gpxActions[definedActions.DEL_WPT])this.gpxActions[definedActions.DEL_WPT].setDisabled(!isWptSelected);if(this.gpxActions[definedActions.EDIT_RTE])this.gpxActions[definedActions.EDIT_RTE].setDisabled(!isRteSelected);if(this.gpxActions[definedActions.GET_MISSED_ELE])this.gpxActions[definedActions.GET_MISSED_ELE].setDisabled(!isRteSelected);if(this.gpxActions[definedActions.DEL_RTE])this.gpxActions[definedActions.DEL_RTE].setDisabled(!isRteSelected);if(this.gpxActions[definedActions.EDIT_TRK])this.gpxActions[definedActions.EDIT_TRK].setDisabled(!isTrkSelected);if(this.gpxActions[definedActions.DEL_TRK])this.gpxActions[definedActions.DEL_TRK].setDisabled(!isTrkSelected);},_getFeatureFromGPXDoc:function(gpxDoc,options){var options=options||{extractWaypoints:true,extractRoutes:true,extractTracks:true};if(!gpxDoc)return[];this.gpxIO.internalProjection=this.gpxMap.getDrawProjection();Ext.apply(this.gpxIO,options);return this.gpxIO.read(gpxDoc);},_initWindows:function(){this.winLoadGPX=new GPXEditor1_1.form.FormWindow({modal:true,width:350,formPanel:{xtype:'gpxe-ImportForm',deferredRender:false,forceLayout:true,frame:true,header:false,autoHeight:true,gpxLayer:this}});this.winLoadGPX.on('show',function(){this.loadingInProgress=true;},this);this.winSaveGPX=new GPXEditor1_1.form.FormWindow({modal:true,width:350,formPanel:{xtype:'gpxe-ExportForm',deferredRender:false,forceLayout:true,frame:true,header:false,autoHeight:true,gpxLayer:this}});this.winEditWpt=new GPXEditor1_1.form.FormWindow({modal:true,width:350,formPanel:{xtype:'gpxe-WPTForm',deferredRender:false,forceLayout:true,frame:true,header:false,autoHeight:true}});this.winEditRte=new GPXEditor1_1.form.FormWindow({modal:true,width:350,formPanel:{xtype:'gpxe-RTEForm',deferredRender:false,forceLayout:true,frame:true,header:false,autoHeight:true}});this.winEditTrk=new GPXEditor1_1.form.FormWindow({modal:true,width:350,formPanel:{xtype:'gpxe-TRKForm',deferredRender:false,forceLayout:true,frame:true,header:false,autoHeight:true}});this.winEditElevation=new GPXEditor1_1.form.FormWindow({modal:true,width:350,formPanel:{xtype:'gpxe-ElevationForm',deferredRender:false,forceLayout:true,frame:true,header:false,autoHeight:true,gpxLayer:this}});this.winGetEle=new GPXEditor1_1.GetMissedElevationWindow({gpxLayer:this});this.winGetEle.on('show',function(){this._featureGetEle=this.selectedElement;},this);this.winGetEle.on('hide',function(){if(this._featureGetEle)this.gpxLayer.events.triggerEvent('featuremodified',{feature:this._featureGetEle});delete this._featureGetEle;},this);},_onBeforeFeatureHighlighted:function(evt){if(this.isAllowEditing())this.highlightedFeature=evt.feature;},_onBeforeFeatureUnhighlighted:function(evt){delete this.highlightedFeature;},getSelectedElement:function(){return this.selectedElement;},setSelectedElement:function(gpxElementRecord){if(this.selectedElement==gpxElementRecord)return;this.selectedElement=gpxElementRecord;this._updateSelectedActions();if(this.selectedElement&&(this.gpxLayer.selectedFeatures.length<0||this.gpxLayer.selectedFeatures[0]!=this.selectedElement.get('feature')))this.selectControl.select(this.selectedElement.get('feature'));this.fireEvent('gpxelementselectionchange',this.selectedElement,this);},_onSelectFeature:function(evt){if(this.selectControl&&this.selectControl.active&&evt.feature){var store=null;if(evt.feature.geometry instanceof OpenLayers.Geometry.Point)store=this.wptStore;else if(evt.feature.geometry instanceof OpenLayers.Geometry.LineString)store=this.rteStore;else if(evt.feature.geometry instanceof OpenLayers.Geometry.MultiLineString)store=this.trkStore;if(store)this.setSelectedElement(store.getRecordFromFeature(evt.feature));}},_onUnselectFeature:function(evt){if(this.selectControl&&this.selectControl.active)this.setSelectedElement(null);},_onElevationNeeded:function(evt){if(evt&&evt.feature&&evt.point)this.winEditElevation.show(evt);}});Ext.reg('gpxe-GPXLayer',GPXEditor1_1.GPXLayer);GPXEditor1_1.GPXLayer.GPX_ACTIONS={LOAD_GPX:'LOAD_GPX',SAVE_GPX:'SAVE_GPX',DEL_GPX:'DEL_GPX',EDIT_WPT:'EDIT_WPT',DEL_WPT:'DEL_WPT',EDIT_RTE:'EDIT_RTE',GET_MISSED_ELE:'GET_MISSED_ELE',DEL_RTE:'DEL_RTE',EDIT_TRK:'EDIT_TRK',DEL_TRK:'DEL_TRK'};GPXEditor1_1.GPXLayer.MAP_ACTIONS={MAP_ZOOM_GPX:'MAP_ZOOM_GPX',MAP_ADD_WPT:'MAP_ADD_WPT',MAP_EDIT_WPT:'MAP_EDIT_WPT',MAP_DEL_WPT:'MAP_DEL_WPT',MAP_ADD_RTE:'MAP_ADD_RTE',MAP_EDIT_RTE:'MAP_EDIT_RTE',MAP_SWAP_RTE:'MAP_SWAP_RTE',MAP_CONV_RTE:'MAP_CONV_RTE',MAP_DEL_RTE:'MAP_DEL_RTE',MAP_EDIT_TRK:'MAP_EDIT_TRK',MAP_DEL_TRK:'MAP_DEL_TRK',MAP_CONV_TRK:'MAP_CONV_TRK'};GPXEditor1_1.GPXLayer.ACTIONS=Ext.apply(Ext.apply({},GPXEditor1_1.GPXLayer.GPX_ACTIONS),GPXEditor1_1.GPXLayer.MAP_ACTIONS);GPXEditor1_1.GPXLayer.LOCALES={ACTION_LOADGPX_TEXT:'ACTION_LOADGPX_TEXT',ACTION_LOADGPX_TOOLTIP:'ACTION_LOADGPX_TOOLTIP',ACTION_SAVEGPX_TEXT:'ACTION_SAVEGPX_TEXT',ACTION_SAVEGPX_TOOLTIP:'ACTION_SAVEGPX_TOOLTIP',ACTION_DELGPX_TEXT:'ACTION_DELGPX_TEXT',ACTION_DELGPX_TOOLTIP:'ACTION_DELGPX_TOOLTIP',ACTION_GET_MISSED_ELEVATION:'ACTION_GET_MISSED_ELEVATION',MAP_ACTION_ZOOMGPX_TEXT:'MAP_ACTION_ZOOMGPX_TEXT',MAP_ACTION_ZOOMGPX_TOOLTIP:'MAP_ACTION_ZOOMGPX_TOOLTIP',MAP_ACTION_ADD_WPT_TEXT:'MAP_ACTION_ADD_WPT_TEXT',MAP_ACTION_ADD_WPT_TOOLTIP:'MAP_ACTION_ADD_WPT_TOOLTIP',MAP_ACTION_EDIT_WPT_TEXT:'MAP_ACTION_EDIT_WPT_TEXT',MAP_ACTION_EDIT_WPT_TOOLTIP:'MAP_ACTION_EDIT_WPT_TOOLTIP',MAP_ACTION_DEL_WPT_TEXT:'MAP_ACTION_DELETE_WPT_TEXT',MAP_ACTION_DEL_WPT_TOOLTIP:'MAP_ACTION_DELETE_WPT_TOOLTIP',MAP_ACTION_ADD_RTE_TEXT:'MAP_ACTION_ADD_RTE_TEXT',MAP_ACTION_ADD_RTE_TOOLTIP:'MAP_ACTION_ADD_RTE_TOOLTIP',MAP_ACTION_EDIT_RTE_TEXT:'MAP_ACTION_EDIT_RTE_TEXT',MAP_ACTION_EDIT_RTE_TOOLTIP:'MAP_ACTION_EDIT_RTE_TOOLTIP',MAP_ACTION_SWAP_RTE_TEXT:'MAP_ACTION_SWAP_RTE_TEXT',MAP_ACTION_SWAP_RTE_TOOLTIP:'MAP_ACTION_SWAP_RTE_TOOLTIP',MAP_ACTION_CONV_RTE_TEXT:'MAP_ACTION_CONV_RTE_TEXT',MAP_ACTION_CONV_RET_TOOLTIP:'MAP_ACITON_CONV_RTE_TOOLTIP',MAP_ACTION_DEL_RTE_TEXT:'MAP_ACTION_DEL_RTE_TEXT',MAP_ACTION_DEL_RTE_TOOLTIP:'MAP_ACTION_DEL_RTE_TOOLTIP',MAP_ACTION_EDIT_TRK_TEXT:'MAP_ACTION_EDIT_TRK_TEXT',MAP_ACTION_EDIT_TRK_TOOLTIP:'MAP_ACTION_EDIT_TRK_TOOLTIP',MAP_ACTION_DEL_TRK_TEXT:'MAP_ACTION_DEL_TRK_TEXT',MAP_ACTION_DEL_TRK_TOOLTIP:'MAP_ACTION_DEL_TRK_TOOLTIP',MAP_ACTION_CONV_TRK_TEXT:'MAP_ACTION_CONV_TRK_TEXT',MAP_ACTION_CONV_TRK_TOOLTIP:'MAP_ACTION_CONV_TRK_TOOLTIP'};
Ext.namespace('GPXEditor1_1.data');GPXEditor1_1.data.GPXElementRecord=GeoExt.data.FeatureRecord.create([{name:'name',type:'string'},{name:'desc',type:'string'}]);GPXEditor1_1.data.GPXElementRecord.prototype.getName=function(){if(this.get('name'))return this.get('name');var ret=this.getRecordName();if(this.store)ret+=' '+(this.store.indexOf(this)+1);return ret;};GPXEditor1_1.data.GPXElementRecord.prototype.getRecordName=function(){return GPXEditor1_1.data.GPXElementRecord.LOCALES.RECORD_NAME;};GPXEditor1_1.data.GPXElementRecord.prototype.updateRecordByGeometryChange=function(){};GPXEditor1_1.data.GPXElementRecord.prototype.updateFeatureStyle=function(){var feature=this.get('feature');if(feature){this.changeFeatureStyle(feature);if(feature.layer)feature.layer.drawFeature(feature);}};GPXEditor1_1.data.GPXElementRecord.prototype.changeFeatureStyle=function(feature){};GPXEditor1_1.data.GPXElementRecord.prototype.cleanBeforeDestroy=function(){};GPXEditor1_1.data.GPXElementRecord.create=function(o){var f=Ext.extend(GPXEditor1_1.data.GPXElementRecord,{});var p=f.prototype;p.fields=new Ext.util.MixedCollection(false,function(field){return field.name;});GPXEditor1_1.data.GPXElementRecord.prototype.fields.each(function(f){p.fields.add(f);});if(o){for(var i=0,len=o.length;i<len;i++){p.fields.add(new Ext.data.Field(o[i]));}}f.getField=function(name){return p.fields.get(name);};return f;};GPXEditor1_1.data.GPXElementRecord.LOCALES={RECORD_NAME:'RECORD_NAME',FIELD_NAME_NAME:'FIELD_NAME_NAME',FIELD_DESC_NAME:'FIELD_DESC_NAME'};
Ext.namespace('GPXEditor1_1.data');GPXEditor1_1.data.WPTRecord=GPXEditor1_1.data.GPXElementRecord.create([{name:'ele',type:'float'},{name:'type',type:'string',defaultValue:'UNKNOW'},{name:'lon',type:'float'},{name:'lat',type:'float'}]);GPXEditor1_1.data.WPTRecord.prototype.getRecordName=function(){return GPXEditor1_1.data.WPTRecord.LOCALES.RECORD_NAME;};GPXEditor1_1.data.WPTRecord.prototype.updateRecordByGeometryChange=function(){var feature=this.get('feature');if(feature){this.beginEdit();if(feature.geometryModified){this.set('lon',null);this.set('lat',null);this.set('ele',null);}else{var ll=new OpenLayers.LonLat(feature.geometry.x,feature.geometry.y);if(feature.layer){ll=ll.transform(feature.layer.projection,feature.layer.displayProjection);}this.beginEdit();this.set('lon',Ext.util.Format.round(ll.lon,GPXEditor1_1.data.WPTRecord.LL_MAX_DIGITS));this.set('lat',Ext.util.Format.round(ll.lat,GPXEditor1_1.data.WPTRecord.LL_MAX_DIGITS));}this.endEdit();this.commit();}};GPXEditor1_1.data.WPTRecord.prototype.updatePositionByLonLat=function(){var ll=new OpenLayers.LonLat(this.get('lon'),this.get('lat'));var feature=this.get('feature');if(feature&&feature.layer){ll=ll.transform(feature.layer.displayProjection,feature.layer.projection);feature.geometry.x=ll.lon;feature.geometry.y=ll.lat;feature.layer.drawFeature(feature);}};GPXEditor1_1.data.WPTRecord.prototype.changeFeatureStyle=function(feature){feature=feature||this.get('feature');if(feature)feature.style=GPXEditor1_1.data.WPTRecord.WPT_STYLES[this.get('type')];};GPXEditor1_1.data.WPTRecord.create=function(o){var f=Ext.extend(GPXEditor1_1.data.WPTRecord,{});var p=f.prototype;p.fields=new Ext.util.MixedCollection(false,function(field){return field.name;});GPXEditor1_1.data.WPTRecord.prototype.fields.each(function(f){p.fields.add(f);});if(o){for(var i=0,len=o.length;i<len;i++){p.fields.add(new Ext.data.Field(o[i]));}}f.getField=function(name){return p.fields.get(name);};return f;};GPXEditor1_1.data.WPTRecord.LL_MAX_DIGITS=7;GPXEditor1_1.data.WPTRecord.WPT_TYPES={UNKNOW:'UNKNOW',PK:'PK',PASS:'PASS',RHSE:'RHSE',WTRW:'WTRW',PKLT:'PKLT'};GPXEditor1_1.data.WPTRecord.WPT_STYLES={UNKNOW:{pointRadius:6,fill:true,fillColor:'#ff0000',fillOpacity:.7},PK:{graphicWidth:12,graphicHeight:12,graphicXOffset:-6,graphicYOffset:-6,externalGraphic:'js/lib/GPXEditor1_1/css/GPXEditor1_1-img/wpt_pk.png'},PASS:{graphicWidth:12,graphicHeight:12,graphicXOffset:-6,graphicYOffset:-6,externalGraphic:'js/lib/GPXEditor1_1/css/GPXEditor1_1-img/wpt_pass.png'},RHSE:{graphicWidth:12,graphicHeight:12,graphicXOffset:-6,graphicYOffset:-6,externalGraphic:'js/lib/GPXEditor1_1/css/GPXEditor1_1-img/wpt_rhse.png'},WTRW:{graphicWidth:12,graphicHeight:12,graphicXOffset:-6,graphicYOffset:-6,externalGraphic:'js/lib/GPXEditor1_1/css/GPXEditor1_1-img/wpt_wtrw.png'},PKLT:{graphicWidth:12,graphicHeight:12,graphicXOffset:-6,graphicYOffset:-6,externalGraphic:'js/lib/GPXEditor1_1/css/GPXEditor1_1-img/wpt_pklt.png'}};GPXEditor1_1.data.WPTRecord.LOCALES=Ext.apply({RECORD_NAME:'RECORD_NAME',FIELD_TYPE_NAME:'FIELD_TYPE_NAME',FIELD_ELE_NAME:'FIELD_ELE_NAME',FIELD_LON_NAME:'FIELD_LON_NAME',FIELD_LAT_NAME:'FIELD_LAT_NAME',WPT_TYPE_UNKNOW:'WPT_TYPE_UNKNOW',WPT_TYPE_PK:'WPT_TYPES_PK',WPT_TYPE_PASS:'WPT_TYPE_PASS',WPT_TYPE_RHSE:'WPT_TYPE_RHSE',WPT_TYPE_WTRW:'WPT_TYPE_WTRW',WPT_TYPE_PKLT:'WPT_TYPE_PKLT'},GPXEditor1_1.data.GPXElementRecord.LOCALES);
Ext.namespace('GPXEditor1_1.data');GPXEditor1_1.data.GPXPathRecord=GPXEditor1_1.data.GPXElementRecord.create([,{name:'numberOfPoints',type:'int'},{name:'distance',type:'float'},{name:'positiveDenivelation',type:'float'},{name:'negativeDenivelation',type:'float'},{name:'minimumElevation',type:'float'},{name:'averageElevation',type:'float'},{name:'maximumElevation',type:'float'}]);GPXEditor1_1.data.GPXPathRecord.prototype.getRecordName=function(){return GPXEditor1_1.data.GPXPathRecord.LOCALES.RECORD_NAME;};GPXEditor1_1.data.GPXPathRecord.prototype.updateRecordByGeometryChange=function(){var feature=this.get('feature');if(feature){if(!(this.statStore instanceof GPXEditor1_1.data.StatStore)){this.statStore=new GPXEditor1_1.data.StatStore({feature:feature});}else{if(feature.geometryModified===true){this.statStore.removeAll();}else{this.statStore.reloadFromFeature();}}this.updateRecordByStats();this.commit();}};GPXEditor1_1.data.GPXPathRecord.prototype.updateRecordByStats=function(){if(!(this.statStore instanceof GPXEditor1_1.data.StatStore)||this.statStore.getCount()<2){this.set('numberOfPoints',null);this.set('distance',null);this.set('positiveDenivelation',null);this.set('negativeDenivelation',null);this.set('minimumElevation',null);this.set('averageElevation',null);this.set('maximumElevation',null);}else{var lastStat=this.statStore.getAt(this.statStore.getTotalCount()-1);this.set('numberOfPoints',this.statStore.getTotalCount());this.set('distance',lastStat.get('totalDistance'));this.set('positiveDenivelation',lastStat.get('totalPositiveDenivelation'));this.set('negativeDenivelation',lastStat.get('totalNegativeDenivelation'));this.set('minimumElevation',lastStat.get('minimumElevation'));this.set('averageElevation',lastStat.get('averageElevation'));this.set('maximumElevation',lastStat.get('maximumElevation'));}};GPXEditor1_1.data.GPXPathRecord.prototype.cleanBeforeDestroy=function(){if(this.statStore)this.statStore.destroy();};GPXEditor1_1.data.GPXPathRecord.create=function(o){var f=Ext.extend(GPXEditor1_1.data.GPXPathRecord,{});var p=f.prototype;p.fields=new Ext.util.MixedCollection(false,function(field){return field.name;});GPXEditor1_1.data.GPXPathRecord.prototype.fields.each(function(f){p.fields.add(f);});if(o){for(var i=0,len=o.length;i<len;i++){p.fields.add(new Ext.data.Field(o[i]));}}f.getField=function(name){return p.fields.get(name);};return f;};GPXEditor1_1.data.GPXPathRecord.LOCALES=Ext.apply({RECORD_NAME:'RECORD_NAME',FIELD_NUMBER_OF_POINTS_NAME:'FIELD_NUMBER_OF_POINTS_NAME',FIELD_NUMBER_OF_POINTS_NAME:'FIELD_NUMBER_OF_POINTS_SHORTNAME',FIELD_DISTANCE_NAME:'FIELD_DISTANCE_NAME',FIELD_DISTANCE_SHORTNAME:'FIELD_DISTANCE_SHORTNAME',FIELD_POSITIVE_DENIVELATION_NAME:'FIELD_POSITIVE_DENIVELATION_NAME',FIELD_POSITIVE_DENIVELATION_SHORTNAME:'FIELD_POSITIVE_DENIVELATION_SHORTNAME',FIELD_NEGATIVE_DENIVELATION_NAME:'FIELD_NEGATIVE_DENIVELATION_NAME',FIELD_NEGATIVE_DENIVELATION_SHORTNAME:'FIELD_NEGATIVE_DENIVELATION_SHORTNAME',FIELD_MINIMUM_ELEVATION_NAME:'FIELD_MINIMUM_ELEVATION_NAME',FIELD_MINIMUM_ELEVATION_SHORTNAME:'FIELD_MINIMUM_ELEVATION_SHORTNAME',FIELD_AVERAGE_ELEVATION_NAME:'FIELD_AVERAGE_ELEVATION_NAME',FIELD_AVERAGE_ELEVATION_SHORTNAME:'FIELD_AVERAGE_ELEVATION_SHORTNAME',FIELD_MAXIMUM_ELEVATION_NAME:'FIELD_MAXIMUM_ELEVATION_NAME',FIELD_MAXIMUM_ELEVATION_SHORTNAME:'FIELD_MAXIMUM_ELEVATION_SHORTNAME',ELEVATION:'ELEVATION',MIN_AVR_MAX:'MIN_AVR_MAX'},GPXEditor1_1.data.GPXElementRecord.LOCALES);
Ext.namespace('GPXEditor1_1.data');GPXEditor1_1.data.RTERecord=GPXEditor1_1.data.GPXPathRecord.create([]);GPXEditor1_1.data.RTERecord.prototype.getRecordName=function(){return GPXEditor1_1.data.RTERecord.LOCALES.RECORD_NAME;};GPXEditor1_1.data.RTERecord.prototype.changeFeatureStyle=function(feature){feature=feature||this.get('feature');if(feature)feature.style=GPXEditor1_1.data.RTERecord.RTE_STYLE;};GPXEditor1_1.data.RTERecord.create=function(o){var f=Ext.extend(GPXEditor1_1.data.RTERecord,{});var p=f.prototype;p.fields=new Ext.util.MixedCollection(false,function(field){return field.name;});GPXEditor1_1.data.RTERecord.prototype.fields.each(function(f){p.fields.add(f);});if(o){for(var i=0,len=o.length;i<len;i++){p.fields.add(new Ext.data.Field(o[i]));}}f.getField=function(name){return p.fields.get(name);};return f;};GPXEditor1_1.data.RTERecord.RTE_STYLE={strokeColor:'#ffff00',strokeWidth:3,strokeOpacity:.7};GPXEditor1_1.data.RTERecord.LOCALES=Ext.apply({RECORD_NAME:'RECORD_NAME'},GPXEditor1_1.data.GPXPathRecord.LOCALES);
Ext.namespace('GPXEditor1_1.data');GPXEditor1_1.data.TRKRecord=GPXEditor1_1.data.GPXPathRecord.create([{name:'numberOfSignalLost',type:'int'},{name:'duration',type:'float'},{name:'breakDuration',type:'float'},{name:'minimumSpeedDistance',type:'float'},{name:'averageSpeedDistance',type:'float'},{name:'maximumSpeedDistance',type:'float'},{name:'positiveDenivelationDuration',type:'float'},{name:'minimumSpeedPositiveDenivelation',type:'float'},{name:'averageSpeedPositiveDenivealtion',type:'float'},{name:'maximumSpeedPositiveDenivelation',type:'float'},{name:'negativeDenivelationDuration',type:'float'},{name:'minimumSpeedNegativeDenivelation',type:'float'},{name:'averageSpeedNegativeDenivealtion',type:'float'},{name:'maximumSpeedNegativeDenivelation',type:'float'}]);GPXEditor1_1.data.TRKRecord.prototype.getRecordName=function(){return GPXEditor1_1.data.TRKRecord.LOCALES.RECORD_NAME;};GPXEditor1_1.data.TRKRecord.prototype.changeFeatureStyle=function(feature){feature=feature||this.get('feature');if(feature)feature.style=GPXEditor1_1.data.TRKRecord.TRK_STYLE;};GPXEditor1_1.data.TRKRecord.prototype.updateRecordByStats=function(){GPXEditor1_1.data.TRKRecord.superclass.updateRecordByStats.call(this);if(!(this.statStore instanceof GPXEditor1_1.data.StatStore)||this.statStore.getCount()<2){this.set('numberOfSignalLost',null);this.set('duration',null);this.set('breakDuration',null);this.set('minimumSpeedDistance',null);this.set('averageSpeedDistance',null);this.set('maximumSpeedDistance',null);this.set('positiveDenivelationDuration',null);this.set('minimumSpeedPositiveDenivelation',null);this.set('averageSpeedPositiveDenivealtion',null);this.set('maximumSpeedPositiveDenivelation',null);this.set('negativeDenivelationDuration',null);this.set('minimumSpeedNegativeDenivelation',null);this.set('averageSpeedNegativeDenivealtion',null);this.set('maximumSpeedNegativeDenivelation',null);}else{var lastStat=this.statStore.getAt(this.statStore.getTotalCount()-1);this.set('numberOfSignalLost',this.get('feature').geometry.components.length);this.set('duration',lastStat.get('totalDuration'));this.set('breakDuration',null);this.set('minimumSpeedDistance',null);this.set('averageSpeedDistance',null);this.set('maximumSpeedDistance',null);this.set('positiveDenivelationDuration',lastStat.get('positiveDenivelationDuration'));this.set('minimumSpeedPositiveDenivelation',null);this.set('averageSpeedPositiveDenivealtion',null);this.set('maximumSpeedPositiveDenivelation',null);this.set('negativeDenivelationDuration',lastStat.get('negativeDenivelationDuration'));this.set('minimumSpeedNegativeDenivelation',null);this.set('averageSpeedNegativeDenivealtion',null);this.set('maximumSpeedNegativeDenivelation',null);}};GPXEditor1_1.data.TRKRecord.create=function(o){var f=Ext.extend(GPXEditor1_1.data.TRKRecord,{});var p=f.prototype;p.fields=new Ext.util.MixedCollection(false,function(field){return field.name;});GPXEditor1_1.data.TRKRecord.prototype.fields.each(function(f){p.fields.add(f);});if(o){for(var i=0,len=o.length;i<len;i++){p.fields.add(new Ext.data.Field(o[i]));}}f.getField=function(name){return p.fields.get(name);};return f;};GPXEditor1_1.data.TRKRecord.TRK_STYLE={strokeColor:'#ff00ff',strokeWidth:3,strokeOpacity:.7};GPXEditor1_1.data.TRKRecord.LOCALES=Ext.apply({RECORD_NAME:'RECORD_NAME',FIELD_NUMBER_OF_SIGNAL_LOST_NAME:'FIELD_NUMBER_OF_SIGNAL_LOST_NAME',FIELD_NUMBER_OF_SIGNAL_LOST_SHORTNAME:'FIELD_NUMBER_OF_SIGNAL_LOST_SHORTNAME',FIELD_DURATION_NAME:'FIELD_DURATION_NAME',FIELD_BREAK_DURATION_NAME:'FIELD_BREAK_DURATION_NAME',FIELD_MINIMUM_SPEED_DISTANCE_NAME:'FIELD_MINIMUM_SPEED_DISTANCE_NAME',FIELD_MINIMUM_SPEED_DISTANCE_SHORTNAME:'FIELD_MINIMUM_SPEED_DISTANCE_SHORTNAME',FIELD_AVERAGE_SPEED_DISTANCE_NAME:'FIELD_AVERAGE_SPEED_DISTANCE_NAME',FIELD_AVERAGE_SPEED_DISTANCE_SHORTNAME:'FIELD_AVERAGE_SPEED_DISTANCE_SHORTNAME',FIELD_MAXIMUM_SPEED_DISTANCE_NAME:'FIELD_MAXIMUM_SPEED_DISTANCE_NAME',FIELD_MAXIMUM_SPEED_DISTANCE_SHORTNAME:'FIELD_MAXIMUM_SPEED_DISTANCE_SHORTNAME',FIELD_POSITIVE_DENIVELATION_DURATION_NAME:'FIELD_POSITIVE_DENIVELATION_DURATION_NAME',FIELD_POSITIVE_DENIVELATION_DURATION_SHORTNAME:'FIELD_POSITIVE_DENIVELATION_DURATION_SHORTNAME',FIELD_MINIMUM_SPEED_POSITIVE_DENIVELATION_NAME:'FIELD_MINIMUM_SPEED_POSITIVE_DENIVELATION_NAME',FIELD_MINIMUM_SPEED_POSITIVE_DENIVELATION_SHORTNAME:'FIELD_MINIMUM_SPEED_POSITIVE_DENIVELATION_SHORTNAME',FIELD_AVERAGE_SPEED_POSITIVE_DENIVELATION_NAME:'FIELD_AVERAGE_SPEED_POSITIVE_DENIVELATION_NAME',FIELD_AVERAGE_SPEED_POSITIVE_DENIVELATION_SHORTNAME:'FIELD_AVERAGE_SPEED_POSITIVE_DENIVELATION_SHORTNAME',FIELD_MAXIMUM_SPEED_POSITIVE_DENIVELATION_NAME:'FIELD_MAXIMUM_SPEED_POSITIVE_DENIVELATION_NAME',FIELD_MAXIMUM_SPEED_POSITIVE_DENIVELATION_SHORTNAME:'FIELD_MAXIMUM_SPEED_POSITIVE_DENIVELATION_SHORTNAME',FIELD_POSITIVE_NEGATIVE_DURATION_NAME:'FIELD_NEGATIVE_DENIVELATION_DURATION_NAME',FIELD_POSITIVE_NEGATIVE_DURATION_SHORTNAME:'FIELD_NEGATIVE_DENIVELATION_DURATION_SHORTNAME',FIELD_MINIMUM_SPEED_NEGATIVE_DENIVELATION_NAME:'FIELD_MINIMUM_SPEED_NEGATIVE_DENIVELATION_NAME',FIELD_MINIMUM_SPEED_NEGATIVE_DENIVELATION_SHORTNAME:'FIELD_MINIMUM_SPEED_NEGATIVE_DENIVELATION_SHORTNAME',FIELD_AVERAGE_SPEED_NEGATIVE_DENIVELATION_NAME:'FIELD_AVERAGE_SPEED_NEGATIVE_DENIVELATION_NAME',FIELD_AVERAGE_SPEED_NEGATIVE_DENIVELATION_SHORTNAME:'FIELD_AVERAGE_SPEED_NEGATIVE_DENIVELATION_SHORTNAME',FIELD_MAXIMUM_SPEED_NEGATIVE_DENIVELATION_NAME:'FIELD_MAXIMUM_SPEED_NEGATIVE_DENIVELATION_NAME',FIELD_MAXIMUM_SPEED_NEGATIVE_DENIVELATION_SHORTNAME:'FIELD_MAXIMUM_SPEED_NEGATIVE_DENIVELATION_SHORTNAME'},GPXEditor1_1.data.GPXPathRecord.LOCALES);
Ext.namespace('GPXEditor1_1.data');GPXEditor1_1.data.GPXElementStore=Ext.extend(GeoExt.data.FeatureStore,{gpxLayer:undefined,constructor:function(config){config=config||{};if(!'gpxLayer' in config||!(config.gpxLayer instanceof GPXEditor1_1.GPXLayer))this.gpxLayer=new GPXEditor1_1.GPXLayer();else
this.gpxLayer=config.gpxLayer;delete config.gpxLayer;Ext.applyIf(config,{layer:this.gpxLayer.gpxLayer,reader:new GeoExt.data.FeatureReader({},GPXEditor1_1.data.GPXElementRecord),addRecordFilter:function(record){return(record instanceof GPXEditor1_1.data.GPXElementRecord);},addFeatureFilter:function(feature){if(!feature)return false;return(feature.geometry instanceof OpenLayers.Geometry.Point)||(feature.geometry instanceof OpenLayers.Geometry.LineString)||(feature.geometry instanceof OpenLayers.Geometry.MultiLineString);}});GPXEditor1_1.data.GPXElementStore.superclass.constructor.call(this,config);this.on('remove',function(store,record,index){record.cleanBeforeDestroy();},this);},getGPXLayer:function(){return this.gpxLayer;},add:function(records){for(var i=0,len=records.length;i<len;i++){if(records[i]instanceof this.recordType){records[i].updateFeatureStyle();records[i].updateRecordByGeometryChange();}}GPXEditor1_1.data.GPXElementStore.superclass.add.call(this,records);},getRecordFromFeature:function(feature){var record=GPXEditor1_1.data.GPXElementStore.superclass.getRecordFromFeature.call(this,feature);return record?record:undefined;},bind:function(layer,options){GPXEditor1_1.data.GPXElementStore.superclass.bind.call(this,layer,options);layer.events.on({'vertexmodified':this.onVertexModified,'sketchmodified':this.onSketchModified,'afterfeaturemodified':this.onAfterFeatureModified,scope:this});},unbind:function(){if(this.layer){this.layer.events.un({'vertexmodified':this.onVertexModified,'sketchmodified':this.onSketchModified,'afterfeaturemodified':this.onAfterFeatureModified,scope:this})}GPXEditor1_1.data.GPXElementStore.superclass.bind.call(this);},onVertexModified:function(evt){this._markGeometryChangedInRecord(evt.feature);},onSketchModified:function(evt){this._markGeometryChangedInRecord(evt.feature);},_markGeometryChangedInRecord:function(feature){if(!feature.geometryModified){if((typeof this.addFeatureFilter!="function")||(this.addFeatureFilter(feature)!==false)){feature.geometryModified=true;var record=this.getRecordFromFeature(feature);if(record)record.updateRecordByGeometryChange();}}},onFeatureModified:function(evt){},onAfterFeatureModified:function(evt){var feature=evt.feature;if(feature.geometryModified){if((typeof this.addFeatureFilter!="function")||(this.addFeatureFilter(feature)!==false)){feature.geometryModified=false;var record=this.getRecordFromFeature(feature);if(record)record.updateRecordByGeometryChange();}}}});
Ext.namespace('GPXEditor1_1.data');GPXEditor1_1.data.WPTStore=Ext.extend(GPXEditor1_1.data.GPXElementStore,{constructor:function(config){config=config||{};Ext.applyIf(config,{reader:new GeoExt.data.FeatureReader({},GPXEditor1_1.data.WPTRecord),addRecordFilter:function(record){return(record instanceof GPXEditor1_1.data.WPTRecord);},addFeatureFilter:function(feature){if(!feature)return false;return(feature.geometry instanceof OpenLayers.Geometry.Point);}});GPXEditor1_1.data.WPTStore.superclass.constructor.call(this,config);},onUpdate:function(store,record,operation){if(!this._updating){var feature=record.get('feature');if(!feature.geometryModified){var changes=record.getChanges();if('type' in changes)record.updateFeatureStyle();if('lon' in changes||'lat' in changes)record.updatePositionByLonLat();}}GPXEditor1_1.data.WPTStore.superclass.onUpdate.call(this,store,record,operation);}});
Ext.namespace('GPXEditor1_1.data');GPXEditor1_1.data.GPXPathStore=Ext.extend(GPXEditor1_1.data.GPXElementStore,{constructor:function(config){config=config||{};Ext.applyIf(config,{reader:new GeoExt.data.FeatureReader({},GPXEditor1_1.data.GPXPathRecord),addRecordFilter:function(record){return(record instanceof GPXEditor1_1.data.GPXPathRecord);},addFeatureFilter:function(feature){if(!feature)return false;return(feature.geometry instanceof OpenLayers.Geometry.LineString)||(feature.geometry instanceof OpenLayers.Geometry.MultiLineString);}});GPXEditor1_1.data.GPXPathStore.superclass.constructor.call(this,config);}});
Ext.namespace('GPXEditor1_1.data');GPXEditor1_1.data.RTEStore=Ext.extend(GPXEditor1_1.data.GPXPathStore,{constructor:function(config){config=config||{};Ext.applyIf(config,{reader:new GeoExt.data.FeatureReader({},GPXEditor1_1.data.RTERecord),addRecordFilter:function(record){return(record instanceof GPXEditor1_1.data.RTERecord);},addFeatureFilter:function(feature){if(!feature)return false;return(feature.geometry instanceof OpenLayers.Geometry.LineString);}});GPXEditor1_1.data.RTEStore.superclass.constructor.call(this,config);}});
Ext.namespace('GPXEditor1_1.data');GPXEditor1_1.data.TRKStore=Ext.extend(GPXEditor1_1.data.GPXPathStore,{constructor:function(config){config=config||{};Ext.applyIf(config,{reader:new GeoExt.data.FeatureReader({},GPXEditor1_1.data.TRKRecord),addRecordFilter:function(record){return(record instanceof GPXEditor1_1.data.TRKRecord);},addFeatureFilter:function(feature){if(!feature)return false;return(feature.geometry instanceof OpenLayers.Geometry.MultiLineString);}});GPXEditor1_1.data.TRKStore.superclass.constructor.call(this,config);}});
Ext.namespace('GPXEditor1_1.data');GPXEditor1_1.data.StatStore=Ext.extend(Ext.data.JsonStore,{feature:undefined,projection:undefined,constructor:function(config){this.LOCALES=GPXEditor1_1.data.StatStore.LOCALES;this.projection=new OpenLayers.Projection('EPSG:4326');config=config||{};Ext.applyIf(config,{root:'points',fields:[{name:'point'},{name:'ll'},{name:'elevation',type:'float'},{name:'computedElevation',type:'float'},{name:'minimumElevation',type:'float'},{name:'averageElevation',type:'float'},{name:'maximumElevation',type:'float'},{name:'flatDistance',type:'float'},{name:'totalFaltDistance',type:'float'},{name:'distance',type:'float'},{name:'totalDistance',type:'float'},{name:'positiveDenivelation',type:'float'},{name:'totalPositiveDenivelation',type:'float'},{name:'negativeDenivelation',type:'float'},{name:'totalNegativeDenivelation',type:'float'},{name:'heading',type:'float'},{name:'dateTime',type:'date'},{name:'computedDateTime',type:'date'},{name:'duration',type:'float'},{name:'totalDuration',type:'float'},{name:'breakDuration',type:'float'},{name:'minimumSpeedDistance',type:'float'},{name:'averageSpeedDistance',type:'float'},{name:'maximumSpeedDistance',type:'float'},{name:'positiveDenivelationDuration',type:'float'},{name:'minimumSpeedPositiveDenivelation',type:'float'},{name:'averageSpeedPositiveDenivealtion',type:'float'},{name:'maximumSpeedPositiveDenivelation',type:'float'},{name:'negativeDenivelationDuration',type:'float'},{name:'minimumSpeedNegativeDenivelation',type:'float'},{name:'averageSpeedNegativeDenivealtion',type:'float'},{name:'maximumSpeedNegativeDenivelation',type:'float'}]});GPXEditor1_1.data.StatStore.superclass.constructor.call(this,config);this.setFeature(this.feature);},reloadFromFeature:function(){this.setFeature(this.feature);},setFeature:function(feature){this.feature=feature;var points=[];if(this.feature){var vertices=[];if(feature.geometry instanceof OpenLayers.Geometry.LineString){var lv=feature.geometry.getVertices();for(var i=0,len=lv.length;i<len;i++)vertices.push(lv[i]);}else if(feature.geometry instanceof OpenLayers.Geometry.MultiLineString){for(var i=0;i<feature.geometry.components.length;i++){var lv=feature.geometry.components[i].getVertices();for(var j=0,len=lv.length;j<len;j++)vertices.push(lv[j]);}}for(var i=0;i<vertices.length;i++){points.push({point:vertices[i],ll:null,elevation:0,computedElevation:0,minimumElevation:0,averageElevation:0,maximumElevation:0,flatDistance:0.0,totalFaltDistance:0.0,distance:0.0,totalDistance:0.0,positiveDenivelation:0,totalPositiveDenivelation:0,negativeDenivelation:0,totalNegativeDenivelation:0,heading:0,dateTime:null,computedDateTime:null,duration:0.0,totalDuration:0.0,breakDuration:0.0,minimumSpeedDistance:0.0,averageSpeedDistance:0.0,maximumSpeedDistance:0.0,positiveDenivelationDuration:0.0,minimumSpeedPositiveDenivelation:0.0,averageSpeedPositiveDenivealtion:0.0,maximumSpeedPositiveDenivelation:0.0,negativeDenivelationDuration:0.0,minimumSpeedNegativeDenivelation:0.0,averageSpeedNegativeDenivealtion:0.0,maximumSpeedNegativeDenivelation:0.0});}}this.loadData({points:points});this.refreshStats();},getFeature:function(){return this.feature;},refreshStats:function(){if(!this.feature)return;var nbPoints=this.getTotalCount();var last=null;var lastWithEle=null;var lastWithDateTime=null;var durationEnabled=true;var ptCurIdx=0;this.each(function(record){ptCurIdx++;var index=this.indexOf(record);var point=record.get('point');var ll=new OpenLayers.LonLat(point.x,point.y);ll=ll.transform(this.feature.layer.projection,this.projection);record.set('ll',ll);record.set('flatDistance',last?OpenLayers.Util.distanceBetweenLonLat(last.get('ll'),record.get('ll')):0);record.set('totalFaltDistance',last?last.get('totalFaltDistance')+record.get('flatDistance'):0);record.set('elevation',point.ele?point.ele:null);if(record.get('elevation')||index==nbPoints-1){var lastIndex=0;var lastElevation=0;var lastTotalFlatDistance=0;if(lastWithEle){lastIndex=this.indexOf(lastWithEle);lastElevation=lastWithEle.get('elevation');lastTotalFlatDistance=lastWithEle.get('totalFaltDistance');}var curIndex=this.indexOf(record);var curTotalFlatDistance=record.get('totalFaltDistance');for(var i=curIndex-1;i>lastIndex;i--){pRecord=this.getAt(i);pRecord.set('computedElevation',Math.round(((record.get('elevation')-lastElevation)*(pRecord.get('totalFaltDistance')-lastTotalFlatDistance)/(curTotalFlatDistance-lastTotalFlatDistance))+lastElevation));}lastWithEle=record;}if(last)last.set('heading',OpenLayers.Util.headingBetweenLonLat(last.get('ll'),record.get('ll')));record.set('dateTime',point.time?point.time:null);if(record.get('dateTime')){lastWithDateTime=record;}else{durationEnabled=false;}last=record;},this);last=null;var nbView=0;var averageElevationSum=0;var ptIdx=0;var lastDenivelationType=0;this.each(function(record){if(last){var lastEle=last.get('elevation')||last.get('computedElevation');var ele=record.get('elevation')||record.get('computedElevation');if(durationEnabled){record.set('duration',last.get('dateTime').getElapsed(record.get('dateTime')));record.set('totalDuration',last.get('totalDuration')+record.get('duration'));record.set('positiveDenivelationDuration',last.get('positiveDenivelationDuration'));record.set('negativeDenivelationDuration',last.get('negativeDenivelationDuration'));}if(lastEle<ele){record.set('positiveDenivelation',ele-lastEle);record.set('distance',Math.sqrt(Math.pow((ele-lastEle),2)+Math.pow(record.get('flatDistance'),2)));lastDenivelationType='POS';}else{record.set('negativeDenivelation',lastEle-ele);record.set('distance',Math.sqrt(Math.pow((lastEle-ele),2)+Math.pow(record.get('flatDistance'),2)));if(lastEle>ele)lastDenivelationType='NEG';}if(durationEnabled){if(lastDenivelationType=='POS')record.set('positiveDenivelationDuration',last.get('positiveDenivelationDuration')+record.get('duration'));else
record.set('negativeDenivelationDuration',last.get('negativeDenivelationDuration')+record.get('duration'));}record.set('totalDistance',last.get('totalDistance')+record.get('distance'));record.set('totalPositiveDenivelation',last.get('totalPositiveDenivelation')+record.get('positiveDenivelation'));record.set('totalNegativeDenivelation',last.get('totalNegativeDenivelation')+record.get('negativeDenivelation'));record.set('minimumElevation',(ele<last.get('minimumElevation')?ele:last.get('minimumElevation')));averageElevationSum+=ele;record.set('averageElevation',(averageElevationSum/(nbView+1)));record.set('maximumElevation',(ele>last.get('maximumElevation')?ele:last.get('maximumElevation')));}else{var ele=record.get('elevation')||record.get('computedElevation');record.set('minimumElevation',ele);record.set('averageElevation',ele);record.set('maximumElevation',ele);averageElevationSum=ele;if(durationEnabled){record.set('duration',0.0);record.set('totalDuration',0.0);record.set('positiveDenivelationDuration',0.0);record.set('negativeDenivelationDuration',0.0);}}last=record;nbView++;ptIdx++;},this);this.commitChanges();}});GPXEditor1_1.data.StatStore.LOCALES={ELEVATION:'ELEVATION',DISTANCE:'DISTANCE',POSITIVE_DENIVELATION:'POSITIVE_DENIVELATION',NEGATIVE_DENIVELATION:'NEGATIVE_DENIVELATION',DURATION:'DURATION'};
Ext.namespace('GPXEditor1_1.form');GPXEditor1_1.form.FormWindow=Ext.extend(Ext.Window,{initComponent:function(){if(this.formPanel){if(!(this.formPanel instanceof Ext.form.FormPanel))this.formPanel=Ext.create(this.formPanel);Ext.applyIf(this,{title:this.formPanel.title,iconCls:this.formPanel.iconCls});this.getForm().on('actioncomplete',function(){this.hide();},this);}Ext.apply(this,{forceLayout:true,autoHeight:true,resizable:false,closeAction:'hide',border:false,bodyBorder:false,plain:true,layout:'fit',items:[this.formPanel]});GPXEditor1_1.form.FormWindow.superclass.initComponent.call(this);this.on('beforeshow',function(){if(this.formPanel)this.formPanel.fireEvent('beforeshow',this.form);},this);},getFormPanel:function(){return this.formPanel;},getForm:function(){if(this.formPanel)return this.formPanel.getForm();return null;},show:function(openConfig){this.getFormPanel().setOpenConfig(openConfig);GPXEditor1_1.form.FormWindow.superclass.show.call(this);}});Ext.reg('gpxe-FormWindow',GPXEditor1_1.form.FormWindow);
Ext.namespace('GPXEditor1_1.form');GPXEditor1_1.form.ImportForm=Ext.extend(Ext.form.FormPanel,{gpxLayer:undefined,fuFile:undefined,tfURL:undefined,sMode:undefined,cbLoadMode:undefined,bLoad:undefined,bImport:undefined,lastBtAction:undefined,initComponent:function(){Ext.applyIf(this,{LOCALES:GPXEditor1_1.form.ImportForm.LOCALES});if(!(this.gpxLayer instanceof GPXEditor1_1.GPXLayer))this.gpxLayer=new GPXEditor1_1.GPXLayer();this.MODE=GPXEditor1_1.form.ImportForm.MODE;this.fuFile=new Ext.ux.form.FileUploadField({name:'file',hiddenName:'file',fieldLabel:this.LOCALES.FILE_FIELD_LABEL,emptyText:this.LOCALES.FILE_FIELD_EMPTYTEXT,buttonText:'...',allowBlank:false});this.tfURL=new Ext.form.TextField({name:'url',fieldLabel:this.LOCALES.URL_FIELD_LABEL,emptyText:this.LOCALES.URL_FIELD_EMPTYTEXT,disabled:true,allowBlank:false});this.sMode=new Ext.data.ArrayStore({id:0,fields:['id','text'],data:[[this.MODE.FILE,this.LOCALES.MODE_FILE_TEXT],[this.MODE.URL,this.LOCALES.MODE_URL_TEXT]]});this.cbLoadMode=new Ext.form.ComboBox({selectOnFocus:true,editable:false,forceSelection:true,lazyRender:true,typeAhead:true,triggerAction:'all',mode:'local',store:this.sMode,valueField:'id',displayField:'text',value:this.sMode.getAt(0).get('id'),name:'mode',hiddenName:'mode',fieldLabel:this.LOCALES.MODE_FIELD_LABEL});this.bLoad=new Ext.Button({text:this.LOCALES.ACTION_LOAD_TEXT,tooltip:this.LOCALES.ACTION_LOAD_TOOLTIP,iconCls:'gpxe-GPXFileLoadIcon',disabled:true,handler:this.doLoad,scope:this,formBind:true});this.bImport=new Ext.Button({text:this.LOCALES.ACTION_IMPORT_TEXT,tooltip:this.LOCALES.ACTION_IMPORT_TOOLTIP,iconCls:'gpxe-GPXFileImportIcon',disabled:true,handler:this.doLoad,scope:this,formBind:true});Ext.apply(this,{title:this.LOCALES.TITLE,iconCls:'gpxe-AddFileIcon',monitorValid:true,fileUpload:true,frame:true,autoHeight:true,autoWidth:true,defaults:{allowBlank:false,anchor:'100%',msgTarget:'qtip'},items:[this.cbLoadMode,this.fuFile,this.tfURL,{xtype:'fieldset',title:this.LOCALES.OPTIONS_FIELDSET_TITLE,autoHeight:true,defaultType:'checkbox',hideLabels:true,defaults:{checked:true},items:[{name:'doWpts',boxLabel:this.LOCALES.DOWPTS_FIELD_BOXLABEL},{name:'doRtes',boxLabel:this.LOCALES.DORTES_FIELD_BOXLABEL},{name:'doTrks',boxLabel:this.LOCALES.DOTRKS_FIELD_BOXLABEL}]}],buttons:[this.bLoad,this.bImport]});GPXEditor1_1.form.ImportForm.superclass.initComponent.call(this);this.addEvents({'load':true,'import':true});this.cbLoadMode.on('select',function(combo,record,index){if(record.get('id')==this.MODE.FILE){this.fuFile.enable();this.tfURL.disable();this.tfURL.setValue(null);}else if(record.get('id')==this.MODE.URL){this.tfURL.enable();this.fuFile.disable();if(this.fuFile.fileInput)this.fuFile.reset();}},this);this.on('clientvalidation',function(form,isValid){var form=this.getForm();if(form.findField('doWpts').getValue()==false&&form.findField('doRtes').getValue()==false&&form.findField('doTrks').getValue()==false)isValid=false;if(isValid){this.bLoad.enable();this.bImport.enable();}else{this.bLoad.disable();this.bImport.disable();}return isValid;},this);this.getForm().on('beforeaction',function(form,action){Ext.apply(action,{handleResponse:function(response){if(this.form.errorReader){var rs=this.form.errorReader.read(response);var errors=[];if(rs.records){for(var i=0,len=rs.records.length;i<len;i++){var r=rs.records[i];errors[i]=r.data;}}if(errors.length<1){errors=null;}return{success:rs.success,errors:errors};}if(response.responseXML&&response.responseXML.documentElement&&response.responseXML.documentElement.localName=='gpx')return{success:true,gpxData:response.responseXML};return Ext.decode(response.responseText);}});},this);},setOpenConfig:function(openConfig){if(this.fuFile.fileInput)this.fuFile.reset();this.tfURL.setValue(null);},doLoad:function(bt){if(this.getForm().isValid()){this.lastBtAction=bt;this.getForm().submit({url:'gpxfileLoad.php',waitMsg:this.LOCALES.WAIT_MESSAGE,success:this.submitSuccess,failure:this.submitFailure,scope:this});}},submitSuccess:function(form,action){if(!action.result.success||!action.result.gpxData)this.submitFailure(form,action);else{var options={extractWaypoints:form.findField('doWpts').getValue(),extractRoutes:form.findField('doRtes').getValue(),extractTracks:form.findField('doTrks').getValue()};if(this.lastBtAction==this.bLoad)this.gpxLayer.loadGPXDoc(action.result.gpxData,options);else
this.gpxLayer.importGPXDoc(action.result.gpxData,options);}},submitFailure:function(form,action){var errorMsg=this.LOCALES[action.result.error];if(!errorMsg)errorMsg=this.LOCALES.MSG_ERROR_NOT_VALID_XML;Ext.Msg.show({title:this.LOCALES.ERROR_TITLE,msg:errorMsg,buttons:Ext.Msg.OK,icon:Ext.MessageBox.ERROR});}});Ext.reg('gpxe-ImportForm',GPXEditor1_1.form.ImportForm);GPXEditor1_1.form.ImportForm.MODE={FILE:'FILE',URL:'URL'};GPXEditor1_1.form.ImportForm.LOCALES={TITLE:'TITLE',FILE_FIELD_LABEL:'FILE_FIELD_LABEL',FILE_FIELD_EMPTYTEXT:'FILE_FIELD_EMPTYTEXT',URL_FIELD_LABEL:'URL_FIELD_LABEL',URL_FIELD_EMPTYTEXT:'URL_FIELD_EMPTYTEXT',MODE_FILE_TEXT:'MODE_FILE_TEXT',MODE_URL_TEXT:'MODE_URL_TEXT',MODE_FIELD_LABEL:'MODE_FIELD_LABEL',OPTIONS_FIELDSET_TITLE:'OPTIONS_FIELDSET_TITLE',DOWPTS_FIELD_BOXLABEL:'DOWPTS_FIELD_BOXLABEL',DORTES_FIELD_BOXLABEL:'DORTES_FIELD_BOXLABEL',DOTRKS_FIELD_BOXLABEL:'DOTRKS_FIELD_BOXLABEL',ACTION_LOAD_TEXT:'ACTION_LOAD_TEXT',ACTION_LOAD_TOOLTIP:'ACTION_LOAD_TOOLTIP',ACTION_IMPORT_TEXT:'ACTION_IMPORT_TEXT',ACTION_IMPORT_TOOLTIP:'ACTION_IMPORT_TOOLTIP',ERROR_TITLE:'ERROR_TITLE',MSG_ERROR_ONLY_LOCAL_REQUEST:'MSG_ERROR_ONLY_LOCAL_REQUEST',MSG_ERROR_NO_FILE_OR_URL:'MSG_ERROR_NO_FILE_OR_URL',MSG_ERROR_NOT_VALID_XML:'MSG_ERROR_NOT_VALID_XML',WAIT_MESSAGE:'WAIT_MESSAGE'};
Ext.namespace('GPXEditor1_1.form');GPXEditor1_1.form.ExportForm=Ext.extend(Ext.form.FormPanel,{gpxLayer:undefined,tfFilename:undefined,hXMLDoc:undefined,bSave:undefined,gpxIO:undefined,initComponent:function(){Ext.applyIf(this,{LOCALES:GPXEditor1_1.form.ExportForm.LOCALES});this.gpxIO=new OpenLayers.Format.GPXEditorIO();this.tfFilename=new Ext.form.TextField({name:'filename',fieldLabel:this.LOCALES.FILENAME_FIELD_LABEL,emptyText:this.LOCALES.FILENAME_FIELD_EMPTYTEXT,allowBlank:false});this.hXMLDoc=new Ext.form.Hidden({name:'xmldoc'});this.bSave=new Ext.Button({text:this.LOCALES.ACTION_SAVE_TEXT,tooltip:this.LOCALES.ACTION_SAVE_TOOLTIP,iconCls:'gpxe-GPXFileSaveIcon',disabled:true,handler:this.doSave,scope:this,formBind:true});Ext.apply(this,{title:this.LOCALES.TITLE,iconCls:'gpxe-SaveFileIcon',url:'gpxfileSave.php',method:'POST',monitorValid:true,frame:true,autoHeight:true,autoWidth:true,defaults:{allowBlank:false,anchor:'100%'},items:[this.hXMLDoc,this.tfFilename,{xtype:'fieldset',title:this.LOCALES.OPTIONS_FIELDSET_TITLE,autoHeight:true,defaultType:'checkbox',hideLabels:true,defaults:{checked:true},items:[{name:'doWpts',boxLabel:this.LOCALES.DOWPTS_FIELD_BOXLABEL},{name:'doRtes',boxLabel:this.LOCALES.DORTES_FIELD_BOXLABEL},{name:'doTrks',boxLabel:this.LOCALES.DOTRKS_FIELD_BOXLABEL}]}],buttons:[this.bSave]});GPXEditor1_1.form.ExportForm.superclass.initComponent.call(this);this.getForm().standardSubmit=true;this.on('clientvalidation',function(form,isValid){var f=this.getForm();if(f.findField('doWpts').getValue()==false&&f.findField('doRtes').getValue()==false&&f.findField('doTrks').getValue()==false)isValid=false;if(isValid){this.bSave.enable();}else{this.bSave.disable();}return isValid;},this);},setOpenConfig:function(openConfig){this.tfFilename.setValue(null);this.hXMLDoc.setValue(null);var form=this.getForm();if(this.gpxLayer.getNbWpts()>0){form.findField('doWpts').setValue(true);form.findField('doWpts').setDisabled(false);}else{form.findField('doWpts').setValue(false);form.findField('doWpts').setDisabled(true);}if(this.gpxLayer.getNbRtes()>0){form.findField('doRtes').setValue(true);form.findField('doRtes').setDisabled(false);}else{form.findField('doRtes').setValue(false);form.findField('doRtes').setDisabled(true);}if(this.gpxLayer.getNbTrks()>0){form.findField('doTrks').setValue(true);form.findField('doTrks').setDisabled(false);}else{form.findField('doTrks').setValue(false);form.findField('doTrks').setDisabled(true);}},doSave:function(bt){if(this.getForm().isValid()){var form=this.getForm();this.gpxIO.internalProjection=this.gpxLayer.getGPXMap().getDrawProjection();this.gpxIO.extractWaypoints=form.findField('doWpts').getValue();this.gpxIO.extractRoutes=form.findField('doRtes').getValue();this.gpxIO.extractTracks=form.findField('doTrks').getValue();var xmldoc=this.gpxIO.write(this.gpxLayer.gpxLayer.features);this.hXMLDoc.setValue(xmldoc);form.getEl().dom.action=this.url;form.submit();form.fireEvent('actioncomplete');}}});Ext.reg('gpxe-ExportForm',GPXEditor1_1.form.ExportForm);GPXEditor1_1.form.ExportForm.LOCALES={TITLE:'TITLE',FILENAME_FIELD_LABEL:'FILENAME_FIELD_LABEL',FILENAME_FIELD_EMPTYTEXT:'FILE_FIELD_EMPTYTEXT',OPTIONS_FIELDSET_TITLE:'OPTIONS_FIELDSET_TITLE',DOWPTS_FIELD_BOXLABEL:'DOWPTS_FIELD_BOXLABEL',DORTES_FIELD_BOXLABEL:'DORTES_FIELD_BOXLABEL',DOTRKS_FIELD_BOXLABEL:'DOTRKS_FIELD_BOXLABEL',ACTION_SAVE_TEXT:'ACTION_SAVE_TEXT',ACTION_SAVE_TOOLTIP:'ACTION_SAVE_TOOLTIP'};
Ext.namespace('GPXEditor1_1.form');GPXEditor1_1.form.GPXElementForm=Ext.extend(Ext.form.FormPanel,{mode:undefined,record:undefined,initComponent:function(){Ext.applyIf(this,{LOCALES:GPXEditor1_1.form.GPXElementForm.LOCALES});Ext.applyIf(this,{frame:true,labelWidth:90,defaults:{width:210},mode:GPXEditor1_1.form.GPXElementForm.MODES.MDF,items:this._initItems(),buttons:[{text:this.LOCALES.BT_SAVE_TEXT,handler:function(){if(this.getForm().isValid()){this.doSuccess();this.getForm().fireEvent('actioncomplete',this.getForm(),'success');}},scope:this},{text:this.LOCALES.BT_CANCEL_TEXT,handler:function(){this.getForm().fireEvent('actioncomplete',this.getForm(),'cancel');},scope:this}]});Ext.applyIf(this,{title:this.LOCALES[this.mode+'_TITLE_PART']+' '+this.LOCALES.WHAT_TITLE_PART});GPXEditor1_1.form.GPXElementForm.superclass.initComponent.call(this);},setOpenConfig:function(openConfig){if(openConfig&&'record' in openConfig)this.setRecord(openConfig.record);},setRecord:function(record){this.record=record;this.getForm().loadRecord(record);},doSuccess:function(){if(this.record){this.getForm().updateRecord(this.record);if(this.record.get('desc').length==0)this.record.set('desc',null);this.record.commit();}},_initItems:function(){return[{xtype:'textfield',fieldLabel:GPXEditor1_1.data.GPXElementRecord.LOCALES.FIELD_NAME_NAME,name:'name'},{xtype:'textarea',fieldLabel:GPXEditor1_1.data.GPXElementRecord.LOCALES.FIELD_DESC_NAME,name:'desc'}]}});Ext.reg('gpxe-GPXElementForm',GPXEditor1_1.form.GPXElementForm);GPXEditor1_1.form.GPXElementForm.MODES={ADD:'ADD',MDF:'MDF'};GPXEditor1_1.form.GPXElementForm.LOCALES={ADD_TITLE_PART:'ADD_TITLE_PART',MDF_TITLE_PART:'MDF_TITLE_PART',WHAT_TITLE_PART:'WHAT_TITLE_PART',BT_SAVE_TEXT:'BT_SAVE_TEXT',BT_CANCEL_TEXT:'BT_CANCEL_TEXT'};
Ext.namespace('GPXEditor1_1.form');GPXEditor1_1.form.WPTForm=Ext.extend(GPXEditor1_1.form.GPXElementForm,{initComponent:function(){Ext.applyIf(this,{LOCALES:GPXEditor1_1.form.WPTForm.LOCALES,iconCls:'gpxe-WptIcon'});GPXEditor1_1.form.WPTForm.superclass.initComponent.call(this);},_initItems:function(){var ret=GPXEditor1_1.form.WPTForm.superclass._initItems.call(this);ret.push({xtype:'combo',mode:'local',store:new Ext.data.ArrayStore({id:0,fields:['wptTypeId','wptTypeName'],data:[[GPXEditor1_1.data.WPTRecord.WPT_TYPES.UNKNOW,GPXEditor1_1.data.WPTRecord.LOCALES.WPT_TYPE_UNKNOW],[GPXEditor1_1.data.WPTRecord.WPT_TYPES.PK,GPXEditor1_1.data.WPTRecord.LOCALES.WPT_TYPE_PK],[GPXEditor1_1.data.WPTRecord.WPT_TYPES.PASS,GPXEditor1_1.data.WPTRecord.LOCALES.WPT_TYPE_PASS],[GPXEditor1_1.data.WPTRecord.WPT_TYPES.RHSE,GPXEditor1_1.data.WPTRecord.LOCALES.WPT_TYPE_RHSE],[GPXEditor1_1.data.WPTRecord.WPT_TYPES.WTRW,GPXEditor1_1.data.WPTRecord.LOCALES.WPT_TYPE_WTRW],[GPXEditor1_1.data.WPTRecord.WPT_TYPES.PKLT,GPXEditor1_1.data.WPTRecord.LOCALES.WPT_TYPE_PKLT]]}),valueField:'wptTypeId',displayField:'wptTypeName',allowBlank:false,triggerAction:'all',value:GPXEditor1_1.data.WPTRecord.WPT_TYPES.UNKNOW,blankText:GPXEditor1_1.data.WPTRecord.WPT_TYPE_UNKNOW,forceSelection:true,fieldLabel:GPXEditor1_1.data.WPTRecord.LOCALES.FIELD_TYPE_NAME,name:'type'});ret.push({xtype:'compositefield',fieldLabel:GPXEditor1_1.data.WPTRecord.LOCALES.FIELD_ELE_NAME,items:[{xtype:'numberfield',allowDecimals:false,name:'ele'},{xtype:'button',iconCls:'gpxe-GetElevation',tooltip:this.LOCALES.BT_FINDELE_TOOLTIP,form:this,handler:function(button,evtObject){var f=button.form.getForm();var fEle=f.findField('ele');var lon=f.findField('lon').getValue();var lat=f.findField('lat').getValue();if(lon!=null&&lat!=null){var ll=new OpenLayers.LonLat(lon,lat);button.setDisabled(true);fEle.setDisabled(true);var getEle=new OpenLayers.Elevation(ll,function(ele){if(ele!=null)f.findField('ele').setValue(ele);f.findField('ele').setDisabled(false);this.setDisabled(false);},button);}}}]});ret.push({xtype:'numberfield',decimalPrecision:GPXEditor1_1.data.WPTRecord.LL_MAX_DIGITS,allowBlank:false,minValue:-180.0,maxValue:179.999999999,fieldLabel:GPXEditor1_1.data.WPTRecord.LOCALES.FIELD_LON_NAME,name:'lon'});ret.push({xtype:'numberfield',decimalPrecision:GPXEditor1_1.data.WPTRecord.LL_MAX_DIGITS,allowBlank:false,minValue:-90.0,maxValue:90.0,fieldLabel:GPXEditor1_1.data.WPTRecord.LOCALES.FIELD_LAT_NAME,name:'lat'});return ret;}});Ext.reg('gpxe-WPTForm',GPXEditor1_1.form.WPTForm);GPXEditor1_1.form.WPTForm.LOCALES=Ext.applyIf({WHAT_TITLE_PART:'WHAT_TITLE_PART'},GPXEditor1_1.form.GPXElementForm.LOCALES);
Ext.namespace('GPXEditor1_1.form');GPXEditor1_1.form.GPXPathForm=Ext.extend(GPXEditor1_1.form.GPXElementForm,{initComponent:function(){Ext.applyIf(this,{LOCALES:GPXEditor1_1.form.GPXPathForm.LOCALES});GPXEditor1_1.form.GPXPathForm.superclass.initComponent.call(this);}});Ext.reg('gpxe-GPXPathForm',GPXEditor1_1.form.GPXPathForm);GPXEditor1_1.form.GPXPathForm.LOCALES=Ext.applyIf({WHAT_TITLE_PART:'WHAT_TITLE_PART'},GPXEditor1_1.form.GPXElementForm.LOCALES);
Ext.namespace('GPXEditor1_1.form');GPXEditor1_1.form.RTEForm=Ext.extend(GPXEditor1_1.form.GPXPathForm,{initComponent:function(){Ext.applyIf(this,{LOCALES:GPXEditor1_1.form.RTEForm.LOCALES,iconCls:'gpxe-RteIcon'});GPXEditor1_1.form.RTEForm.superclass.initComponent.call(this);}});Ext.reg('gpxe-RTEForm',GPXEditor1_1.form.RTEForm);GPXEditor1_1.form.RTEForm.LOCALES=Ext.applyIf({WHAT_TITLE_PART:'WHAT_TITLE_PART'},GPXEditor1_1.form.GPXPathForm.LOCALES);
Ext.namespace('GPXEditor1_1.form');GPXEditor1_1.form.TRKForm=Ext.extend(GPXEditor1_1.form.GPXPathForm,{initComponent:function(){Ext.applyIf(this,{LOCALES:GPXEditor1_1.form.TRKForm.LOCALES,iconCls:'gpxe-TrkIcon'});GPXEditor1_1.form.TRKForm.superclass.initComponent.call(this);}});Ext.reg('gpxe-TRKForm',GPXEditor1_1.form.TRKForm);GPXEditor1_1.form.TRKForm.LOCALES=Ext.applyIf({WHAT_TITLE_PART:'WHAT_TITLE_PART'},GPXEditor1_1.form.GPXPathForm.LOCALES);
Ext.namespace('GPXEditor1_1.form');GPXEditor1_1.form.ElevationForm=Ext.extend(Ext.form.FormPanel,{gpxLayer:undefined,feature:undefined,point:undefined,initComponent:function(){Ext.applyIf(this,{LOCALES:GPXEditor1_1.form.ElevationForm.LOCALES});if(!this.gpxLayer||!(this.gpxLayer instanceof GPXEditor1_1.GPXLayer))this.gpxLayer=new GPXEditor1_1.GPXLayer();Ext.applyIf(this,{frame:true,title:this.LOCALES.TITLE,iconCls:'gpxe-GetElevation',labelWidth:90,defaults:{width:210},buttons:[{text:this.LOCALES.BT_SAVE_TEXT,handler:function(){if(this.getForm().isValid()){this.doSuccess();this.getForm().fireEvent('actioncomplete',this.getForm(),'success');}},scope:this},{text:this.LOCALES.BT_CANCEL_TEXT,handler:function(){this.getForm().fireEvent('actioncomplete',this.getForm(),'cancel');},scope:this}],items:[{xtype:'compositefield',fieldLabel:this.LOCALES.LABEL_ELE,items:[{xtype:'numberfield',allowDecimals:false,name:'ele'},{xtype:'button',iconCls:'gpxe-GetElevation',tooltip:this.LOCALES.BT_FINDELE_TOOLTIP,form:this,handler:function(button,evtObject){if(!this.form.point||!this.form.feature)return;var f=this.form.getForm();var fEle=f.findField('ele');var ll=new OpenLayers.LonLat(this.form.point.x,this.form.point.y);ll=ll.transform(this.form.gpxLayer.getGPXMap().getDrawProjection(),this.form.gpxLayer.getGPXMap().getDisplayProjection());button.setDisabled(true);fEle.setDisabled(true);var getEle=new OpenLayers.Elevation(ll,function(ele){if(ele!=null)var f=this.form.getForm();f.findField('ele').setValue(ele);f.findField('ele').setDisabled(false);this.setDisabled(false);},button);}}]}]});GPXEditor1_1.form.ElevationForm.superclass.initComponent.call(this);},getGPXLayer:function(){return this.gpxLayer;},setOpenConfig:function(openConfig){this.feature=openConfig.feature;this.point=openConfig.point;this.getForm().setValues({ele:this.point.ele});},doSuccess:function(){if(!this.feature||!this.point)return;var fEle=this.form.findField('ele');if(fEle.isDirty()){if(fEle.getValue()&&fEle.getValue()!='')this.point.ele=fEle.getValue();else
delete this.point.ele;this.feature.layer.events.triggerEvent('vertexmodified',{vertex:this.point,feature:this.feature});this.feature.layer.events.triggerEvent('featuremodified',{feature:this.feature});}else if(this.point.ele&&fEle.getValue()==''){delete this.point.ele;this.feature.layer.events.triggerEvent('vertexmodified',{vertex:this.point,feature:this.feature});this.feature.layer.events.triggerEvent('featuremodified',{feature:this.feature});}}});Ext.reg('gpxe-ElevationForm',GPXEditor1_1.form.ElevationForm);GPXEditor1_1.form.ElevationForm.LOCALES={TITLE:'TITLE',LABEL_ELE:'LABEL_ELE',BT_FINDELE_TOOLTIP:'BT_FINDELE_TOOLTIP',BT_SAVE_TEXT:'BT_SAVE_TEXT',BT_CANCEL_TEXT:'BT_CANCEL_TEXT'};
Ext.namespace('GPXEditor1_1');GPXEditor1_1.GPXElementDetailPanel=Ext.extend(Ext.Panel,{gpxElementRecord:undefined,initComponent:function(){Ext.applyIf(this,{LOCALES:GPXEditor1_1.GPXElementDetailPanel.LOCALES});Ext.applyIf(this,{title:'-',bodyCfg:{cls:'gpxe-DetailPanel'},html:this.getHtmlBodyContent(null)});GPXEditor1_1.GPXElementDetailPanel.superclass.initComponent.call(this);},getGPXElementRecord:function(){return this.gpxElementRecord;},setGPXElementRecord:function(gpxElementRecord,force){if(this.gpxElementRecord===gpxElementRecord&&!force)return;var store=gpxElementRecord?gpxElementRecord.store:null;if(!gpxElementRecord||this.store!=store){if(this.store&&this.store!=store){this.store.un('update',this._onStoreUpdate,this);delete this.store;}if(gpxElementRecord&&this.store!=store){this.store=store;this.store.on('update',this._onStoreUpdate,this);}}this.gpxElementRecord=gpxElementRecord;this.setTitle(gpxElementRecord?gpxElementRecord.getName():'-');this.update(this.getHtmlBodyContent(this.gpxElementRecord));},getHtmlBodyContent:function(gpxElementRecord){var htmlDesc=gpxElementRecord&&gpxElementRecord.get('desc')?gpxElementRecord.get('desc'):this._getHtmlDefaultValue();return this._getHtmlDetailLine(this._getHtmlField(GPXEditor1_1.data.GPXElementRecord.LOCALES.FIELD_DESC_NAME),this._getHtmlValue(htmlDesc.replace(GPXEditor1_1.GPXElementDetailPanel.HTMLNEWLINE_REGEX,'<br />')));},_getHtmlDefaultValue:function(value){value=value||'-';return '<span class="gpxe-DefaultValue">'+value+'</span>';},_getHtmlField:function(fieldName){return '<span class="gpxe-DetailField">'+fieldName+': </span>';},_getHtmlValue:function(fieldValue){return '<span class="gpxe-DetailValue">'+fieldValue+'</span>';},_getHtmlDetailLine:function(htmlFieldName,htmlFieldValue){return '<div class="gpxe-DetailLine">'+htmlFieldName+htmlFieldValue+'</div>';},_onStoreUpdate:function(store,record,operation){if(record==this.gpxElementRecord)this.setGPXElementRecord(record,true);}});Ext.reg('gpxe-GPXElementDetailPanel',GPXEditor1_1.GPXElementDetailPanel);GPXEditor1_1.GPXElementDetailPanel.HTMLNEWLINE_REGEX=new RegExp('(\n|\r\n)','g');GPXEditor1_1.GPXElementDetailPanel.LOCALES={};
Ext.namespace('GPXEditor1_1');GPXEditor1_1.WPTDetailPanel=Ext.extend(GPXEditor1_1.GPXElementDetailPanel,{initComponent:function(){Ext.applyIf(this,{LOCALES:GPXEditor1_1.WPTDetailPanel.LOCALES});GPXEditor1_1.WPTDetailPanel.superclass.initComponent.call(this);},getHtmlBodyContent:function(wptRecord){var htmlDesc=GPXEditor1_1.WPTDetailPanel.superclass.getHtmlBodyContent.call(this,wptRecord);var htmlEle=wptRecord&&wptRecord.get('ele')?OpenLayers.Util.formatElevation(wptRecord.get('ele')):this._getHtmlDefaultValue();var htmlType=wptRecord&&wptRecord.get('type')!=GPXEditor1_1.data.WPTRecord.WPT_TYPES.UNKNOW?GPXEditor1_1.data.WPTRecord.LOCALES['WPT_TYPE_'+wptRecord.get('type')]:this._getHtmlDefaultValue();var htmlLon=wptRecord?wptRecord.get('lon'):this._getHtmlDefaultValue();var htmlLat=wptRecord?wptRecord.get('lat'):this._getHtmlDefaultValue();htmlDesc+=this._getHtmlDetailLine(this._getHtmlField(GPXEditor1_1.data.WPTRecord.LOCALES.FIELD_ELE_NAME),this._getHtmlValue(htmlEle));htmlDesc+=this._getHtmlDetailLine(this._getHtmlField(GPXEditor1_1.data.WPTRecord.LOCALES.FIELD_TYPE_NAME),this._getHtmlValue(htmlType));htmlDesc+=this._getHtmlDetailLine(this._getHtmlField(GPXEditor1_1.data.WPTRecord.LOCALES.FIELD_LON_NAME),this._getHtmlValue(htmlLon));htmlDesc+=this._getHtmlDetailLine(this._getHtmlField(GPXEditor1_1.data.WPTRecord.LOCALES.FIELD_LAT_NAME),this._getHtmlValue(htmlLat));return htmlDesc;}});Ext.reg('gpxe-WPTDetailPanel',GPXEditor1_1.WPTDetailPanel);GPXEditor1_1.WPTDetailPanel.LOCALES=Ext.apply({},GPXEditor1_1.GPXElementDetailPanel);
Ext.namespace('GPXEditor1_1');GPXEditor1_1.GPXPathDetailPanel=Ext.extend(GPXEditor1_1.GPXElementDetailPanel,{initComponent:function(){Ext.applyIf(this,{LOCALES:GPXEditor1_1.GPXPathDetailPanel.LOCALES});GPXEditor1_1.GPXPathDetailPanel.superclass.initComponent.call(this);},getHtmlBodyContent:function(gpxPathRecord){var htmlDesc=GPXEditor1_1.GPXPathDetailPanel.superclass.getHtmlBodyContent.call(this,gpxPathRecord);var htmlNbPts=gpxPathRecord&&gpxPathRecord.get('numberOfPoints')?gpxPathRecord.get('numberOfPoints'):this._getHtmlDefaultValue();var htmlDistance=gpxPathRecord&&gpxPathRecord.get('distance')?OpenLayers.Util.formatDistance(gpxPathRecord.get('distance')):this._getHtmlDefaultValue();var htmlPositiveDenivelation=gpxPathRecord&&gpxPathRecord.get('positiveDenivelation')?OpenLayers.Util.formatElevation(gpxPathRecord.get('positiveDenivelation')):this._getHtmlDefaultValue();var htmlNegativeDenivelation=gpxPathRecord&&gpxPathRecord.get('negativeDenivelation')?OpenLayers.Util.formatElevation(gpxPathRecord.get('negativeDenivelation')):this._getHtmlDefaultValue();var htmlMinimumElevation=gpxPathRecord&&gpxPathRecord.get('minimumElevation')?OpenLayers.Util.formatElevation(gpxPathRecord.get('minimumElevation')):this._getHtmlDefaultValue();var htmlAverageElevation=gpxPathRecord&&gpxPathRecord.get('averageElevation')?OpenLayers.Util.formatElevation(gpxPathRecord.get('averageElevation')):this._getHtmlDefaultValue();var htmlMaximumElevation=gpxPathRecord&&gpxPathRecord.get('maximumElevation')?OpenLayers.Util.formatElevation(gpxPathRecord.get('maximumElevation')):this._getHtmlDefaultValue();htmlDesc+=this._getHtmlDetailLine(this._getHtmlField(GPXEditor1_1.data.GPXPathRecord.LOCALES.FIELD_NUMBER_OF_POINTS_NAME),this._getHtmlValue(htmlNbPts));htmlDesc+=this._getHtmlDetailLine(this._getHtmlField(GPXEditor1_1.data.GPXPathRecord.LOCALES.FIELD_DISTANCE_NAME),this._getHtmlValue(htmlDistance));htmlDesc+=this._getHtmlDetailLine(this._getHtmlField(GPXEditor1_1.data.GPXPathRecord.LOCALES.FIELD_POSITIVE_DENIVELATION_NAME),this._getHtmlValue(htmlPositiveDenivelation));htmlDesc+=this._getHtmlDetailLine(this._getHtmlField(GPXEditor1_1.data.GPXPathRecord.LOCALES.FIELD_NEGATIVE_DENIVELATION_NAME),this._getHtmlValue(htmlNegativeDenivelation));htmlDesc+=this._getHtmlDetailLine(this._getHtmlField(GPXEditor1_1.data.GPXPathRecord.LOCALES.ELEVATION+' ('+GPXEditor1_1.data.GPXPathRecord.LOCALES.MIN_AVR_MAX+')'),this._getHtmlValue(htmlMinimumElevation+' / '+htmlAverageElevation+' / '+htmlMaximumElevation));return htmlDesc;}});Ext.reg('gpxe-GPXPathDetailPanel',GPXEditor1_1.GPXPathDetailPanel);GPXEditor1_1.GPXPathDetailPanel.LOCALES=Ext.apply({},GPXEditor1_1.GPXElementDetailPanel);
Ext.namespace('GPXEditor1_1');GPXEditor1_1.TRKDetailPanel=Ext.extend(GPXEditor1_1.GPXPathDetailPanel,{initComponent:function(){Ext.applyIf(this,{LOCALES:GPXEditor1_1.TRKDetailPanel.LOCALES});GPXEditor1_1.TRKDetailPanel.superclass.initComponent.call(this);},getHtmlBodyContent:function(trkRecord){var htmlDesc=GPXEditor1_1.TRKDetailPanel.superclass.getHtmlBodyContent.call(this,trkRecord);var htmlDuration=trkRecord&&trkRecord.get('duration')?OpenLayers.Util.formatDuration(trkRecord.get('duration')):this._getHtmlDefaultValue();htmlDesc+=this._getHtmlDetailLine(this._getHtmlField(GPXEditor1_1.data.TRKRecord.LOCALES.FIELD_DURATION_NAME),this._getHtmlValue(htmlDuration));return htmlDesc;}});Ext.reg('gpxe-TRKDetailPanel',GPXEditor1_1.TRKDetailPanel);GPXEditor1_1.TRKDetailPanel.LOCALES=Ext.apply({},GPXEditor1_1.GPXPathDetailPanel);
Ext.namespace('GPXEditor1_1');GPXEditor1_1.GPXElementEditorPanel=Ext.extend(Ext.Panel,{gridPanel:undefined,detailPanel:undefined,initComponent:function(){Ext.applyIf(this,{LOCALES:GPXEditor1_1.EditorPanel.LOCALES});if(!(this.gridPanel instanceof GPXEditor1_1.grid.GPXElementGridPanel))this.gridPanel=new GPXEditor1_1.gridPanel.GPXElementGridPanel();if(!(this.detailPanel instanceof GPXEditor1_1.GPXElementDetailPanel))this.detailPanel=new GPXEditor1_1.GPXElementDetailPanel();this.gridPanel.getSelectionModel().on('selectionchange',function(selectionModel){this.detailPanel.setGPXElementRecord(selectionModel.getSelected());if(!this.detailPanel.getGPXElementRecord())this.detailPanel.disable();else
this.detailPanel.enable();this.doLayout();},this);Ext.apply(this.gridPanel,{region:'center',bodyStyle:{marginBottom:'5px'}});Ext.apply(this.detailPanel,{region:'south',autoHeight:true,gpxElementRecord:null});Ext.apply(this,{layout:'border',frame:true,items:[this.gridPanel,this.detailPanel]});GPXEditor1_1.GPXElementEditorPanel.superclass.initComponent.call(this);},getGridPanel:function(){return this.gridPanel;},getDetailPanel:function(){return this.detailPanel;}});Ext.reg('gpxe-GPXElementEditorPanel',GPXEditor1_1.GPXElementEditorPanel);GPXEditor1_1.GPXElementEditorPanel.LOCALES={};
Ext.namespace('GPXEditor1_1');GPXEditor1_1.EditorMode=Ext.extend(Ext.util.Observable,{mode:undefined,gpxLayer:undefined,changeModeActions:undefined,constructor:function(config){config=config||{};this.LOCALES=GPXEditor1_1.EditorMode.LOCALES;this.changeModeActions=[];this.mode=(config.mode in GPXEditor1_1.EditorMode.MODES)?config.mode:GPXEditor1_1.EditorMode.MODES.WPTS;delete config.mode;var gpxLayer=config.gpxLayer;delete config.gpxLayer;this.addEvents({modechange:true,gpxlayerchange:true});this.listeners=config.listeners;GPXEditor1_1.EditorMode.superclass.constructor.call(this,config);this.setGPXLayer(gpxLayer);},setGPXLayer:function(gpxLayer){if(this.gpxLayer===gpxLayer)return;if(this.gpxLayer)this.gpxLayer.un('gpxelementselectionchange',this._onGPXElementSelectionChange,this);this.gpxLayer=gpxLayer;if(this.gpxLayer)this.gpxLayer.on('gpxelementselectionchange',this._onGPXElementSelectionChange,this);this.fireEvent('gpxlayerchange',this.gpxLayer,this);},getGPXLayer:function(){return this.gpxLayer;},setMode:function(mode){var definedModes=GPXEditor1_1.EditorMode.MODES;if(!mode||!(mode in definedModes))mode=definedModes.WPTS;if(this.mode==mode)return;this.mode=mode;var action=this.changeModeActions[mode];if(action)action.toggle(true);if(this.gpxLayer&&this.gpxLayer.getGPXMap())this.gpxLayer.getGPXMap().setMapMode(GPXEditor1_1.GPXMap.ACTIONS.NAVIGATE);this.fireEvent('modechange',this.mode,this);},getMode:function(){return this.mode;},getChangeModeAction:function(modeId){if(!this.changeModeActions[modeId]){var definedModes=GPXEditor1_1.EditorMode.MODES;var actionGroup=GPXEditor1_1.EditorMode.MODE_ACTION_GROUP;switch(modeId){case definedModes.WPTS:this.changeModeActions[definedModes.WPTS]=new Ext.Action({toggleGroup:actionGroup,allowDepress:false,pressed:true,checked:true,iconCls:'gpxe-WptIcon',text:this.LOCALES.ACTION_SETMODE_WPT_TEXT,tooltip:this.LOCALES.ACTION_SETMODE_WPT_TOOLTIP,handler:function(){this.setMode(definedModes.WPTS);},scope:this});break;case definedModes.RTES:this.changeModeActions[definedModes.RTES]=new Ext.Action({toggleGroup:actionGroup,allowDepress:false,pressed:false,checked:false,iconCls:'gpxe-RteIcon',text:this.LOCALES.ACTION_SETMODE_RTE_TEXT,tooltip:this.LOCALES.ACTION_SETMODE_RTE_TOOLTIP,handler:function(){this.setMode(definedModes.RTES);},scope:this});break;case definedModes.TRKS:this.changeModeActions[definedModes.TRKS]=new Ext.Action({toggleGroup:actionGroup,allowDepress:false,pressed:false,checked:false,iconCls:'gpxe-TrkIcon',text:this.LOCALES.ACTION_SETMODE_TRK_TEXT,tooltip:this.LOCALES.ACTION_SETMODE_TRK_TOOLTIP,handler:function(){this.setMode(definedModes.TRKS);},scope:this});break;}}return this.changeModeActions[modeId];},_onGPXElementSelectionChange:function(gpxElement,gpxLayer){var definedModes=GPXEditor1_1.EditorMode.MODES;if(!gpxElement)return;if(gpxElement instanceof GPXEditor1_1.data.WPTRecord)this.setMode(definedModes.WPTS);else if(gpxElement instanceof GPXEditor1_1.data.RTERecord)this.setMode(definedModes.RTES);else if(gpxElement instanceof GPXEditor1_1.data.TRKRecord)this.setMode(definedModes.TRKS);}});GPXEditor1_1.EditorMode.MODE_ACTION_GROUP='GPXEditor1_1.EditorMode.MODE_ACTION_GROUP';GPXEditor1_1.EditorMode.MODES={WPTS:'WPTS',RTES:'RTES',TRKS:'TRKS'};GPXEditor1_1.EditorMode.LOCALES={ACTION_SETMODE_WPT_TEXT:'ACTION_SETMODE_WPT_TEXT',ACTION_SETMODE_WPT_TOOLTIP:'ACTION_SETMODE_WPT_TOOLTIP',ACTION_SETMODE_RTE_TEXT:'ACTION_SETMODE_RTE_TEXT',ACTION_SETMODE_RTE_TOOLTIP:'ACTION_SETMODE_RTE_TOOLTIP',ACTION_SETMODE_TRK_TEXT:'ACTION_SETMODE_TRK_TEXT',ACTION_SETMODE_TRK_TOOLTIP:'ACTION_SETMODE_TRK_TOOLTIP'};
Ext.namespace('GPXEditor1_1');GPXEditor1_1.EditorToolbar=Ext.extend(Ext.Toolbar,{gpxLayer:undefined,editorMode:undefined,winAbout:undefined,bExpand:undefined,bLoadGPX:undefined,bSaveGPX:undefined,bDeleteGPX:undefined,bZoomGPX:undefined,bSetModeWPTS:undefined,bSetModeRTES:undefined,bSetModeTRKS:undefined,bNavigate:undefined,bAddWpt:undefined,bEditWpt:undefined,bDeleteWpt:undefined,bAddRte:undefined,bEditRte:undefined,bSwapRte:undefined,bDeleteRte:undefined,bConvertRte:undefined,bEditTrk:undefined,bDeleteTrk:undefined,bConvertTrk:undefined,initComponent:function(){Ext.applyIf(this,{LOCALES:GPXEditor1_1.EditorToolbar.LOCALES});if(!(this.gpxLayer instanceof GPXEditor1_1.GPXLayer))this.gpxLayer=new GPXEditor1_1.GPXLayer();if(!(this.editorMode instanceof GPXEditor1_1.EditorMode))this.editorMode=new GPXEditor1_1.EditorMode({gpxLayer:this.gpxLayer});if(this.editorMode.getGPXLayer()!==this.gpxLayer)this.editorMode.setGPXLayer(this.gpxLayer);this.editorMode.on('modechange',function(mode,editorMode){this.updateButtonsVisibility();},this);this._initButtons();this.winAbout=new Ext.Window({title:this.LOCALES.BT_ABOUT_TOOLTIP,forceLayout:true,layout:'fit',closeAction:'hide',modal:true,width:460,autoHeight:true,items:[{xtype:'panel',border:false,bodyBorder:false,margins:10,contentEl:'gpxe-aboutGPXEditor1_1',autoScroll:true}],listeners:{show:function(){Ext.get('gpxe-aboutGPXEditor1_1').show();},scope:this}});Ext.applyIf(this,{cls:'gpxe-EditorToolbar',items:[' ',this.bLoadGPX,this.bSaveGPX,this.bDeleteGPX,this.bZoomGPX,' ',' ','-',this.bSetModeWPTS,this.bSetModeRTES,this.bSetModeTRKS,' ',' ','-',this.bNavigate,this.bAddWpt,this.bEditWpt,this.bDeleteWpt,this.bAddRte,this.bEditRte,this.bSwapRte,this.bDeleteRte,' ',' ',this.bConvertRte,this.bDeleteTrk,' ',' ',this.bConvertTrk,'->',{type:'button',id:'gpxe-GPXEditorLogoV',style:{height:'120px'},handler:function(){this.winAbout.show();},scope:this,iconCls:'gpxe-GPXEditorLogoV',tooltip:this.LOCALES.BT_ABOUT_TOOLTIP}]});GPXEditor1_1.EditorToolbar.superclass.initComponent.call(this);this.on('afterlayout',function(){this.gpxLayer.updateActions();this.updateButtonsVisibility();},this);},updateButtonsVisibility:function(){var mode=this.editorMode.getMode();var definedModes=GPXEditor1_1.EditorMode.MODES;var visible;visible=(mode==definedModes.WPTS);this.bAddWpt.setVisible(visible);this.bEditWpt.setVisible(visible);this.bDeleteWpt.setVisible(visible);visible=(mode==definedModes.RTES);this.bAddRte.setVisible(visible);this.bEditRte.setVisible(visible);this.bDeleteRte.setVisible(visible);this.bSwapRte.setVisible(visible);this.bConvertRte.setVisible(visible);visible=(mode==definedModes.TRKS);this.bEditTrk.setVisible(visible);this.bDeleteTrk.setVisible(visible);this.bConvertTrk.setVisible(visible);},getMode:function(){return this.mode;},getChangeModeAction:function(modeId){},_initButtons:function(){var gpxActions=GPXEditor1_1.GPXLayer.ACTIONS;this.bLoadGPX=new Ext.Button(this.gpxLayer.getAction(gpxActions.LOAD_GPX));this.bLoadGPX.setText(null);this.bSaveGPX=new Ext.Button(this.gpxLayer.getAction(gpxActions.SAVE_GPX));this.bSaveGPX.setText(null);this.bDeleteGPX=new Ext.Button(this.gpxLayer.getAction(gpxActions.DEL_GPX));this.bDeleteGPX.setText(null);this.bZoomGPX=new Ext.Button(this.gpxLayer.getAction(gpxActions.MAP_ZOOM_GPX));this.bZoomGPX.setText(null);this.bSetModeWPTS=new Ext.Button(this.editorMode.getChangeModeAction(GPXEditor1_1.EditorMode.MODES.WPTS));this.bSetModeWPTS.setText(null);this.bSetModeRTES=new Ext.Button(this.editorMode.getChangeModeAction(GPXEditor1_1.EditorMode.MODES.RTES));this.bSetModeRTES.setText(null);this.bSetModeTRKS=new Ext.Button(this.editorMode.getChangeModeAction(GPXEditor1_1.EditorMode.MODES.TRKS));this.bSetModeTRKS.setText(null);this.bNavigate=new Ext.Button(this.gpxLayer.getGPXMap().getAction(GPXEditor1_1.GPXMap.ACTIONS.NAVIGATE));this.bNavigate.setText(null);this.bAddWpt=new Ext.Button(this.gpxLayer.getAction(gpxActions.MAP_ADD_WPT));this.bAddWpt.setText(null);this.bEditWpt=new Ext.Button(this.gpxLayer.getAction(gpxActions.MAP_EDIT_WPT));this.bEditWpt.setText(null);this.bDeleteWpt=new Ext.Button(this.gpxLayer.getAction(gpxActions.MAP_DEL_WPT));this.bDeleteWpt.setText(null);this.bAddRte=new Ext.Button(this.gpxLayer.getAction(gpxActions.MAP_ADD_RTE));this.bAddRte.setText(null);this.bEditRte=new Ext.Button(this.gpxLayer.getAction(gpxActions.MAP_EDIT_RTE));this.bEditRte.setText(null);this.bSwapRte=new Ext.Button(this.gpxLayer.getAction(gpxActions.MAP_SWAP_RTE));this.bSwapRte.setText(null);this.bDeleteRte=new Ext.Button(this.gpxLayer.getAction(gpxActions.MAP_DEL_RTE));this.bDeleteRte.setText(null);this.bConvertRte=new Ext.Button(this.gpxLayer.getAction(gpxActions.MAP_CONV_RTE));this.bConvertRte.setText(null);this.bEditTrk=new Ext.Button(this.gpxLayer.getAction(gpxActions.MAP_EDIT_TRK));this.bEditTrk.setText(null);this.bDeleteTrk=new Ext.Button(this.gpxLayer.getAction(gpxActions.MAP_DEL_TRK));this.bDeleteTrk.setText(null);this.bConvertTrk=new Ext.Button(this.gpxLayer.getAction(gpxActions.MAP_CONV_TRK));this.bConvertTrk.setText(null);}});Ext.reg('gpxe-EditorToolbar',GPXEditor1_1.EditorToolbar);GPXEditor1_1.EditorToolbar.LOCALES={};
Ext.namespace('GPXEditor1_1');GPXEditor1_1.EditorPanel=Ext.extend(Ext.Panel,{gpxLayer:undefined,editorMode:undefined,initComponent:function(){Ext.applyIf(this,{LOCALES:GPXEditor1_1.EditorPanel.LOCALES});if(!(this.gpxLayer instanceof GPXEditor1_1.GPXLayer))this.gpxLayer=new GPXEditor1_1.GPXLayer();if(!(this.editorMode instanceof GPXEditor1_1.EditorMode))this.editorMode=new GPXEditor1_1.EditorMode({gpxLayer:this.gpxLayer});if(this.editorMode.getGPXLayer()!==this.gpxLayer)this.editorMode.setGPXLayer(this.gpxLayer);this.editorMode.on('modechange',function(mode,editorMode){this.showEditor(mode);},this);Ext.applyIf(this,{border:false,layout:'card',activeItem:0,items:[{xtype:'gpxe-GPXElementEditorPanel',title:this.editorMode.LOCALES.ACTION_SETMODE_WPT_TOOLTIP,iconCls:'gpxe-WptIcon',gridPanel:new GPXEditor1_1.grid.WPTGridPanel({store:this.gpxLayer.getWptStore(),gpxLayer:this.gpxLayer,border:false,sm:new GPXEditor1_1.grid.GPXElementSelectionModel({selectControl:this.gpxLayer.getOLSelectControl()}),tbar:['->',this.gpxLayer.getGPXAction(GPXEditor1_1.GPXLayer.ACTIONS.EDIT_WPT),' ',this.gpxLayer.getGPXAction(GPXEditor1_1.GPXLayer.ACTIONS.DEL_WPT)]}),detailPanel:new GPXEditor1_1.WPTDetailPanel()},{xtype:'gpxe-GPXElementEditorPanel',title:this.editorMode.LOCALES.ACTION_SETMODE_RTE_TOOLTIP,iconCls:'gpxe-RteIcon',gridPanel:new GPXEditor1_1.grid.RTEGridPanel({store:this.gpxLayer.getRteStore(),gpxLayer:this.gpxLayer,border:false,sm:new GPXEditor1_1.grid.GPXElementSelectionModel({selectControl:this.gpxLayer.getOLSelectControl()}),tbar:['->',this.gpxLayer.getGPXAction(GPXEditor1_1.GPXLayer.ACTIONS.EDIT_RTE),this.gpxLayer.getGPXAction(GPXEditor1_1.GPXLayer.ACTIONS.GET_MISSED_ELE),' ',this.gpxLayer.getGPXAction(GPXEditor1_1.GPXLayer.ACTIONS.DEL_RTE)]}),detailPanel:new GPXEditor1_1.GPXPathDetailPanel()},{xtype:'gpxe-GPXElementEditorPanel',title:this.editorMode.LOCALES.ACTION_SETMODE_TRK_TOOLTIP,iconCls:'gpxe-TrkIcon',gridPanel:new GPXEditor1_1.grid.TRKGridPanel({store:this.gpxLayer.getTrkStore(),gpxLayer:this.gpxLayer,border:false,sm:new GPXEditor1_1.grid.GPXElementSelectionModel({selectControl:this.gpxLayer.getOLSelectControl()}),tbar:['->',this.gpxLayer.getGPXAction(GPXEditor1_1.GPXLayer.ACTIONS.EDIT_TRK),' ',this.gpxLayer.getGPXAction(GPXEditor1_1.GPXLayer.ACTIONS.DEL_TRK)]}),detailPanel:new GPXEditor1_1.TRKDetailPanel()}]});GPXEditor1_1.EditorPanel.superclass.initComponent.call(this);},showEditor:function(mode){var modes=GPXEditor1_1.EditorMode.MODES;var idx=0;switch(mode){case modes.WPTS:idx=0;break;case modes.RTES:idx=1;break;case modes.TRKS:idx=2;break;}this.getLayout().setActiveItem(idx);}});Ext.reg('gpxe-EditorPanel',GPXEditor1_1.EditorPanel);GPXEditor1_1.EditorPanel.LOCALES={};
Ext.namespace('GPXEditor1_1.grid');GPXEditor1_1.grid.GPXElementSelectionModel=Ext.extend(GeoExt.grid.FeatureSelectionModel,{rowSelected:function(model,row,record){if(this.selectControl.active)GPXEditor1_1.grid.GPXElementSelectionModel.superclass.rowSelected.call(this,model,row,record);}});
Ext.namespace('GPXEditor1_1.grid');GPXEditor1_1.grid.GPXElementGridPanel=Ext.extend(Ext.grid.GridPanel,{gpxLayer:undefined,initComponent:function(){Ext.applyIf(this,{LOCALES:GPXEditor1_1.grid.GPXElementGridPanel.LOCALES});if(!(this.store instanceof GPXEditor1_1.data.GPXElementStore))this.store=new GPXEditor1_1.data.GPXElementStore();Ext.applyIf(this,{columns:this._getColumnsConfig(),autoExpandColumn:'name',viewConfig:{forceFit:true},sm:new GPXEditor1_1.grid.GPXElementSelectionModel()});GPXEditor1_1.grid.GPXElementGridPanel.superclass.initComponent.call(this);this.on('rowclick',function(grid,rowIndex,e){if(this.gpxLayer&&this.gpxLayer.getGPXMap()){this.gpxLayer.getGPXMap().setMapMode(GPXEditor1_1.GPXMap.ACTIONS.NAVIGATE);this.gpxLayer.setSelectedElement(this.store.getAt(rowIndex));}});},setGPXLayer:function(gpxLayer){if(this.gpxLayer==gpxLayer||!(gpxLayer instanceof GPXEditor1_1.GPXLayer))return;this.gpxLayer=gpxLayer;},getGPXLayer:function(){return this.gpxLayer;},_getColumnsConfig:function(){var ret=[];ret.push({header:GPXEditor1_1.data.GPXElementRecord.LOCALES.FIELD_NAME_NAME,sortable:true,dataIndex:'name',renderer:function(value,metaData,record,rowIndex,colIndex,store){var tt=this._getDefaultRowTooltip();if(tt)metaData.attr='ext:qtip="'+tt+'"';if(!value||value.length<=0){metaData.css='gpxe-DefaultValue';value=record.getName();}return value;},scope:this});return ret;},_getDefaultRowTooltip:function(){return null;}});Ext.reg('gpxe-grid-GPXElementGridPanel',GPXEditor1_1.grid.GPXElementGridPanel);GPXEditor1_1.grid.GPXElementGridPanel.LOCALES={};
Ext.namespace('GPXEditor1_1.grid');GPXEditor1_1.grid.WPTGridPanel=Ext.extend(GPXEditor1_1.grid.GPXElementGridPanel,{initComponent:function(){Ext.applyIf(this,{LOCALES:GPXEditor1_1.grid.WPTGridPanel.LOCALES});if(!(this.store instanceof GPXEditor1_1.data.WPTStore))this.store=new GPXEditor1_1.data.WPTStore();GPXEditor1_1.grid.WPTGridPanel.superclass.initComponent.call(this);this.on('rowdblclick',function(grid,rowIndex,e){var record=this.store.getAt(rowIndex);if(this.gpxLayer&&this.gpxLayer.getGPXMap()&&record)this.gpxLayer.getGPXMap().setCenter(record.get('lon'),record.get('lat'));});},_getColumnsConfig:function(){var ret=GPXEditor1_1.grid.WPTGridPanel.superclass._getColumnsConfig.call(this);ret.push({header:GPXEditor1_1.data.WPTRecord.LOCALES.FIELD_ELE_NAME,align:'right',sortable:true,dataIndex:'ele',renderer:function(value,metaData,record,rowIndex,colIndex,store){var tt=this._getDefaultRowTooltip();if(tt)metaData.attr='ext:qtip="'+tt+'"';if(value===null||value===undefined||value.length==0){metaData.css='gpxe-DefaultValue';return '-';}return value+' m';},scope:this});ret.push({header:GPXEditor1_1.data.WPTRecord.LOCALES.FIELD_TYPE_NAME,sortable:true,dataIndex:'type',renderer:function(value,metaData,record,rowIndex,colIndex,store){var tt=this._getDefaultRowTooltip();if(tt)metaData.attr='ext:qtip="'+tt+'"';if(value==null||value==GPXEditor1_1.data.WPTRecord.WPT_TYPES.UNKNOW){metaData.css='gpxe-DefaultValue';return '-';}return GPXEditor1_1.data.WPTRecord.LOCALES['WPT_TYPE_'+value];},scope:this});return ret;},_getDefaultRowTooltip:function(){if(this.gpxLayer)return this.LOCALES.DBLCLICK_INFO;else
return GPXEditor1_1.grid.WPTGridPanel.superclass._getDefaultRowTooltip();}});Ext.reg('gpxe-grid-WPTGridPanel',GPXEditor1_1.grid.WPTGridPanel);GPXEditor1_1.grid.WPTGridPanel.LOCALES=Ext.apply({DBLCLICK_INFO:'DBLCLICK_INFO'},GPXEditor1_1.grid.GPXElementGridPanel);
Ext.namespace('GPXEditor1_1.grid');GPXEditor1_1.grid.GPXPathGridPanel=Ext.extend(GPXEditor1_1.grid.GPXElementGridPanel,{initComponent:function(){Ext.applyIf(this,{LOCALES:GPXEditor1_1.grid.GPXPathGridPanel.LOCALES});if(!(this.store instanceof GPXEditor1_1.data.GPXPathStore))this.store=new GPXEditor1_1.data.GPXPathStore();GPXEditor1_1.grid.GPXPathGridPanel.superclass.initComponent.call(this);this.on('rowdblclick',function(grid,rowIndex,e){var record=this.store.getAt(rowIndex);if(this.gpxLayer&&this.gpxLayer.getGPXMap()&&record)this.gpxLayer.getGPXMap().zoomToExtent(record.get('feature').geometry.getBounds());});},_getColumnsConfig:function(){var ret=GPXEditor1_1.grid.GPXPathGridPanel.superclass._getColumnsConfig.call(this);ret.push({header:GPXEditor1_1.data.GPXPathRecord.LOCALES.FIELD_NUMBER_OF_POINTS_SHORTNAME,tooltip:GPXEditor1_1.data.GPXPathRecord.LOCALES.FIELD_NUMBER_OF_POINTS_NAME,align:'right',sortable:true,dataIndex:'numberOfPoints',hidden:true,renderer:function(value,metaData,record,rowIndex,colIndex,store){var tt=this._getDefaultRowTooltip();if(tt)metaData.attr='ext:qtip="'+tt+'"';if(value===null||value===undefined||value.length==0){metaData.css='gpxe-DefaultValue';return '-';}return value;},scope:this});ret.push({header:GPXEditor1_1.data.GPXPathRecord.LOCALES.FIELD_DISTANCE_SHORTNAME,tooltip:GPXEditor1_1.data.GPXPathRecord.LOCALES.FIELD_DISTANCE_NAME,align:'right',sortable:true,dataIndex:'distance',renderer:function(value,metaData,record,rowIndex,colIndex,store){var tt=this._getDefaultRowTooltip();if(tt)metaData.attr='ext:qtip="'+tt+'"';if(value===null||value===undefined||value.length==0){metaData.css='gpxe-DefaultValue';return '-';}return OpenLayers.Util.formatDistance(value);},scope:this});ret.push({header:GPXEditor1_1.data.GPXPathRecord.LOCALES.FIELD_POSITIVE_DENIVELATION_SHORTNAME,tooltip:GPXEditor1_1.data.GPXPathRecord.LOCALES.FIELD_POSITIVE_DENIVELATION_NAME,align:'right',sortable:true,dataIndex:'positiveDenivelation',renderer:function(value,metaData,record,rowIndex,colIndex,store){var tt=this._getDefaultRowTooltip();if(tt)metaData.attr='ext:qtip="'+tt+'"';if(value===null||value===undefined||value.length==0){metaData.css='gpxe-DefaultValue';return '-';}return OpenLayers.Util.formatElevation(value);},scope:this});ret.push({header:GPXEditor1_1.data.GPXPathRecord.LOCALES.FIELD_NEGATIVE_DENIVELATION_SHORTNAME,tooltip:GPXEditor1_1.data.GPXPathRecord.LOCALES.FIELD_NEGATIVE_DENIVELATION_NAME,align:'right',sortable:true,dataIndex:'negativeDenivelation',renderer:function(value,metaData,record,rowIndex,colIndex,store){var tt=this._getDefaultRowTooltip();if(tt)metaData.attr='ext:qtip="'+tt+'"';if(value===null||value===undefined||value.length==0){metaData.css='gpxe-DefaultValue';return '-';}return OpenLayers.Util.formatElevation(value);},scope:this});ret.push({header:GPXEditor1_1.data.GPXPathRecord.LOCALES.FIELD_MINIMUM_ELEVATION_SHORTNAME,tooltip:GPXEditor1_1.data.GPXPathRecord.LOCALES.FIELD_MINIMUM_ELEVATION_NAME,align:'right',sortable:true,dataIndex:'minimumElevation',hidden:true,renderer:function(value,metaData,record,rowIndex,colIndex,store){var tt=this._getDefaultRowTooltip();if(tt)metaData.attr='ext:qtip="'+tt+'"';if(value===null||value===undefined||value.length==0){metaData.css='gpxe-DefaultValue';return '-';}return OpenLayers.Util.formatElevation(value);},scope:this});ret.push({header:GPXEditor1_1.data.GPXPathRecord.LOCALES.FIELD_AVERAGE_ELEVATION_SHORTNAME,tooltip:GPXEditor1_1.data.GPXPathRecord.LOCALES.FIELD_AVERAGE_ELEVATION_NAME,align:'right',sortable:true,dataIndex:'averageElevation',hidden:true,renderer:function(value,metaData,record,rowIndex,colIndex,store){var tt=this._getDefaultRowTooltip();if(tt)metaData.attr='ext:qtip="'+tt+'"';if(value===null||value===undefined||value.length==0){metaData.css='gpxe-DefaultValue';return '-';}return OpenLayers.Util.formatElevation(value);},scope:this});ret.push({header:GPXEditor1_1.data.GPXPathRecord.LOCALES.FIELD_MAXIMUM_ELEVATION_SHORTNAME,tooltip:GPXEditor1_1.data.GPXPathRecord.LOCALES.FIELD_MAXIMUM_ELEVATION_NAME,align:'right',sortable:true,dataIndex:'maximumElevation',hidden:true,renderer:function(value,metaData,record,rowIndex,colIndex,store){var tt=this._getDefaultRowTooltip();if(tt)metaData.attr='ext:qtip="'+tt+'"';if(value===null||value===undefined||value.length==0){metaData.css='gpxe-DefaultValue';return '-';}return OpenLayers.Util.formatElevation(value);},scope:this});return ret;},_getDefaultRowTooltip:function(){if(this.gpxLayer)return this.LOCALES.DBLCLICK_INFO;else
return GPXEditor1_1.grid.WPTGridPanel.superclass._getDefaultRowTooltip();}});Ext.reg('gpxe-grid-GPXPathGridPanel',GPXEditor1_1.grid.GPXPathGridPanel);GPXEditor1_1.grid.GPXPathGridPanel.LOCALES=Ext.apply({DBLCLICK_INFO:'DBLCLICK_INFO'},GPXEditor1_1.grid.GPXElementGridPanel);
Ext.namespace('GPXEditor1_1.grid');GPXEditor1_1.grid.RTEGridPanel=Ext.extend(GPXEditor1_1.grid.GPXPathGridPanel,{initComponent:function(){Ext.applyIf(this,{LOCALES:GPXEditor1_1.grid.RTEGridPanel.LOCALES});if(!(this.store instanceof GPXEditor1_1.data.RTEStore))this.store=new GPXEditor1_1.data.RTEStore();GPXEditor1_1.grid.RTEGridPanel.superclass.initComponent.call(this);}});Ext.reg('gpxe-grid-RTEGridPanel',GPXEditor1_1.grid.RTEGridPanel);GPXEditor1_1.grid.RTEGridPanel.LOCALES=Ext.apply({DBLCLICK_INFO:'DBLCLICK_INFO'},GPXEditor1_1.grid.GPXPathGridPanel);
Ext.namespace('GPXEditor1_1.grid');GPXEditor1_1.grid.TRKGridPanel=Ext.extend(GPXEditor1_1.grid.GPXPathGridPanel,{initComponent:function(){Ext.applyIf(this,{LOCALES:GPXEditor1_1.grid.TRKGridPanel.LOCALES});if(!(this.store instanceof GPXEditor1_1.data.TRKStore))this.store=new GPXEditor1_1.data.TRKStore();GPXEditor1_1.grid.TRKGridPanel.superclass.initComponent.call(this);},_getColumnsConfig:function(){var ret=GPXEditor1_1.grid.TRKGridPanel.superclass._getColumnsConfig.call(this);ret.push({header:GPXEditor1_1.data.TRKRecord.LOCALES.FIELD_NUMBER_OF_SIGNAL_LOST_SHORTNAME,tooltip:GPXEditor1_1.data.TRKRecord.LOCALES.FIELD_NUMBER_OF_SIGNAL_LOST_NAME,align:'right',sortable:true,dataIndex:'numberOfSignalLost',hidden:true,renderer:function(value,metaData,record,rowIndex,colIndex,store){var tt=this._getDefaultRowTooltip();if(tt)metaData.attr='ext:qtip="'+tt+'"';if(value===null||value===undefined||value.length==0){metaData.css='gpxe-DefaultValue';return '-';}return value;},scope:this});ret.push({header:GPXEditor1_1.data.TRKRecord.LOCALES.FIELD_DURATION_NAME,align:'right',sortable:true,dataIndex:'duration',renderer:function(value,metaData,record,rowIndex,colIndex,store){var tt=this._getDefaultRowTooltip();if(tt)metaData.attr='ext:qtip="'+tt+'"';if(value===null||value===undefined||value.length==0){metaData.css='gpxe-DefaultValue';return '-';}return OpenLayers.Util.formatDuration(value);},scope:this});ret.push({header:GPXEditor1_1.data.TRKRecord.LOCALES.FIELD_MINIMUM_SPEED_DISTANCE_SHORTNAME,tooltip:GPXEditor1_1.data.TRKRecord.LOCALES.FIELD_MINIMUM_SPEED_DISTANCE_NAME,align:'right',sortable:true,dataIndex:'minimumSpeedDistance',hidden:true,renderer:function(value,metaData,record,rowIndex,colIndex,store){var tt=this._getDefaultRowTooltip();if(tt)metaData.attr='ext:qtip="'+tt+'"';if(value===null||value===undefined||value.length==0){metaData.css='gpxe-DefaultValue';return '-';}return value+' m/ms';},scope:this});ret.push({header:GPXEditor1_1.data.TRKRecord.LOCALES.FIELD_AVERAGE_SPEED_DISTANCE_SHORTNAME,tooltip:GPXEditor1_1.data.TRKRecord.LOCALES.FIELD_AVERAGE_SPEED_DISTANCE_NAME,align:'right',sortable:true,dataIndex:'averageSpeedDistance',hidden:true,renderer:function(value,metaData,record,rowIndex,colIndex,store){var tt=this._getDefaultRowTooltip();if(tt)metaData.attr='ext:qtip="'+tt+'"';if(value===null||value===undefined||value.length==0){metaData.css='gpxe-DefaultValue';return '-';}return value+' m/ms';},scope:this});ret.push({header:GPXEditor1_1.data.TRKRecord.LOCALES.FIELD_MAXIMUM_SPEED_DISTANCE_SHORTNAME,tooltip:GPXEditor1_1.data.TRKRecord.LOCALES.FIELD_MAXIMUM_SPEED_DISTANCE_NAME,align:'right',sortable:true,dataIndex:'maximumSpeedDistance',hidden:true,renderer:function(value,metaData,record,rowIndex,colIndex,store){var tt=this._getDefaultRowTooltip();if(tt)metaData.attr='ext:qtip="'+tt+'"';if(value===null||value===undefined||value.length==0){metaData.css='gpxe-DefaultValue';return '-';}return value+' m/ms';},scope:this});ret.push({header:GPXEditor1_1.data.TRKRecord.LOCALES.FIELD_POSITIVE_DENIVELATION_DURATION_SHORTNAME,tooltip:GPXEditor1_1.data.TRKRecord.LOCALES.FIELD_POSITIVE_DENIVELATION_DURATION_NAME,align:'right',sortable:true,dataIndex:'positiveDenivelationDuration',hidden:true,renderer:function(value,metaData,record,rowIndex,colIndex,store){var tt=this._getDefaultRowTooltip();if(tt)metaData.attr='ext:qtip="'+tt+'"';if(value===null||value===undefined||value.length==0){metaData.css='gpxe-DefaultValue';return '-';}return OpenLayers.Util.formatDuration(value);},scope:this});ret.push({header:GPXEditor1_1.data.TRKRecord.LOCALES.FIELD_MINIMUM_SPEED_POSITIVE_DENIVELATION_SHORTNAME,tooltip:GPXEditor1_1.data.TRKRecord.LOCALES.FIELD_MINIMUM_SPEED_POSITIVE_DENIVELATION_NAME,align:'right',sortable:true,dataIndex:'maximumSpeedPositiveDenivelation',hidden:true,renderer:function(value,metaData,record,rowIndex,colIndex,store){var tt=this._getDefaultRowTooltip();if(tt)metaData.attr='ext:qtip="'+tt+'"';if(value===null||value===undefined||value.length==0){metaData.css='gpxe-DefaultValue';return '-';}return value+' m/ms';},scope:this});ret.push({header:GPXEditor1_1.data.TRKRecord.LOCALES.FIELD_AVERAGE_SPEED_POSITIVE_DENIVELATION_SHORTNAME,tooltip:GPXEditor1_1.data.TRKRecord.LOCALES.FIELD_AVERAGE_SPEED_POSITIVE_DENIVELATION_NAME,align:'right',sortable:true,dataIndex:'averageSpeedPositiveDenivelation',hidden:true,renderer:function(value,metaData,record,rowIndex,colIndex,store){var tt=this._getDefaultRowTooltip();if(tt)metaData.attr='ext:qtip="'+tt+'"';if(value===null||value===undefined||value.length==0){metaData.css='gpxe-DefaultValue';return '-';}return value+' m/ms';},scope:this});ret.push({header:GPXEditor1_1.data.TRKRecord.LOCALES.FIELD_MAXIMUM_SPEED_POSITIVE_DENIVELATION_SHORTNAME,tooltip:GPXEditor1_1.data.TRKRecord.LOCALES.FIELD_MAXIMUM_SPEED_POSITIVE_DENIVELATION_NAME,align:'right',sortable:true,dataIndex:'maximumSpeedPositiveDenivelation',hidden:true,renderer:function(value,metaData,record,rowIndex,colIndex,store){var tt=this._getDefaultRowTooltip();if(tt)metaData.attr='ext:qtip="'+tt+'"';if(value===null||value===undefined||value.length==0){metaData.css='gpxe-DefaultValue';return '-';}return value+' m/ms';},scope:this});ret.push({header:GPXEditor1_1.data.TRKRecord.LOCALES.FIELD_NEGATIVE_DENIVELATION_DURATION_SHORTNAME,tooltip:GPXEditor1_1.data.TRKRecord.LOCALES.FIELD_NEGATIVE_DENIVELATION_DURATION_NAME,align:'right',sortable:true,dataIndex:'negativeDenivelationDuration',hidden:true,renderer:function(value,metaData,record,rowIndex,colIndex,store){var tt=this._getDefaultRowTooltip();if(tt)metaData.attr='ext:qtip="'+tt+'"';if(value===null||value===undefined||value.length==0){metaData.css='gpxe-DefaultValue';return '-';}return OpenLayers.Util.formatDuration(value);},scope:this});ret.push({header:GPXEditor1_1.data.TRKRecord.LOCALES.FIELD_MINIMUM_SPEED_NEGATIVE_DENIVELATION_SHORTNAME,tooltip:GPXEditor1_1.data.TRKRecord.LOCALES.FIELD_MINIMUM_SPEED_NEGATIVE_DENIVELATION_NAME,align:'right',sortable:true,dataIndex:'maximumSpeedNegativeDenivelation',hidden:true,renderer:function(value,metaData,record,rowIndex,colIndex,store){var tt=this._getDefaultRowTooltip();if(tt)metaData.attr='ext:qtip="'+tt+'"';if(value===null||value===undefined||value.length==0){metaData.css='gpxe-DefaultValue';return '-';}return value+' m/ms';},scope:this});ret.push({header:GPXEditor1_1.data.TRKRecord.LOCALES.FIELD_AVERAGE_SPEED_NEGATIVE_DENIVELATION_SHORTNAME,tooltip:GPXEditor1_1.data.TRKRecord.LOCALES.FIELD_AVERAGE_SPEED_NEGATIVE_DENIVELATION_NAME,align:'right',sortable:true,dataIndex:'averageSpeedNegativeDenivealtion',hidden:true,renderer:function(value,metaData,record,rowIndex,colIndex,store){var tt=this._getDefaultRowTooltip();if(tt)metaData.attr='ext:qtip="'+tt+'"';if(value===null||value===undefined||value.length==0){metaData.css='gpxe-DefaultValue';return '-';}return value+' m/ms';},scope:this});ret.push({header:GPXEditor1_1.data.TRKRecord.LOCALES.FIELD_MAXIMUM_SPEED_NEGATIVE_DENIVELATION_SHORTNAME,tooltip:GPXEditor1_1.data.TRKRecord.LOCALES.FIELD_MAXIMUM_SPEED_NEGATIVE_DENIVELATION_NAME,align:'right',sortable:true,dataIndex:'maximumSpeedNegativeDenivelation',hidden:true,renderer:function(value,metaData,record,rowIndex,colIndex,store){var tt=this._getDefaultRowTooltip();if(tt)metaData.attr='ext:qtip="'+tt+'"';if(value===null||value===undefined||value.length==0){metaData.css='gpxe-DefaultValue';return '-';}return value+' m/ms';},scope:this});return ret;}});Ext.reg('gpxe-grid-TRKGridPanel',GPXEditor1_1.grid.TRKGridPanel);GPXEditor1_1.grid.TRKGridPanel.LOCALES=Ext.apply({DBLCLICK_INFO:'DBLCLICK_INFO'},GPXEditor1_1.grid.GPXPathGridPanel);
Ext.namespace('GPXEditor1_1.data');GPXEditor1_1.data.GeoNamesStore=Ext.extend(Ext.data.Store,{constructor:function(config){config=config||{};this.LOCALES=GPXEditor1_1.data.GeoNamesStore.LOCALES;Ext.applyIf(config,{proxy:new Ext.data.HttpProxy({url:'./proxy.php',method:'POST'}),baseParams:{_proxy_url:'http://ws.geonames.org/search',lang:GPXEditor1_1.data.GeoNamesStore.LANG,type:'json',featureClass:'P',style:'MEDIUM'},paramNames:{start:'startRow',limit:'maxRows'},reader:new Ext.data.JsonReader({root:'geonames',totalProperty:'totalResultsCount',id:'geonameId'},[{name:'countryName'},{name:'adminCode1'},{name:'fclName'},{name:'countryCode'},{name:'lon',mapping:'lng'},{name:'fcodeName'},{name:'toponymName'},{name:'fcl'},{name:'name'},{name:'fcode'},{name:'geonameId'},{name:'lat'},{name:'adminName1'},{name:'population'}])});GPXEditor1_1.data.GeoNamesStore.superclass.constructor.call(this,config);}});GPXEditor1_1.data.GeoNamesStore.LANG='fr';GPXEditor1_1.data.GeoNamesStore.LOCALES={};
Ext.namespace('GPXEditor1_1.form');GPXEditor1_1.form.CitySearchComboBox=Ext.extend(Ext.form.ComboBox,{initComponent:function(){Ext.applyIf(this,{LOCALES:GPXEditor1_1.form.CitySearchComboBox.LOCALES});Ext.apply(this,{store:new GPXEditor1_1.data.GeoNamesStore(),displayField:'name',typeAhead:false,loadingText:this.LOCALES.SEARCHING,width:100,pageSize:10,hideTrigger:true,tpl:new Ext.XTemplate('<tpl for="."><div class="search-item" ext:qtip="'+this.LOCALES.CLICK_TO_CENTER_MAP_ON_CITY+'">','<h3 class="gpxe-gsnName">{name}</h3>','<span class="gpxe-gsnContryName">{countryName}</span> / <span class="gpxe-gsnAdminName1">{adminName1}</span> <span class="gpxe-gsnPopulation">({population} '+this.LOCALES.INHABITANTS+')</span>','</div></tpl>'),itemSelector:'div.search-item',queryParam:'name_startsWith',listWidth:400,enableKeyEvents:true,listeners:{scope:this,keydown:function(field,e){if(e.getCharCode()==e.BACKSPACE){this.collapse();}else if(e.getCharCode()==e.ENTER){var v=this.getRawValue();if(v.length>0){e.stopPropagation();e.stopEvent();this.setValue(null);this.doQuery(v,true);}}},select:function(cb,record,index){cb.collapse();}}});GPXEditor1_1.form.CitySearchComboBox.superclass.initComponent.call(this);}});Ext.reg('gpxe-CitySearchComboBox',GPXEditor1_1.form.CitySearchComboBox);GPXEditor1_1.form.CitySearchComboBox.LOCALES={LABEL_SEARCH_CITY:'LABEL_SEARCH_CITY',SEARCHING:'SEARCHING',INHABITANTS:'INHABITANTS',CLICK_TO_CENTER_MAP_ON_CITY:'CLICK_TO_CENTER_MAP_ON_CITY',CANT_DISPLAY_CITY_ON_THIS_MAP_BACKGROUND:'CANT_DISPLAY_CITY_ON_THIS_MAP_BACKGROUND',SEARCH_INPUT_HELP:'SEARCH_INPUT_HELP'};
Ext.namespace('GPXEditor1_1');GPXEditor1_1.GetMissedElevationWindow=Ext.extend(Ext.Window,{gpxLayer:undefined,pb:undefined,initComponent:function(){Ext.applyIf(this,{LOCALES:GPXEditor1_1.GetMissedElevationWindow.LOCALES});this.changeModeActions={};if(!this.gpxLayer||!(this.gpxLayer instanceof GPXEditor1_1.GPXLayer))this.gpxLayer=new GPXEditor1_1.GPXLayer();this.pb=new Ext.ProgressBar({});Ext.apply(this,{forceLayout:true,autoHeight:true,resizable:false,closeAction:'hide',border:false,bodyBorder:false,plain:true,layout:'fit',title:this.LOCALES.WINDOW_TITLE,width:300,modal:true,items:[this.pb],buttons:[{text:this.LOCALES.BT_ABORT_TEXT,handler:function(){this.hide();},scope:this}]});GPXEditor1_1.GetMissedElevationWindow.superclass.initComponent.call(this);},show:function(feature,animEle,callback,scope){GPXEditor1_1.GetMissedElevationWindow.superclass.show.call(this,animEle,callback,scope);this.feature=feature;this.wpts=this.feature.geometry.getVertices();this.idx=0;this.pb.updateProgress((this.idx+1)/this.wpts.length,this.LOCALES.PBAR_MSG+' '+(this.idx+1)+'/'+this.wpts.length,false);window.setTimeout(this.doGetElevations.createDelegate(this),200);},doGetElevations:function(){if(!this.wpts||this.idx>=this.wpts.length){if(this.feature&&this.feature.layer){this.feature.layer.events.triggerEvent('featuremodified',{feature:this.feature});this.feature.layer.events.triggerEvent('afterfeaturemodified',{feature:this.feature});}this.hide();return;}if(!this.isVisible()){if(this.feature&&this.feature.layer){this.feature.layer.events.triggerEvent('featuremodified',{feature:this.feature});this.feature.layer.events.triggerEvent('afterfeaturemodified',{feature:this.feature});}return;}if(!this.wpts[this.idx].ele){this.pb.updateProgress((this.idx+1)/this.wpts.length,this.LOCALES.PBAR_MSG+' '+(this.idx+1)+'/'+this.wpts.length,true);var ll=new OpenLayers.LonLat(this.wpts[this.idx].x,this.wpts[this.idx].y);ll=ll.transform(this.gpxLayer.getGPXMap().getDrawProjection(),this.gpxLayer.getGPXMap().getDisplayProjection());var getEle=new OpenLayers.Elevation(ll,function(ele){if(ele!=null){this.wpts[this.idx].ele=ele;if(this.feature&&this.feature.layer){this.feature.layer.events.triggerEvent('vertexmodified',{vertex:this.wpts[this.idx],feature:this.feature});}}this.idx++;this.doGetElevations();},this);}else{this.idx++;this.doGetElevations();}}});Ext.reg('gpxe-GetMissedElevationWindow',GPXEditor1_1.GetMissedElevationWindow);GPXEditor1_1.GetMissedElevationWindow.LOCALES={WINDOW_TITLE:'WINDOW_TITLE',PBAR_MSG:'PBAR_MSG',BT_ABORT_TEXT:'BT_ABORT_TEXT'};
Ext.namespace('GPXEditor1_1');GPXEditor1_1.Util={};GPXEditor1_1.Util.IS_PROVIDERS_INITIALIZED=false;GPXEditor1_1.Util.PROVIDERS=[];GPXEditor1_1.Util.getLayersDefsById=function(id){if(!GPXEditor1_1.Util.IS_PROVIDERS_INITIALIZED)GPXEditor1_1.Util.initProviders();var ret=[];var ids=id?id:'*';if(!Ext.isArray(ids))ids=[ids];for(var i=0;i<ids.length;i++){var idp=ids[i].split('-');if(idp.length==0)idp.push('*');if(idp.length==1)idp.push('*');if(idp.length==2)idp.push('*');ids[i]=idp.join('-');}for(var i=0;i<GPXEditor1_1.Util.PROVIDERS.length;i++){var l=GPXEditor1_1.Util.PROVIDERS[i];var lIdp=l.id.split('-');for(var j=0;j<ids.length;j++){var idp=ids[j].split('-');if((idp[0]=='*'||idp[0]==lIdp[0])&&(idp[1]=='*'||idp[1]==lIdp[1])&&(idp[2]=='*'||idp[2]==lIdp[2])){ret.push(l);}}}return ret;};GPXEditor1_1.Util.initProviders=function(){GPXEditor1_1.Util.PROVIDERS.push({id:'WORLDMAP-OSM-TILEATHOME',provider:GPXEditor1_1.data.MapProvidersStore.LOCALES.PROVIDER_OSM,zone:GPXEditor1_1.data.MapProvidersStore.LOCALES.ZONE_WORLD,type:GPXEditor1_1.data.MapProvidersStore.LAYER_TYPE.MAP,isActive:true,layerConfig:{url:'http://tah.openstreetmap.org/Tiles/tile/${z}/${x}/${y}.png',options:Ext.apply({},GPXEditor1_1.Util.L_WORLDMAP_OSM_CONFIG)}});if(window.GScript!=null){GPXEditor1_1.Util.PROVIDERS.push({id:'WORLDMAP-GOOGLE-PHYSICAL',provider:GPXEditor1_1.data.MapProvidersStore.LOCALES.PROVIDER_GOOGLE,zone:GPXEditor1_1.data.MapProvidersStore.LOCALES.ZONE_WORLD,type:GPXEditor1_1.data.MapProvidersStore.LAYER_TYPE.TOPO,isActive:true,layerConfig:{options:Ext.apply({type:'G_PHYSICAL_MAP'},GPXEditor1_1.Util.L_WORLDMAP_GOOGLE_CONFIG)}},{id:'WORLDMAP-GOOGLE-MAP',provider:GPXEditor1_1.data.MapProvidersStore.LOCALES.PROVIDER_GOOGLE,zone:GPXEditor1_1.data.MapProvidersStore.LOCALES.ZONE_WORLD,type:GPXEditor1_1.data.MapProvidersStore.LAYER_TYPE.MAP,isActive:false,layerConfig:{options:Ext.apply({},GPXEditor1_1.Util.L_WORLDMAP_GOOGLE_CONFIG)}},{id:'WORLDMAP-GOOGLE-SAT',provider:GPXEditor1_1.data.MapProvidersStore.LOCALES.PROVIDER_GOOGLE,zone:GPXEditor1_1.data.MapProvidersStore.LOCALES.ZONE_WORLD,type:GPXEditor1_1.data.MapProvidersStore.LAYER_TYPE.SAT,isActive:true,layerConfig:{options:Ext.apply({type:'G_SATELLITE_MAP'},GPXEditor1_1.Util.L_WORLDMAP_GOOGLE_CONFIG)}});}if(window.gGEOPORTALRIGHTSMANAGEMENT!=null){GPXEditor1_1.Util.PROVIDERS.push({id:'IGNF-FXX-TOPO',provider:GPXEditor1_1.data.MapProvidersStore.LOCALES.PROVIDER_IGN,zone:GPXEditor1_1.data.MapProvidersStore.LOCALES.ZONE_IGNF_FXX,type:GPXEditor1_1.data.MapProvidersStore.LAYER_TYPE.TOPO,isActive:true,layerConfig:{territory:'FXX',layerId:'GEOGRAPHICALGRIDSYSTEMS.MAPS',maxZoomLevel:15}},{id:'IGNF-FXX-SAT',provider:GPXEditor1_1.data.MapProvidersStore.LOCALES.PROVIDER_IGN,zone:GPXEditor1_1.data.MapProvidersStore.LOCALES.ZONE_IGNF_FXX,type:GPXEditor1_1.data.MapProvidersStore.LAYER_TYPE.SAT,isActive:true,layerConfig:{territory:'FXX',layerId:'ORTHOIMAGERY.ORTHOPHOTOS'}},{id:'IGNF-ATF-TOPO',provider:GPXEditor1_1.data.MapProvidersStore.LOCALES.PROVIDER_IGN,zone:GPXEditor1_1.data.MapProvidersStore.LOCALES.ZONE_IGNF_ATF,type:GPXEditor1_1.data.MapProvidersStore.LAYER_TYPE.TOPO,isActive:false,layerConfig:{territory:'ATF',layerId:'GEOGRAPHICALGRIDSYSTEMS.MAPS'}},{id:'IGNF-GLP-TOPO',provider:GPXEditor1_1.data.MapProvidersStore.LOCALES.PROVIDER_IGN,zone:GPXEditor1_1.data.MapProvidersStore.LOCALES.ZONE_IGNF_GLP,type:GPXEditor1_1.data.MapProvidersStore.LAYER_TYPE.TOPO,isActive:false,layerConfig:{territory:'GLP',layerId:'GEOGRAPHICALGRIDSYSTEMS.MAPS',maxZoomLevel:15}},{id:'IGNF-GLP-SAT',provider:GPXEditor1_1.data.MapProvidersStore.LOCALES.PROVIDER_IGN,zone:GPXEditor1_1.data.MapProvidersStore.LOCALES.ZONE_IGNF_GLP,type:GPXEditor1_1.data.MapProvidersStore.LAYER_TYPE.SAT,isActive:false,layerConfig:{territory:'GLP',layerId:'ORTHOIMAGERY.ORTHOPHOTOS'}},{id:'IGNF-MTQ-TOPO',provider:GPXEditor1_1.data.MapProvidersStore.LOCALES.PROVIDER_IGN,zone:GPXEditor1_1.data.MapProvidersStore.LOCALES.ZONE_IGNF_MTQ,type:GPXEditor1_1.data.MapProvidersStore.LAYER_TYPE.TOPO,isActive:false,layerConfig:{territory:'MTQ',layerId:'GEOGRAPHICALGRIDSYSTEMS.MAPS',maxZoomLevel:15}},{id:'IGNF-MTQ-SAT',provider:GPXEditor1_1.data.MapProvidersStore.LOCALES.PROVIDER_IGN,zone:GPXEditor1_1.data.MapProvidersStore.LOCALES.ZONE_IGNF_MTQ,type:GPXEditor1_1.data.MapProvidersStore.LAYER_TYPE.SAT,isActive:false,layerConfig:{territory:'MTQ',layerId:'ORTHOIMAGERY.ORTHOPHOTOS'}},{id:'IGNF-GUF-TOPO',provider:GPXEditor1_1.data.MapProvidersStore.LOCALES.PROVIDER_IGN,zone:GPXEditor1_1.data.MapProvidersStore.LOCALES.ZONE_IGNF_GUF,type:GPXEditor1_1.data.MapProvidersStore.LAYER_TYPE.TOPO,isActive:false,layerConfig:{territory:'GUF',layerId:'GEOGRAPHICALGRIDSYSTEMS.MAPS',maxZoomLevel:15}},{id:'IGNF-GUF-SAT',provider:GPXEditor1_1.data.MapProvidersStore.LOCALES.PROVIDER_IGN,zone:GPXEditor1_1.data.MapProvidersStore.LOCALES.ZONE_IGNF_GUF,type:GPXEditor1_1.data.MapProvidersStore.LAYER_TYPE.SAT,isActive:false,layerConfig:{territory:'GUF',layerId:'ORTHOIMAGERY.ORTHOPHOTOS'}},{id:'IGNF-REU-TOPO',provider:GPXEditor1_1.data.MapProvidersStore.LOCALES.PROVIDER_IGN,zone:GPXEditor1_1.data.MapProvidersStore.LOCALES.ZONE_IGNF_REU,type:GPXEditor1_1.data.MapProvidersStore.LAYER_TYPE.TOPO,isActive:false,layerConfig:{territory:'REU',layerId:'GEOGRAPHICALGRIDSYSTEMS.MAPS',maxZoomLevel:15}},{id:'IGNF-REU-SAT',provider:GPXEditor1_1.data.MapProvidersStore.LOCALES.PROVIDER_IGN,zone:GPXEditor1_1.data.MapProvidersStore.LOCALES.ZONE_IGNF_REU,type:GPXEditor1_1.data.MapProvidersStore.LAYER_TYPE.SAT,isActive:false,layerConfig:{territory:'REU',layerId:'ORTHOIMAGERY.ORTHOPHOTOS'}},{id:'IGNF-MYT-TOPO',provider:GPXEditor1_1.data.MapProvidersStore.LOCALES.PROVIDER_IGN,zone:GPXEditor1_1.data.MapProvidersStore.LOCALES.ZONE_IGNF_MYT,type:GPXEditor1_1.data.MapProvidersStore.LAYER_TYPE.TOPO,isActive:false,layerConfig:{territory:'MYT',layerId:'GEOGRAPHICALGRIDSYSTEMS.MAPS',maxZoomLevel:15}},{id:'IGNF-MYT-SAT',provider:GPXEditor1_1.data.MapProvidersStore.LOCALES.PROVIDER_IGN,zone:GPXEditor1_1.data.MapProvidersStore.LOCALES.ZONE_IGNF_MYT,type:GPXEditor1_1.data.MapProvidersStore.LAYER_TYPE.SAT,isActive:false,layerConfig:{territory:'MYT',layerId:'ORTHOIMAGERY.ORTHOPHOTOS'}},{id:'IGNF-SPM-TOPO',provider:GPXEditor1_1.data.MapProvidersStore.LOCALES.PROVIDER_IGN,zone:GPXEditor1_1.data.MapProvidersStore.LOCALES.ZONE_IGNF_SPM,type:GPXEditor1_1.data.MapProvidersStore.LAYER_TYPE.TOPO,isActive:false,layerConfig:{territory:'SPM',layerId:'GEOGRAPHICALGRIDSYSTEMS.MAPS',maxZoomLevel:15}},{id:'IGNF-SPM-SAT',provider:GPXEditor1_1.data.MapProvidersStore.LOCALES.PROVIDER_IGN,zone:GPXEditor1_1.data.MapProvidersStore.LOCALES.ZONE_IGNF_SPM,type:GPXEditor1_1.data.MapProvidersStore.LAYER_TYPE.SAT,isActive:false,layerConfig:{territory:'SPM',layerId:'ORTHOIMAGERY.ORTHOPHOTOS'}},{id:'IGNF-CRZ-TOPO',provider:GPXEditor1_1.data.MapProvidersStore.LOCALES.PROVIDER_IGN,zone:GPXEditor1_1.data.MapProvidersStore.LOCALES.ZONE_IGNF_CRZ,type:GPXEditor1_1.data.MapProvidersStore.LAYER_TYPE.TOPO,isActive:false,layerConfig:{territory:'CRZ',layerId:'GEOGRAPHICALGRIDSYSTEMS.MAPS'}},{id:'IGNF-KER-TOPO',provider:GPXEditor1_1.data.MapProvidersStore.LOCALES.PROVIDER_IGN,zone:GPXEditor1_1.data.MapProvidersStore.LOCALES.ZONE_IGNF_KER,type:GPXEditor1_1.data.MapProvidersStore.LAYER_TYPE.TOPO,isActive:false,layerConfig:{territory:'KER',layerId:'GEOGRAPHICALGRIDSYSTEMS.MAPS'}},{id:'IGNF-NCL-TOPO',provider:GPXEditor1_1.data.MapProvidersStore.LOCALES.PROVIDER_IGN,zone:GPXEditor1_1.data.MapProvidersStore.LOCALES.ZONE_IGNF_NCL,type:GPXEditor1_1.data.MapProvidersStore.LAYER_TYPE.TOPO,isActive:false,layerConfig:{territory:'NCL',layerId:'GEOGRAPHICALGRIDSYSTEMS.MAPS'}},{id:'IGNF-NCL-SAT',provider:GPXEditor1_1.data.MapProvidersStore.LOCALES.PROVIDER_IGN,zone:GPXEditor1_1.data.MapProvidersStore.LOCALES.ZONE_IGNF_NCL,type:GPXEditor1_1.data.MapProvidersStore.LAYER_TYPE.SAT,isActive:false,layerConfig:{territory:'NCL',layerId:'ORTHOIMAGERY.ORTHOPHOTOS'}},{id:'IGNF-PYF-TOPO',provider:GPXEditor1_1.data.MapProvidersStore.LOCALES.PROVIDER_IGN,zone:GPXEditor1_1.data.MapProvidersStore.LOCALES.ZONE_IGNF_PYF,type:GPXEditor1_1.data.MapProvidersStore.LAYER_TYPE.TOPO,isActive:false,layerConfig:{territory:'PYF',layerId:'GEOGRAPHICALGRIDSYSTEMS.MAPS',maxExtent:new OpenLayers.Bounds(-151.8608464126424,-16.21081454795193,-149.09434367584083,-17.95857676473487)}},{id:'IGNF-PYF-SAT',provider:GPXEditor1_1.data.MapProvidersStore.LOCALES.PROVIDER_IGN,zone:GPXEditor1_1.data.MapProvidersStore.LOCALES.ZONE_IGNF_PYF,type:GPXEditor1_1.data.MapProvidersStore.LAYER_TYPE.SAT,isActive:false,layerConfig:{territory:'PYF',layerId:'ORTHOIMAGERY.ORTHOPHOTOS',maxExtent:new OpenLayers.Bounds(-151.8608464126424,-16.21081454795193,-149.09434367584083,-17.95857676473487)}},{id:'IGNF-SBA-TOPO',provider:GPXEditor1_1.data.MapProvidersStore.LOCALES.PROVIDER_IGN,zone:GPXEditor1_1.data.MapProvidersStore.LOCALES.ZONE_IGNF_SBA,type:GPXEditor1_1.data.MapProvidersStore.LAYER_TYPE.TOPO,isActive:false,layerConfig:{territory:'SBA',layerId:'GEOGRAPHICALGRIDSYSTEMS.MAPS',maxZoomLevel:15}},{id:'IGNF-SBA-SAT',provider:GPXEditor1_1.data.MapProvidersStore.LOCALES.PROVIDER_IGN,zone:GPXEditor1_1.data.MapProvidersStore.LOCALES.ZONE_IGNF_SBA,type:GPXEditor1_1.data.MapProvidersStore.LAYER_TYPE.SAT,isActive:false,layerConfig:{territory:'SBA',layerId:'ORTHOIMAGERY.ORTHOPHOTOS'}},{id:'IGNF-WLF-TOPO',provider:GPXEditor1_1.data.MapProvidersStore.LOCALES.PROVIDER_IGN,zone:GPXEditor1_1.data.MapProvidersStore.LOCALES.ZONE_IGNF_WLF,type:GPXEditor1_1.data.MapProvidersStore.LAYER_TYPE.TOPO,isActive:false,layerConfig:{territory:'WLF',layerId:'GEOGRAPHICALGRIDSYSTEMS.MAPS'}},{id:'IGNF-WLF-SAT',provider:GPXEditor1_1.data.MapProvidersStore.LOCALES.PROVIDER_IGN,zone:GPXEditor1_1.data.MapProvidersStore.LOCALES.ZONE_IGNF_WLF,type:GPXEditor1_1.data.MapProvidersStore.LAYER_TYPE.SAT,isActive:false,layerConfig:{territory:'WLF',layerId:'ORTHOIMAGERY.ORTHOPHOTOS'}})}GPXEditor1_1.Util.IS_PROVIDERS_INITIALIZED=true;};GPXEditor1_1.Util.L_ALL_CONFIG={isBaseLayer:true};GPXEditor1_1.Util.L_WORLDMAP_CONFIG=Ext.applyIf({projection:new OpenLayers.Projection('EPSG:900913'),sphericalMercator:true,maxExtent:new OpenLayers.Bounds(-20037508,-20037508,20037508,20037508)},GPXEditor1_1.Util.L_ALL_CONFIG);GPXEditor1_1.Util.L_WORLDMAP_OSM_CONFIG=Ext.apply({numZoomLevels:18,maxResolution:156543.0339},GPXEditor1_1.Util.L_WORLDMAP_CONFIG);GPXEditor1_1.Util.L_WORLDMAP_GOOGLE_CONFIG=Ext.apply({},GPXEditor1_1.Util.L_WORLDMAP_CONFIG);
Ext.namespace('GPXEditor1_1.data');GPXEditor1_1.data.MapProvidersStore=Ext.extend(Ext.data.GroupingStore,{map:null,constructor:function(config){this.LOCALES=GPXEditor1_1.data.MapProvidersStore.LOCALES;config=config||{};this.map=config.map;Ext.apply(config,{reader:new Ext.data.JsonReader({root:'providers',fields:[{name:'id',type:'string',id:'id'},{name:'orderNum',type:'int'},{name:'provider',type:'string'},{name:'zone',type:'string'},{name:'type',type:'int'},{name:'isActive',type:'bool'},{name:'layer',type:'object'},{name:'layerConfig',type:'object'}]}),sortInfo:{field:'zone',direction:"ASC"},groupField:'provider'});GPXEditor1_1.data.MapProvidersStore.superclass.constructor.call(this,config);this.on('load',function(store,records,options){for(var i=0;i<records.length;i++){var r=records[i];var l=this._getLayerFromRecord(r);r.data.layer=l;this.map.addLayer(l);}},this);this.loadByLayerId(config.layersId);},getMap:function(){return this.map;},loadByLayerId:function(id){var layers=GPXEditor1_1.Util.getLayersDefsById(id);var newLayers=[];for(var i=0;i<layers.length;i++){var l=layers[i];if(!this.getById(l.id)){l.orderNum=GPXEditor1_1.Util.PROVIDERS.indexOf(l);newLayers.push(l);}}if(newLayers.length>0)this.loadData({providers:newLayers});},_getLayerFromRecord:function(r){if(!r)return;if(r.data.layer)return r.data.layer;var lc=r.data.layerConfig;var map=this.map;var ids=r.data.id.split('-');var pid=ids[0]=='WORLDMAP'?ids[1]:ids[0];if(!lc)return null;var name=r.data.provider+' '+r.data.zone+' ';if(r.data.type==GPXEditor1_1.data.MapProvidersStore.LAYER_TYPE.MAP)name+=this.LOCALES.LAYER_TYPE_MAP;else if(r.data.type==GPXEditor1_1.data.MapProvidersStore.LAYER_TYPE.SAT)name+=this.LOCALES.LAYER_TYPE_SAT;else if(r.data.type==GPXEditor1_1.data.MapProvidersStore.LAYER_TYPE.TOPO)name+=this.LOCALES.LAYER_TYPE_TOPO
var layer=null;switch(pid){case 'OSM':layer=new OpenLayers.Layer.OSM(name,lc.url,lc.options);break;case 'GOOGLE':if(window.GScript!=null){switch(lc.options.type){case 'G_PHYSICAL_MAP':lc.options.type=G_PHYSICAL_MAP;break;case 'G_SATELLITE_MAP':lc.options.type=G_SATELLITE_MAP;break;}layer=new OpenLayers.Layer.Google(name,lc.options);}break;case 'IGNF':var cat=map?map.getIGNFCatalogue():null;if(window.gGEOPORTALRIGHTSMANAGEMENT&&map&&cat){var t=cat.getTerritory(lc.territory);if(!t)return null;var lp=cat.getLayerParameters(t,lc.layerId);if(!lp)return null;lp.options.isBaseLayer=true;lp.options.opacity=1.0;lp.options.alwaysInRange=true;if('originators' in lp.options){for(var i=0;i<lp.options.originators.length;i++){var o=lp.options.originators[i];if(o.minZoomLevel)o.minZoomLevel-=5;if(o.maxZoomLevel)o.maxZoomLevel-=5;}}if(lc.maxZoomLevel)lp.options.maxZoomLevel=lc.maxZoomLevel;lp.options.resolutions=Geoportal.Catalogue.RESOLUTIONS.slice(lp.options.minZoomLevel,lp.options.maxZoomLevel+(ids[2]=='TOPO'?1:0));lp.options['GeoRM']=Geoportal.GeoRMHandler.addKey(gGEOPORTALRIGHTSMANAGEMENT.apiKey,gGEOPORTALRIGHTSMANAGEMENT[gGEOPORTALRIGHTSMANAGEMENT.apiKey].tokenServer.url,gGEOPORTALRIGHTSMANAGEMENT[gGEOPORTALRIGHTSMANAGEMENT.apiKey].tokenServer.ttl,map);if(lc.maxExtent)lp.options.maxExtent=lc.maxExtent.transform(new OpenLayers.Projection('EPSG:4326'),lp.options.projection);lp.options.onLoadError=function(src){if(src.match(/^http:\/\/[a-z0-9-]+\.ign\.fr\//)){if(src.match(/TRANSPARENT=true/i))return Geoportal.Util.getImagesLocation()+'nodata.gif';else
return Geoportal.Util.getImagesLocation()+'nodata.jpg';}};layer=new lp.classLayer(name,lp.url,lp.params,lp.options);}break;}layer.record=r;return layer;}});GPXEditor1_1.data.MapProvidersStore.LOCALES={PROVIDER_OSM:'PROVIDER_OSM',PROVIDER_GOOGLE:'PROVIDER_GOOGLE',PROVIDER_IGN:'PROVIDER_IGN',ZONE_WORLD:'ZONE_WORLD',ZONE_IGNF_FXX:'ZONE_IGNF_FXX',ZONE_IGNF_GLP:'ZONE_IGNF_GLP',ZONE_IGNF_MTQ:'ZONE_IGNF_MTQ',ZONE_IGNF_GUF:'ZONE_IGNF_GUF',ZONE_IGNF_REU:'ZONE_IGNF_REU',ZONE_IGNF_MYT:'ZONE_IGNF_MYT',ZONE_IGNF_SPM:'ZONE_IGNF_SPM',ZONE_IGNF_CRZ:'ZONE_IGNF_CRZ',ZONE_IGNF_KER:'ZONE_IGNF_KER',ZONE_IGNF_NCL:'ZONE_IGNF_NCL',ZONE_IGNF_PYF:'ZONE_IGNF_PYF',ZONE_IGNF_SBA:'ZONE_IGNF_SBA',ZONE_IGNF_SMA:'ZONE_IGNF_SMA',ZONE_IGNF_WLF:'ZONE_IGNF_WLF',LAYER_TYPE_MAP:'LAYER_TYPE_MAP',LAYER_TYPE_SAT:'LAYER_TYPE_SAT',LAYER_TYPE_TOPO:'LAYER_TYPE_TOPO'};GPXEditor1_1.data.MapProvidersStore.LAYER_TYPE={TOPO:1,MAP:2,SAT:3};
Ext.namespace('GPXEditor1_1.menu');GPXEditor1_1.menu.LayersMenu=Ext.extend(Ext.menu.Menu,{mapProvidersStore:undefined,mapProvidersGrid:undefined,itemsLayers:undefined,actionMenu:undefined,initComponent:function(){Ext.applyIf(this,{LOCALES:GPXEditor1_1.menu.LayersMenu.LOCALES});this.itemsLayers=[];if(!this.mapProvidersStore||!(this.mapProvidersStore instanceof GPXEditor1_1.data.MapProvidersStore))this.mapProvidersStore=new GPXEditor1_1.data.MapProvidersStore();GPXEditor1_1.menu.LayersMenu.superclass.initComponent.call(this);this.actionMenu=new Ext.Action({iconCls:'gpxe-Layers',text:this.LOCALES.ACTIONMENU_TEXT,tooltip:this.LOCALES.ACTIONMENU_TOOTIP,menu:this});this.mapProvidersGrid=new GPXEditor1_1.grid.MapProvidersGrid({store:this.mapProvidersStore,region:'center'});this.winProviders=new Ext.Window({layout:'border',iconCls:'gpxe-Config',title:this.LOCALES.MAP_CONFIG_TITLE,width:400,height:300,closeAction:'hide',plain:true,items:[this.mapProvidersGrid],buttons:[{text:this.LOCALES.MAP_CONFIG_CLOSE,handler:function(){this.winProviders.hide();},scope:this}]});this.mapProvidersStore.on('update',this.updateLayersItems,this);this.mapProvidersStore.map.events.register('changebaselayer',this,function(){this.updateLayersItems();});this._initItems();},getMapProvidersStore:function(){return this.mapProvidersStore;},getMapProvidersGrid:function(){return this.mapProvidersGrid;},updateLayersItems:function(layers){for(var i=0;i<this.itemsLayers.length;i++){var il=this.itemsLayers[i];var r=il.layerRecord;r.get('isActive')?il.show():il.hide();if(r.get('layer')==this.mapProvidersStore.map.baseLayer)il.disable();else
il.enable();}},_initItems:function(){this.add({text:this.LOCALES.OPEN_MAP_CONFIG,iconCls:'gpxe-Config',handler:function(){this.winProviders.show(this);},scope:this});this.add('-');var layers=new Ext.util.MixedCollection();this.mapProvidersStore.each(function(r){layers.add(r.get('id'),r);});layers.sort('DESC',function(r1,r2){return r1.data.orderNum-r2.data.orderNum;},this);layers.each(function(r,idx,length){var l=r.data.layer;var iconCls='gpxe-LayerMap';var type=GPXEditor1_1.data.MapProvidersStore.LOCALES.LAYER_TYPE_MAP;if(r.data.type==GPXEditor1_1.data.MapProvidersStore.LAYER_TYPE.SAT){iconCls='gpxe-LayerSat';type=GPXEditor1_1.data.MapProvidersStore.LOCALES.LAYER_TYPE_SAT;}else if(r.data.type==GPXEditor1_1.data.MapProvidersStore.LAYER_TYPE.TOPO){iconCls='gpxe-LayerTopo';type=GPXEditor1_1.data.MapProvidersStore.LOCALES.LAYER_TYPE_TOPO;}var p={toggleGroup:'mapLayer',allowDepress:false,pressed:false,checked:false,text:'<span class="gpxe-lm-provider">'+r.data.provider+'</span> - <span class="gpxe-lm-zone">'+r.data.zone+'</span> - <span class="gpxe-lm-type">('+type+')',width:'100%',iconAlign:'left',iconCls:'gpxe-LayerMap',scope:this,handler:this.changeLayer,layerRecord:r,iconCls:iconCls};if(this.mapProvidersStore.map.baseLayer===l){p.checked=true;p.pressed=true;}p=new Ext.menu.Item(p);this.add(p);this.itemsLayers.push(p);},this);this.updateLayersItems();},getActionMenu:function(){return this.actionMenu;},changeLayer:function(item,event){this.mapProvidersStore.map.setBaseLayer(item.layerRecord.data.layer);}});GPXEditor1_1.menu.LayersMenu.LOCALES={MAP_CONFIG_CLOSE:'MAP_CONFIG_CLOSE',MAP_CONFIG_TITLE:'MAP_CONFIG_TITLE',OPEN_MAP_CONFIG:'OPEN_MAP_CONFIG',ACTIONMENU_TOOTIP:'ACTIONMENU_TOOTIP',ACTIONMENU_TEXT:'ACTIONMENU_TEXT'};
Ext.namespace('GPXEditor1_1.grid');GPXEditor1_1.grid.MapProvidersGrid=Ext.extend(Ext.grid.GridPanel,{initComponent:function(){Ext.applyIf(this,{LOCALES:GPXEditor1_1.grid.MapProvidersGrid.LOCALES});var checkColumn=GPXEditor1_1.grid.MapProvidersGrid.getDefaultCheckColumn();if(!this.store||!(this.store instanceof GPXEditor1_1.data.MapProvidersStore))this.store=new GPXEditor1_1.data.MapProvidersStore({map:this.map});Ext.apply(this,{cm:GPXEditor1_1.grid.MapProvidersGrid.getDefaultColumnModel(checkColumn),autoExpandColumn:'zone',clicksToEdit:1,view:new Ext.grid.GroupingView({forceFit:true,groupTextTpl:'{text} ({[values.rs.length]} {[values.rs.length > 1 ? "Items" : "Item"]})'}),sm:new GPXEditor1_1.grid.MapProvidersGridSelectionModel({singleSelect:true}),plugins:checkColumn});GPXEditor1_1.grid.MapProvidersGrid.superclass.initComponent.call(this);this.store.on('update',this.updateLayer,this);this.selModel.on('selectionchange',function(sm){var r=sm.getSelected();if(!r)return;r.set('isActive',true);this.map.setBaseLayer(r.data.layer);},this);this.setMap(this.store.map);},setMap:function(map){if(this.map){}this.map=map;this.map.events.register('changebaselayer',this,function(evt){var r=this.selModel.getSelected();if(!r||r!=evt.layer.record){r=evt.layer.record;var rIndex=this.store.indexOf(r);if(this.selModel.grid&&rIndex!=-1)this.selModel.selectRow(rIndex);}});},updateLayer:function(store,record,operation){if(operation=='commit')return;if(this.map){if(record.data.layer){if(this.map.baseLayer==record.data.layer&&!record.data.isActive){record.beginEdit();record.data.isActive=true;record.endEdit();alert('PAS POSSIBLE DE DESACTIVER LA LAYER COURANTE'+"\n"+'need i18n');}}this.store.commitChanges();}}});Ext.reg('gpxe_MapProvidersGrid',GPXEditor1_1.grid.MapProvidersGrid);GPXEditor1_1.grid.MapProvidersGrid.getDefaultCheckColumn=function(){return new Ext.grid.CheckColumn({width:50,header:this.LOCALES.COLUMN_ISACTIVE_TITLE,dataIndex:'isActive',renderer:function(val,p,record){p.css+=' x-grid3-check-col-td';return String.format('<div class="x-grid3-check-col{0} {1}" ext:qtip="'+GPXEditor1_1.grid.MapProvidersGrid.LOCALES.CLICK_TO_ADD_MAP_ON_MAPPANEL+'">&#160;</div>',val?'-on':'',this.createId());}});};GPXEditor1_1.grid.MapProvidersGrid.getDefaultColumnModel=function(checkColumn){if(!checkColumn)checkColumn=GPXEditor1_1.grid.MapProvidersGrid.getDefaultCheckColumn();return new Ext.grid.ColumnModel({defaults:{sortable:true},columns:[{header:this.LOCALES.COLUMN_PROVIDER_TITLE,dataIndex:'provider',renderer:function(val,p){p.attr='ext:qtip="'+GPXEditor1_1.grid.MapProvidersGrid.LOCALES.DBCLICK_TO_ACTIVE_AND_SELECT_THIS_MAP+'"';return val;}},{header:this.LOCALES.COLUMN_ZONE_TITLE,dataIndex:'zone',renderer:function(val,p){p.attr='ext:qtip="'+GPXEditor1_1.grid.MapProvidersGrid.LOCALES.DBCLICK_TO_ACTIVE_AND_SELECT_THIS_MAP+'"';return val;}},{header:this.LOCALES.COLUMN_TYPE_TITLE,dataIndex:'type',renderer:function(val,p){p.attr='ext:qtip="'+GPXEditor1_1.grid.MapProvidersGrid.LOCALES.DBCLICK_TO_ACTIVE_AND_SELECT_THIS_MAP+'"';switch(val){case GPXEditor1_1.data.MapProvidersStore.LAYER_TYPE.MAP:return GPXEditor1_1.data.MapProvidersStore.LOCALES.LAYER_TYPE_MAP;case GPXEditor1_1.data.MapProvidersStore.LAYER_TYPE.SAT:return GPXEditor1_1.data.MapProvidersStore.LOCALES.LAYER_TYPE_SAT;case GPXEditor1_1.data.MapProvidersStore.LAYER_TYPE.TOPO:return GPXEditor1_1.data.MapProvidersStore.LOCALES.LAYER_TYPE_TOPO;}return val;}},checkColumn]});};GPXEditor1_1.grid.MapProvidersGrid.LOCALES={COLUMN_PROVIDER_TITLE:'COLUMN_PROVIDER_TITLE',COLUMN_ZONE_TITLE:'COLUMN_ZONE_TITLE',COLUMN_TYPE_TITLE:'COLUMN_TYPE_TITLE',COLUMN_ISACTIVE_TITLE:'COLUMN_ISACTIVE_TITLE',CLICK_TO_ADD_MAP_ON_MAPPANEL:'CLICK_TO_ADD_MAP_ON_MAPPANEL',DBCLICK_TO_ACTIVE_AND_SELECT_THIS_MAP:'DBCLICK_TO_ACTIVE_AND_SELECT_THIS_MAP'};GPXEditor1_1.grid.MapProvidersGridSelectionModel=Ext.extend(Ext.grid.RowSelectionModel,{initEvents:function(){GPXEditor1_1.grid.MapProvidersGridSelectionModel.superclass.initEvents.call(this);if(!this.grid.enableDragDrop&&!this.grid.enableDrag){this.grid.un('rowmousedown',this.handleMouseDown,this);this.grid.on('rowdblclick',this.handleMouseDown,this);}}});
